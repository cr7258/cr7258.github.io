import{_ as p}from"./chunks/ArticleMetadata.B38I6HZO.js";import{_ as e,C as r,c as d,o as h,k as l,G as g,P as A,a as y,w as o,b as D,e as F}from"./chunks/framework.DIkCQIk8.js";import"./chunks/md5.BFEskVOY.js";const f=JSON.parse('{"title":"使用 SeekDB + PowerMem 构建多模态智能记忆系统 MemBox","description":"","frontmatter":{"title":"使用 SeekDB + PowerMem 构建多模态智能记忆系统 MemBox","author":"Se7en","date":"2026/01/20 20:30","categories":["AI"],"tags":["OceanBase","SeekDB","PowerMem","AI","RAG","Memory"]},"headers":[],"relativePath":"blogs/original/2026/01-oceanbase.md","filePath":"blogs/original/2026/01-oceanbase.md","lastUpdated":1768916302000}'),C={name:"blogs/original/2026/01-oceanbase.md"};function c(i,s,B,u,E,m){const k=p,t=r("ClientOnly");return h(),d("div",null,[s[0]||(s[0]=l("h1",{id:"使用-seekdb-powermem-构建多模态智能记忆系统-membox",tabindex:"-1"},[y("使用 seekdb + PowerMem 构建多模态智能记忆系统 MemBox "),l("a",{class:"header-anchor",href:"#使用-seekdb-powermem-构建多模态智能记忆系统-membox","aria-label":'Permalink to "使用 seekdb + PowerMem 构建多模态智能记忆系统 MemBox"'},"​")],-1)),g(t,null,{default:o(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),D(k,{key:0,article:i.$frontmatter},null,8,["article"])):F("",!0)]}),_:1}),s[1]||(s[1]=A(`<p>在与 AI 应用交互时，你有没有经历过这样的场景：每次新会话都要重新介绍自己是谁、在做什么项目，刚才聊过的偏好转眼就被忘得一干二净？这是因为大多数大语言模型本质上是<strong>无状态</strong>的——每一次对话都是从零开始，上下文窗口有限且无法持久化。</p><p>如果能让 AI &quot;记住&quot;用户——不仅记住当前对话，还能记住历史交互、个人偏好和用户画像——它就能成为真正有&quot;成长性&quot;的智能助手。本文将介绍如何使用 OceanBase 推出的 <strong>SeekDB</strong>（AI 原生混合搜索数据库）和 <strong>PowerMem</strong>（智能记忆管理库）构建一个多模态智能记忆系统 MemBox，实现用户记忆持久化、语义检索和个性化回复，让 AI 拥有跨会话的&quot;长期记忆&quot;。</p><h2 id="_1-seekdb-介绍" tabindex="-1">1. SeekDB 介绍 <a class="header-anchor" href="#_1-seekdb-介绍" aria-label="Permalink to &quot;1. SeekDB 介绍&quot;">​</a></h2><p><a href="https://github.com/oceanbase/seekdb" target="_blank" rel="noreferrer">seekdb</a> 是 OceanBase 推出的 AI 原生混合搜索数据库，在一个数据库中融合向量、文本、结构化与半结构化数据能力，并通过内置 AI Functions 支持多模混合搜索与智能推理。</p><p>SeekDB 的核心特性：</p><ul><li><strong>灵活部署</strong>：支持嵌入式和服务器两种部署模式。嵌入式模式下可将 seekdb 直接集成进 Python 应用，便于进行个人开发。</li><li><strong>混合搜索</strong>：向量、全文与标量过滤在一次查询中完成，支持粗排 + 精排的多阶段搜索链路。</li><li><strong>多模数据与索引</strong>：支持向量、文本、JSON、GIS 等多模数据，提供 HNSW/IVF 向量索引、BM25 全文索引等。</li><li><strong>AI 内置</strong>：在数据库内完成向量嵌入、推理、提示词管理与重排，支持 document-in/data-out 的完整 RAG 流程。</li><li><strong>SQL 原生</strong>：源于成熟的 OceanBase 引擎，支持实时写入、实时可查，ACID 事务保证，兼容 MySQL 生态。</li><li><strong>统一应用接口</strong>：适配 LangChain、LlamaIndex、Dify 等近 30 种 AI 框架，提供 MCP Server。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20260120212909282.png" alt=""></p><h2 id="_2-powermem-介绍" tabindex="-1">2. PowerMem 介绍 <a class="header-anchor" href="#_2-powermem-介绍" aria-label="Permalink to &quot;2. PowerMem 介绍&quot;">​</a></h2><p><a href="https://github.com/oceanbase/powermem" target="_blank" rel="noreferrer">PowerMem</a> 是一个智能记忆管理库。在 AI 应用开发中，如何让大语言模型持久化地&quot;记住&quot;历史对话、用户偏好和上下文信息是一个核心挑战。PowerMem 融合向量检索、全文检索和图数据库的混合存储架构，为 AI 应用构建了强大的记忆基础设施。</p><p>PowerMem 的核心特性：</p><ul><li><strong>轻量级接入</strong>：提供简洁的 Python SDK，还支持 MCP Server 和 HTTP API Server 接入。</li><li><strong>智能记忆提取</strong>：通过 LLM 自动从对话中提取关键事实，智能检测重复、更新冲突信息并合并相关记忆。</li><li><strong>用户画像</strong>：自动构建和更新用户画像，让 AI 更好地理解每个用户。</li><li><strong>多用户/多智能体隔离</strong>：为每个用户或智能体提供独立的记忆空间，支持跨智能体协作。</li><li><strong>多模态支持</strong>：支持文本、图像、语音等多模态内容的记忆和检索。</li><li><strong>混合检索</strong>：融合向量检索、全文搜索和图检索的多路召回能力。</li></ul><h2 id="_3-项目效果预览" tabindex="-1">3. 项目效果预览 <a class="header-anchor" href="#_3-项目效果预览" aria-label="Permalink to &quot;3. 项目效果预览&quot;">​</a></h2><p>本文将带你使用 <strong>seekdb</strong> + <strong>PowerMem</strong> 从零构建一个多模态智能记忆系统 MemBox。MemBox 可以自动从对话中提取关键信息、构建用户画像、理解图片内容，并在后续对话中智能检索相关记忆，提供个性化回答。先来看看最终效果：</p><p><video src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20260120154438785.mp4" controls width="100%"></video></p><h2 id="_4-准备工作" tabindex="-1">4. 准备工作 <a class="header-anchor" href="#_4-准备工作" aria-label="Permalink to &quot;4. 准备工作&quot;">​</a></h2><h3 id="_4-1-环境要求" tabindex="-1">4.1 环境要求 <a class="header-anchor" href="#_4-1-环境要求" aria-label="Permalink to &quot;4.1 环境要求&quot;">​</a></h3><ul><li>Docker 和 Docker Compose（运行 seekdb）</li><li>Node.js 20+（前端）</li><li><a href="https://pnpm.io/" target="_blank" rel="noreferrer">pnpm</a>（前端包管理）</li><li>Python 3.11+（后端）</li><li><a href="https://docs.astral.sh/uv/" target="_blank" rel="noreferrer">uv</a>（Python 包管理）</li></ul><h3 id="_4-2-获取-api-key" tabindex="-1">4.2 获取 API Key <a class="header-anchor" href="#_4-2-获取-api-key" aria-label="Permalink to &quot;4.2 获取 API Key&quot;">​</a></h3><p>本项目使用阿里云通义千问模型，需要获取阿里云百炼的 API Key：</p><ol><li>访问<a href="https://bailian.console.aliyun.com/cn-beijing/?apiKey=1#/api-key" target="_blank" rel="noreferrer">阿里云百炼控制台</a>。</li><li>开通服务并创建 API Key。</li></ol><h3 id="_4-3-启动-seekdb" tabindex="-1">4.3 启动 SeekDB <a class="header-anchor" href="#_4-3-启动-seekdb" aria-label="Permalink to &quot;4.3 启动 SeekDB&quot;">​</a></h3><p>使用 Docker 快速启动 seekdb：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> seekdb</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2881</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:2881</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  -v</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> seekdb_data:/var/lib/oceanbase</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  oceanbase/seekdb:1.0.1.0-100000392025122619</span></span></code></pre></div><h3 id="_4-4-环境变量设置" tabindex="-1">4.4 环境变量设置 <a class="header-anchor" href="#_4-4-环境变量设置" aria-label="Permalink to &quot;4.4 环境变量设置&quot;">​</a></h3><p>本项目需要配置环境变量，可参考 <a href="https://github.com/cr7258/membox/blob/main/.env.example" target="_blank" rel="noreferrer">.env.example</a> 文件，将其复制为 <code>.env</code> 并填入相应值。其中只需配置 <code>DASHSCOPE_API_KEY</code> 用于调用千问大模型，其他变量可保持默认。</p><h2 id="_5-整体架构" tabindex="-1">5. 整体架构 <a class="header-anchor" href="#_5-整体架构" aria-label="Permalink to &quot;5. 整体架构&quot;">​</a></h2><p>当用户与 MemBox 对话时，完整的请求流程如下：</p><ol><li><strong>用户输入</strong>：用户在前端发送消息（可包含文字和图片）。</li><li><strong>记忆检索</strong>：前端调用后端搜索相关记忆。</li><li><strong>向量搜索</strong>：后端使用 PowerMem 将查询通过 text-embedding-v4 模型转换为向量，在 seekdb 中进行相似度搜索。</li><li><strong>返回结果</strong>：seekdb 返回相关记忆和用户画像。</li><li><strong>上下文注入</strong>：前端将记忆上下文注入 LLM 的 System Prompt。</li><li><strong>生成回答</strong>：前端调用 qwen-plus 模型生成回答，如有图片则使用多模态模型 qwen-vl-plus 模型理解图片内容。</li><li><strong>返回响应</strong>：LLM 将回答返回给用户。</li><li><strong>记忆存储</strong>：对话结束后，PowerMem 提取新的事实信息，通过 text-embedding-v4 向量化后存入 seekdb。</li></ol><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20260120161414924.png" alt=""></p><p>本文的完整代码可以在 Github 上找到：<a href="https://github.com/cr7258/membox" target="_blank" rel="noreferrer">https://github.com/cr7258/membox</a></p><h2 id="_6-搭建后端-fastapi-powermem" tabindex="-1">6. 搭建后端（FastAPI + PowerMem） <a class="header-anchor" href="#_6-搭建后端-fastapi-powermem" aria-label="Permalink to &quot;6. 搭建后端（FastAPI + PowerMem）&quot;">​</a></h2><h3 id="_6-1-配置-powermem" tabindex="-1">6.1 配置 PowerMem <a class="header-anchor" href="#_6-1-配置-powermem" aria-label="Permalink to &quot;6.1 配置 PowerMem&quot;">​</a></h3><p>PowerMem 支持两种配置方式：</p><ol><li><strong>环境变量（<code>.env</code> 文件）</strong>：适合大多数场景，PowerMem 会自动加载。</li><li><strong>JSON/ Python 字典配置</strong>：适合在代码中灵活管理配置的场景。</li></ol><p>本项目使用 JSON/Python 字典配置方式，<code>config.py</code> 配置如下：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # LLM 配置 - 用于智能记忆提取和用户画像</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;llm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;provider&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;qwen&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;model&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;LLM_MODEL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;qwen-plus&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;api_key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;DASHSCOPE_API_KEY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # Embedding 配置 - 用于向量化</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;embedder&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;provider&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;qwen&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;model&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;EMBEDDING_MODEL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;text-embedding-v4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;embedding_dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;EMBEDDING_DIMS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;1536&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;api_key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;DASHSCOPE_API_KEY&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # 向量存储配置 - SeekDB (OceanBase)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;vector_store&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;provider&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;oceanbase&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;config&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;collection_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;memories&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;embedding_model_dims&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;EMBEDDING_DIMS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;1536&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;host&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;OCEANBASE_HOST&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;127.0.0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;port&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;OCEANBASE_PORT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;2881&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;OCEANBASE_USER&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;root@sys&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;password&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;OCEANBASE_PASSWORD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;db_name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;OCEANBASE_DATABASE&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;membox&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h3 id="_6-2-记忆管理" tabindex="-1">6.2 记忆管理 <a class="header-anchor" href="#_6-2-记忆管理" aria-label="Permalink to &quot;6.2 记忆管理&quot;">​</a></h3><p><code>memory_manager.py</code> 封装了 PowerMem 的核心操作，主要包含两个方法：</p><ul><li><strong>add_memory</strong>：从对话中提取并保存记忆。通过 <code>infer=True</code> 启用智能提取，PowerMem 会自动从对话中提取事实信息、去重、更新冲突内容并整合相关记忆。通过 <code>user_id</code> 实现用户隔离，每个用户的记忆独立存储。</li><li><strong>search_memory</strong>：搜索与查询相关的记忆。通过 <code>add_profile=True</code> 在返回结果中包含用户画像，帮助 LLM 生成更个性化的回复。搜索时会根据 <code>user_id</code> 过滤，只返回当前用户的记忆。</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> powermem </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> UserMemory</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> .config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> MemoryManager</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    def</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> __init__</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(self):</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        self</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.memory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> UserMemory(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">config)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> add_memory</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(self, messages: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, user_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;&quot;&quot;从对话中提取并保存记忆&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.memory.add(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">messages,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">user_id,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            infer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">True</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 启用智能提取</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> search_memory</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(self, query: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, user_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">dict</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;&quot;&quot;搜索相关记忆&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.memory.search(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            query</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">query,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">user_id,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">limit,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">            add_profile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">True</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 同时返回用户画像</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> results</span></span></code></pre></div><h3 id="_6-3-实现-api-路由" tabindex="-1">6.3 实现 API 路由 <a class="header-anchor" href="#_6-3-实现-api-路由" aria-label="Permalink to &quot;6.3 实现 API 路由&quot;">​</a></h3><p><code>routes/memory.py</code> 提供记忆相关的 RESTful API，供前端调用：</p><ul><li><strong>POST /api/memory/add</strong>：前端在对话结束后调用，将用户和 AI 的对话内容发送到后端进行记忆提取和存储。</li><li><strong>POST /api/memory/search</strong>：前端在用户发送新消息前调用，搜索相关记忆和用户画像，注入到 LLM 的系统提示词中。</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> fastapi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> APIRouter, HTTPException</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pydantic </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> BaseModel</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ..memory_manager </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> get_memory_manager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">router </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> APIRouter()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> AddMemoryRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">BaseModel</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    messages: list[dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    user_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> SearchMemoryRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">BaseModel</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    query: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    user_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">@router.post</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/add&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> add_memory</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(request: AddMemoryRequest):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;&quot;&quot;添加记忆&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    mm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> get_memory_manager()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> mm.add_memory(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">        messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">request.messages,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">        user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">request.user_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;result&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: result}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">@router.post</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/search&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> search_memory</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(request: SearchMemoryRequest):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;&quot;&quot;搜索记忆&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    mm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> get_memory_manager()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> mm.search_memory(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">        query</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">request.query,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">        user_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">request.user_id,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">        limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">request.limit</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> results</span></span></code></pre></div><h2 id="_7-添加多模态支持" tabindex="-1">7. 添加多模态支持 <a class="header-anchor" href="#_7-添加多模态支持" aria-label="Permalink to &quot;7. 添加多模态支持&quot;">​</a></h2><p>MemBox 支持图片理解功能，用户可以上传图片并提问。整体流程如下：</p><ol><li><strong>图片上传</strong>：用户选择图片，前端上传到后端获取 URL，用于在聊天历史记录中显示图片预览。</li><li><strong>图片理解</strong>：前端将图片 URL 传给 Vercel AI SDK，SDK 自动下载图片并转成 base64 发送给 qwen-vl-plus。</li><li><strong>记忆保存</strong>：LLM 的回复（包含对图片的理解描述）作为文本保存到 PowerMem 中。</li></ol><p>这样做的好处是后端只需提供简单的图片存储服务，多模态理解由 Vercel AI SDK 和前端统一处理。</p><blockquote><p><strong>注意</strong>：PowerMem 也原生支持多模态记忆，可以在配置中设置 <code>enable_vision: True</code> 和 <code>vision_details: &quot;auto&quot;</code> 并配置相应的多模态模型（如 qwen-vl-plus），让后端直接理解图片内容并存储为记忆。具体参考 <a href="https://github.com/oceanbase/powermem/blob/main/docs/examples/scenario_7_multimodal.md" target="_blank" rel="noreferrer">PowerMem 多模态示例</a>。</p></blockquote><h3 id="_7-1-图片上传-api" tabindex="-1">7.1 图片上传 API <a class="header-anchor" href="#_7-1-图片上传-api" aria-label="Permalink to &quot;7.1 图片上传 API&quot;">​</a></h3><p>后端 <code>routes/upload.py</code> 提供图片上传接口，将图片保存到本地并返回访问 URL：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">@router.post</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/images&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> upload_images</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    files: List[UploadFile] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> File(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    user_id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Form(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        uploaded_urls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        uploaded_filenames </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        for</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;"> file</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> files:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # Check file type</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            ext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> get_file_extension(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.filename)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">not</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> ALLOWED_EXTENSIONS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">                raise</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> HTTPException(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # Generate filename and save</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            filename </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> generate_filename(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">file</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.filename)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            filepath </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> os.path.join(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">UPLOAD_DIR</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, filename)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            with</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(filepath, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;wb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> f:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> await</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;"> file</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.read()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                f.write(content)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # Generate image URL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            base_url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> os.getenv(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;BASE_URL&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://localhost:8000&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            image_url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">base_url</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/uploads/</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">filename</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            uploaded_urls.append(image_url)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            uploaded_filenames.append(filename)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">True</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;count&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(uploaded_urls),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;filenames&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: uploaded_filenames,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            &quot;urls&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: uploaded_urls</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    except</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> Exception</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> e:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">        # ... error handling</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        raise</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> HTTPException(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">status_code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">detail</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(e))</span></span></code></pre></div><h3 id="_7-2-启动后端" tabindex="-1">7.2 启动后端 <a class="header-anchor" href="#_7-2-启动后端" aria-label="Permalink to &quot;7.2 启动后端&quot;">​</a></h3><p>可以使用以下命令启动后端服务：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> backend</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">uv</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> membox</span></span></code></pre></div><h2 id="_8-搭建前端-next-js-vercel-ai-sdk" tabindex="-1">8. 搭建前端（Next.js + Vercel AI SDK） <a class="header-anchor" href="#_8-搭建前端-next-js-vercel-ai-sdk" aria-label="Permalink to &quot;8. 搭建前端（Next.js + Vercel AI SDK）&quot;">​</a></h2><p>前端基于 Next.js 构建，主要使用以下技术栈：</p><ul><li>Vercel AI SDK</li><li>AI Elements</li><li>ui-ux-pro-max-skill</li></ul><h3 id="_8-1-vercel-ai-sdk" tabindex="-1">8.1 Vercel AI SDK <a class="header-anchor" href="#_8-1-vercel-ai-sdk" aria-label="Permalink to &quot;8.1 Vercel AI SDK&quot;">​</a></h3><p>将大语言模型（LLM）集成到应用中是一件复杂的事情，而且高度依赖于你使用的模型提供商。<a href="https://ai-sdk.dev/" target="_blank" rel="noreferrer">Vercel AI SDK</a> 标准化了跨不同提供商的 AI 模型集成方式，让开发者可以专注于构建优秀的 AI 应用，而不是在技术细节上浪费时间。</p><p>AI SDK 包含两个主要模块：</p><ul><li><strong>AI SDK Core</strong>：提供统一的 API，用于生成文本、结构化对象、工具调用以及使用 LLM 构建 Agent。</li><li><strong>AI SDK UI</strong>：提供一组与框架无关的 hooks，用于快速构建聊天界面和生成式 UI。</li></ul><h3 id="_8-2-ai-elements" tabindex="-1">8.2 AI Elements <a class="header-anchor" href="#_8-2-ai-elements" aria-label="Permalink to &quot;8.2 AI Elements&quot;">​</a></h3><p><a href="https://ai-elements.dev/" target="_blank" rel="noreferrer">AI Elements</a> 是基于 shadcn/ui 构建的组件库，帮助开发者更快地构建 AI 原生应用。它提供了预构建的组件，如对话框、消息气泡等，可以通过 CLI 命令快速安装：</p><h3 id="_8-3-ui-ux-设计" tabindex="-1">8.3 UI/UX 设计 <a class="header-anchor" href="#_8-3-ui-ux-设计" aria-label="Permalink to &quot;8.3 UI/UX 设计&quot;">​</a></h3><p>本项目使用 <a href="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" target="_blank" rel="noreferrer">ui-ux-pro-max-skill</a> 辅助设计页面风格和样式。这是一个 AI Skill，能够为多平台提供专业的 UI/UX 设计智能，自动生成设计系统并推荐最佳的颜色、字体和间距方案。</p><h3 id="_8-4-聊天状态管理" tabindex="-1">8.4 聊天状态管理 <a class="header-anchor" href="#_8-4-聊天状态管理" aria-label="Permalink to &quot;8.4 聊天状态管理&quot;">​</a></h3><p><code>app/page.tsx</code> 是前端的核心页面，使用多个 hooks 管理状态：</p><ul><li><strong>useUser</strong>：管理用户登录、切换、登出。</li><li><strong>useChatSessions</strong>：管理聊天会话的创建、切换、删除，按用户隔离。</li><li><strong>useChat</strong>：Vercel AI SDK 提供的 hook，管理消息发送和接收。</li></ul><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { useChat } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;@ai-sdk/react&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { useChatSessions } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;@/hooks/use-chat-sessions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { useUser } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;@/hooks/use-user&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> Home</span><span style="--shiki-light:#24292E;--shiki-dark:#F69D50;">() </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">pendingImages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">setPendingImages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> useState</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[]&gt;([]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 用户管理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">currentUser</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">login</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">switchUser</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">logout</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> useUser</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 聊天会话管理（按用户过滤）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    sessions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    currentSession</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    currentSessionId</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    createSession</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    updateSessionMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    deleteSession</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    selectSession</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    newChat</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> useChatSessions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(currentUser?.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 聊天 hook</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">messages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">setMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">stop</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> useChat</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    id: currentSessionId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">||</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 当消息变化时，同步到会话</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">  useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (currentSessionId </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> messages.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">      updateSessionMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(currentSessionId, messages);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }, [messages, currentSessionId, updateSessionMessages]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 切换会话时，加载对应的消息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">  useEffect</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (currentSession) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">      setMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(currentSession.messages);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">      setMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">([]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }, [currentSessionId, setMessages]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h3 id="_8-5-发送多模态消息" tabindex="-1">8.5 发送多模态消息 <a class="header-anchor" href="#_8-5-发送多模态消息" aria-label="Permalink to &quot;8.5 发送多模态消息&quot;">​</a></h3><p>构建包含文本和图片的多模态消息（<code>app/page.tsx</code>）：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> handleSubmit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> useCallback</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  async</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">message</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">message.text.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">trim</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pendingImages.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> ===</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 将 userId 存入 cookie，供 API Route 读取</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    document.cookie </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`membox_user_id=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">userId</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}; path=/; max-age=86400\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 构建包含图片和文本的 parts 数组</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> parts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Array</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&lt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      { </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;text&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      { </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">mediaType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    &gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 先添加图片</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pendingImages) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      parts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        type: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;file&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        mediaType: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;image/png&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        url: url,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 再添加文本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    parts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      type: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;text&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> as</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      text: message.text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;Please describe these images&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 清空待发送的图片</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">    setPendingImages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">([]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 发送消息到 /api/chat，由 API Route 调用 LLM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> sendMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({ parts });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  [sendMessage, userId, pendingImages]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);</span></span></code></pre></div><h3 id="_8-6-调用-llm-生成回复" tabindex="-1">8.6 调用 LLM 生成回复 <a class="header-anchor" href="#_8-6-调用-llm-生成回复" aria-label="Permalink to &quot;8.6 调用 LLM 生成回复&quot;">​</a></h3><p><code>app/api/chat/route.ts</code> 是前端的核心 API Route，负责：</p><ol><li><strong>搜索记忆</strong>：调用后端 <code>/api/memory/search</code> 获取相关记忆和用户画像。</li><li><strong>调用 LLM</strong>：将记忆上下文注入 System Prompt，调用千问模型生成回复。</li><li><strong>保存记忆</strong>：在 LLM 回复完成后，调用后端 <code>/api/memory/add</code> 保存记忆。</li></ol><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { convertToModelMessages, streamText, consumeStream, UIMessage } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;ai&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { createOpenAICompatible } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;@ai-sdk/openai-compatible&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 创建 Qwen 客户端（兼容 OpenAI 协议）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> qwen</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> createOpenAICompatible</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  name: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;qwen&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  apiKey: process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">DASHSCOPE_API_KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  baseURL: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;https://dashscope.aliyuncs.com/compatible-mode/v1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> POST</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 接收前端发送的对话历史（包含 parts 格式的多模态消息）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">messages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">messages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> UIMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[] } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 从 cookie 获取用户 ID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> cookies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> req.headers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;cookie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> userIdMatch</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> cookies.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">match</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/membox_user_id=(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">^</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">;]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">)/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> userId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> userIdMatch?.[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">??</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;default_user&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 获取最后一条用户消息的文本</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> lastMessage</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> messages.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">at</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> lastMessageText</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> lastMessage?.parts?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> p.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;text&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)?.text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">??</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 检测是否有图片，选择对应模型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> hasImages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> messages.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">some</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">m</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> m.parts?.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">some</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">p</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> p.type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> modelName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> hasImages </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;qwen-vl-plus&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;qwen-plus&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 1. 搜索相关记忆</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> backendUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NEXT_PUBLIC_BACKEND_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> ??</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;http://localhost:8000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> memoryContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> searchRes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">backendUrl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}/api/memory/search\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      method: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      headers: { </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;application/json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      body: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        query: lastMessageText,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        user_id: userId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (searchRes.ok) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> searchData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> searchRes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      // 用户画像</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (searchData.profile_content) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        memoryContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">User Profile: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">searchData</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">profile_content</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      // 相关记忆</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (searchData.results?.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        memoryContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\n\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Related Memories:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> mem</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> of</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> searchData.results) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          memoryContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">+=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">- \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">mem</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">memory</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 忽略记忆搜索错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 2. 构建 System Prompt，注入记忆上下文</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> systemPrompt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`You are MemBox, an intelligent memory assistant...</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">memoryContext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> ?</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`Here is background information:\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">memoryContext</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;&#39;}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  // 3. 调用 LLM</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> modelMessages</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> convertToModelMessages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(messages);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> streamText</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    model: qwen.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">chatModel</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(modelName),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    system: systemPrompt,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    messages: modelMessages,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 4. LLM 回复完成后保存记忆</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> onFinish</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> conversationToSave</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        { role: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;user&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, content: lastMessageText </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">||</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;User shared images&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        { role: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;assistant&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, content: text },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      ];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      try</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">backendUrl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}/api/memory/add\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          method: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;POST&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          headers: { </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;Content-Type&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;application/json&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          body: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            messages: conversationToSave,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            user_id: userId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">        // 忽略保存错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> result.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">toUIMessageStreamResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">({ consumeSseStream: consumeStream });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h3 id="_8-7-启动前端" tabindex="-1">8.7 启动前端 <a class="header-anchor" href="#_8-7-启动前端" aria-label="Permalink to &quot;8.7 启动前端&quot;">​</a></h3><p>安装依赖并启动前端服务：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> frontend</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span></span></code></pre></div><p>访问 <a href="http://localhost:3000" target="_blank" rel="noreferrer">http://localhost:3000</a> 访问页面。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20260120180645934.png" alt=""></p><p>输入用户名后即可开始聊天对话：</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20260120180735264.png" alt=""></p><h2 id="_9-效果演示" tabindex="-1">9. 效果演示 <a class="header-anchor" href="#_9-效果演示" aria-label="Permalink to &quot;9. 效果演示&quot;">​</a></h2><h3 id="_9-1-智能记忆" tabindex="-1">9.1 智能记忆 <a class="header-anchor" href="#_9-1-智能记忆" aria-label="Permalink to &quot;9.1 智能记忆&quot;">​</a></h3><p>首先看看 PowerMem 的 <strong>Intelligent Memory（智能记忆）</strong> 功能：</p><blockquote><p>👤 Seven：我是 Seven，在上海工作，喜欢踢足球</p><p>🤖 MemBox：嗨 Seven！上海的足球氛围挺不错的，黄浦区和徐汇区都有很多球场，周末经常能看到业余联赛。你平时都在哪个区域踢球呀？要是你喜欢的话，我还可以推荐几个不错的足球社群给你~</p></blockquote><p>PowerMem 会将这些信息持久化存储到 SeekDB 中，即使会话结束也不会丢失，随时可以在后续对话中被智能检索和使用。</p><h3 id="_9-2-记忆检索" tabindex="-1">9.2 记忆检索 <a class="header-anchor" href="#_9-2-记忆检索" aria-label="Permalink to &quot;9.2 记忆检索&quot;">​</a></h3><p>当用户发起新对话时，MemBox 会<strong>自动根据当前问题检索相关记忆</strong>。这是通过 SeekDB 的向量相似度搜索实现的——将用户问题转换为向量，在记忆库中找到语义最相近的内容。</p><p>下次对话时，即使用户没有明确提及之前说过的内容，MemBox 也能智能关联：</p><blockquote><p>👤 Seven：周末有什么活动推荐？</p><p>🤖 MemBox：Hey Seven！既然你在上海而且喜欢踢足球，周未不如来场酣畅淋漓的球局吧！......</p></blockquote><p>注意，Seven 并没有再次提到&quot;足球&quot;，但 MemBox 自动检索到了之前记忆的兴趣爱好，并据此给出个性化推荐。</p><h3 id="_9-3-多模态记忆" tabindex="-1">9.3 多模态记忆 <a class="header-anchor" href="#_9-3-多模态记忆" aria-label="Permalink to &quot;9.3 多模态记忆&quot;">​</a></h3><p>MemBox 不仅能记住文字，还能<strong>理解和记忆图片内容</strong>。当用户上传图片时，前端会调用多模态 LLM（qwen-vl-plus）来理解图片，然后将理解结果作为记忆存储：</p><blockquote><p>👤 Seven：[上传一张猫的照片] 这是我的猫咪小蓝</p><p>🤖 MemBox：哇，小蓝看起来好可爱！这只灰白相间的猫咪趴在柔软的毯子上，阳光洒在它身上，真是治愈系的画面。你一定很爱它吧？猫咪总是能带来温暖和放松的感觉，看着它安静的样子，心情都会变好呢～</p></blockquote><p>LLM 不仅识别出了猫的品种（英短蓝猫），还将这些信息与用户关联存储。之后再问起时，MemBox 能准确回忆：</p><blockquote><p>👤 Seven：我的宠物叫什么名字？</p><p>🤖 MemBox：你的宠物叫小蓝，是一只灰白相间的猫咪，特别喜欢趴在柔软的毯子上休息。</p></blockquote><h3 id="_9-4-用户画像" tabindex="-1">9.4 用户画像 <a class="header-anchor" href="#_9-4-用户画像" aria-label="Permalink to &quot;9.4 用户画像&quot;">​</a></h3><p>PowerMem 最强大的功能之一是<strong>自动构建用户画像</strong>。每次对话后，系统会：</p><ol><li>获取该用户现有的画像（如果有）。</li><li>分析新对话，提取新的用户信息。</li><li>调用 LLM 将新旧信息智能合并。</li><li>更新用户画像。</li></ol><p>随着对话积累，画像越来越丰富：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>👤 用户画像：</span></span>
<span class="line"><span>- 姓名：Seven</span></span>
<span class="line"><span>- 工作地点：上海</span></span>
<span class="line"><span>- 爱好：踢足球</span></span>
<span class="line"><span>- 宠物：英短蓝猫，名叫小蓝</span></span></code></pre></div><p>PowerMem 搜索返回的结果中会包含 <code>profile_content</code> 字段，将其注入到 LLM 的上下文中，让 AI 在回答时&quot;认识&quot;这个用户。</p><h3 id="_9-5-用户隔离" tabindex="-1">9.5 用户隔离 <a class="header-anchor" href="#_9-5-用户隔离" aria-label="Permalink to &quot;9.5 用户隔离&quot;">​</a></h3><p>在多用户场景下，<strong>数据安全和隐私隔离至关重要</strong>。MemBox 通过 <code>user_id</code> 实现严格的用户隔离——每个用户只能访问自己的记忆，无法看到其他用户的数据。</p><p><strong>用户 A（Seven）的对话：</strong></p><blockquote><p>👤 Seven：我最喜欢的编程语言是 Python</p><p>🤖 MemBox：收到！我已经记下来了：你最喜欢的编程语言是 Python。</p></blockquote><p><strong>用户 B（Jane）的对话：</strong></p><blockquote><p>👤 Jane：我最喜欢的编程语言是什么？</p><p>🤖 MemBox：你还没有告诉我你最喜欢的编程语言是什么呢！要不要现在告诉我，让我帮你记下来？</p></blockquote><p>可以看到，Seven 的偏好不会泄露给 Jane。这是通过 <code>user_id</code> 在存储和检索时的过滤实现的： SeekDB 在底层会将 <code>user_id</code> 作为过滤条件，确保查询结果只包含当前用户的数据。</p><h2 id="_10-总结" tabindex="-1">10. 总结 <a class="header-anchor" href="#_10-总结" aria-label="Permalink to &quot;10. 总结&quot;">​</a></h2><p>本文介绍了如何使用 SeekDB 和 PowerMem 构建一个多模态智能记忆系统 MemBox。通过 SeekDB 的向量检索能力和 PowerMem 的智能记忆提取，MemBox 能够自动从对话中提取关键信息、构建用户画像，并在后续对话中提供个性化回复。前端基于 Vercel AI SDK 实现了流式对话和多模态图片理解，后端通过 FastAPI 提供记忆存储和检索服务。整个系统还支持多用户隔离，确保每个用户的数据安全独立。</p><h2 id="_11-参考资料" tabindex="-1">11. 参考资料 <a class="header-anchor" href="#_11-参考资料" aria-label="Permalink to &quot;11. 参考资料&quot;">​</a></h2><ul><li><a href="https://github.com/oceanbase/seekdb" target="_blank" rel="noreferrer">SeekDB 文档</a></li><li><a href="https://github.com/oceanbase/powermem" target="_blank" rel="noreferrer">PowerMem 文档</a></li><li><a href="https://ai-sdk.dev" target="_blank" rel="noreferrer">Vercel AI SDK</a></li></ul>`,116))])}const M=e(C,[["render",c]]);export{f as __pageData,M as default};
