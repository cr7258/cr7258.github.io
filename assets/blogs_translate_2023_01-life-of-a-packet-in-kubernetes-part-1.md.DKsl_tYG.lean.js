import{_ as p}from"./chunks/ArticleMetadata.CAxLmLz2.js";import{_ as e,C as F,c as r,o as h,k,G as d,P as g,a as y,w as D,b as C,e as c}from"./chunks/framework.kLAB-UjF.js";import"./chunks/md5.CeBdha7O.js";const q=JSON.parse('{"title":"Kubernetes 中数据包的生命周期 -- 第 1 部分","description":"","frontmatter":{"title":"Kubernetes 中数据包的生命周期 -- 第 1 部分","author":"Se7en","date":"2023/08/01 22:36","categories":["翻译"],"tags":["Kubernetes"]},"headers":[],"relativePath":"blogs/translate/2023/01-life-of-a-packet-in-kubernetes-part-1.md","filePath":"blogs/translate/2023/01-life-of-a-packet-in-kubernetes-part-1.md","lastUpdated":1707227798000}'),o={name:"blogs/translate/2023/01-life-of-a-packet-in-kubernetes-part-1.md"};function A(i,s,B,u,m,b){const t=p,l=F("ClientOnly");return h(),r("div",null,[s[0]||(s[0]=k("h1",{id:"kubernetes-中数据包的生命周期-第-1-部分",tabindex:"-1"},[y("Kubernetes 中数据包的生命周期 -- 第 1 部分 "),k("a",{class:"header-anchor",href:"#kubernetes-中数据包的生命周期-第-1-部分","aria-label":'Permalink to "Kubernetes 中数据包的生命周期 -- 第 1 部分"'},"​")],-1)),d(l,null,{default:D(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),C(t,{key:0,article:i.$frontmatter},null,8,["article"])):c("",!0)]}),_:1}),s[1]||(s[1]=g(`<blockquote><p>本文翻译自：<a href="https://medium.com/@dramasamy/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051" target="_blank" rel="noreferrer">Life of a Packet in Kubernetes — Part 1 [1]</a><br> 作者：Dinesh Kumar Ramasamy<br> 本文在原文的基础上做了适当的修改，如有疑问请查阅原文。</p></blockquote><p>Kubernetes 集群中的网络可能会令人感到有点困惑，即便是对于拥有虚拟网络和路由实践经验的工程师来说也是如此。本系列文章将分为 4 个部分，帮助你理解基本的 Kubernetes 网络，本文属于第 1 部分。</p><ul><li>Part 1 <ul><li>1.Linux 命名空间（Namespaces）</li><li>2.容器网络（Network Namespace）</li><li>3.什么是 CNI？</li><li>4.Pod 网络命名空间</li></ul></li><li>Part 2 <ul><li>1.Calico CNI</li></ul></li><li>Part 3 <ul><li>1.Pod-to-Pod</li><li>2.Pod-to-External</li><li>3.Pod-to-Service</li><li>4.External-to-Pod</li><li>5.External Traffic Policy</li><li>6.Kube-Proxy</li><li>7.iptable rules processing flow</li><li>8.Network Policy basics</li></ul></li><li>Part 4 <ul><li>1.Ingress Controller</li><li>2.Ingress Resources Example</li><li>3.Nginx</li><li>4.Envoy+Contour</li><li>5.Ingress with MetalLB</li></ul></li></ul><h2 id="linux-命名空间-namespaces" tabindex="-1">Linux 命名空间（Namespaces） <a class="header-anchor" href="#linux-命名空间-namespaces" aria-label="Permalink to &quot;Linux 命名空间（Namespaces）&quot;">​</a></h2><p>Linux namespace 包含了大多数现代容器实现背后的一些基本技术。从高层次来看，它们允许在独立的进程之间隔离全局系统资源。例如，PID namespace 隔离了进程 ID，这意味着在同一主机上运行的两个进程可以具有相同的 PID！</p><p>这种隔离级别显然在容器领域非常有用。假如没有 namespace 技术，在容器 A 中运行的进程甚至可以 umount 容器 B 中重要的文件系统，或更改容器 C 中的主机名，或从容器 D 中删除网络接口，这将会非常危险！当通过 namespace 技术隔离这些资源后，容器 A 中的进程甚至不知道容器 B, C, D 中进程的存在，这样进程之间进行的操作，都不会互相干扰，安全性可以得到保障。</p><ul><li>1.<strong>Mount</strong> -- 隔离文件系统挂载点。</li><li>2.<strong>UTS</strong> -- 隔离主机名和域名。</li><li>3.<strong>IPC</strong> -- 隔离进程间通信资源。</li><li>4.<strong>PID</strong> -- 隔离进程 ID。</li><li>5.<strong>Network</strong> -- 隔离网络资源。</li><li>6.<strong>User</strong> -- 隔离用户和用户组。</li><li>7.<strong>Cgroup</strong> -- 隔离 Cgroups 根目录。</li></ul><p>大多数容器实现都使用上述的 namespace，以便在不同的容器进程之间提供最高级别的隔离。由于 Cgroup namespace 比其他 namespace 技术出现得稍晚一些，因此尚未被广泛使用。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420152147.png" alt=""></p><h2 id="容器网络-network-namespace" tabindex="-1">容器网络（Network Namespace） <a class="header-anchor" href="#容器网络-network-namespace" aria-label="Permalink to &quot;容器网络（Network Namespace）&quot;">​</a></h2><p>在我们开始了解 CNI 和 Docker 提供的各种功能之前，让我们探索一下驱动容器网络的核心技术。Linux 内核已经具有在主机上实现多租户的各种功能。namespace 为不同类型的资源提供了隔离的功能，其中 network namespace 提供了网络资源的隔离。 在 Linux 操作系统中，可以很容易地使用 <strong>ip</strong> 命令创建 network namespace。让我们创建两个不同的 network namespace，并分别将它们命名为 client 和 server。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">client</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420153805.png" alt=""></p><p>创建一个 <strong>veth</strong> 对来连接这两个 network namespace，<strong>veth</strong> 对可以看作是一根网线。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">4:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server@veth-client:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAST,M-DOW</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">5:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client@veth-server:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAST,M-DOW</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420154101.png" alt=""></p><p>当前 <strong>veth</strong> 对在主机的 network namespace 中，现在让我们将 <strong>veth</strong> 对的两端分别接在前面创建的两个 namespace 中。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 此时 veth 对不在主机的 network namespace 中了</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420155049.png" alt=""></p><p>让我们验证 namespace 中确实存在 <strong>veth</strong> 对，首先从 <strong>client</strong> namespace 开始。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LOOPBAC</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">K</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/loopback</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">5:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client@if4:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/ether</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca:e8:30:2e:f9:d2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ff:ff:ff:ff:ff:ff</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link-netnsid</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span></code></pre></div><p>接着确认 <strong>server</strong> namespace。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LOOPBAC</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">K</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/loopback</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">4:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server@if5:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DEFAULT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/ether</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 42</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:96:f0:ae:f0:c5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ff:ff:ff:ff:ff:ff</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link-netnsid</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span></span></code></pre></div><p>现在让我们为这些接口分配 IP 地址并启用它们。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> address</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.11/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> address</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LOOPBAC</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">K</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/loopback</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">5:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client@if4:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">P</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noqueue</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/ether</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca:e8:30:2e:f9:d2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ff:ff:ff:ff:ff:ff</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link-netnsid</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.11/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> global</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-client</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet6</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> fe80::c8e8:30ff:fe2e:f9d2/64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LOOPBAC</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">K</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/loopback</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">4:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server@if5:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">P</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noqueue</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/ether</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 42</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:96:f0:ae:f0:c5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ff:ff:ff:ff:ff:ff</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link-netnsid</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> global</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet6</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> fe80::4096:f0ff:feae:f0c5/64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420155747.png" alt=""></p><p>使用 ping 命令，我们可以验证两个 network namespace 已经连接并且可以访问。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (10.0.0.12) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) bytes of data.  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.101</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.072</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.084</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.077</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.079</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span></code></pre></div><p>如果我们想创建更多的 network namespace 并将它们连接在一起，那么为每个 namespace 创建一个 <strong>veth</strong> 对可能不是一个可扩展的解决方案。相反，可以创建一个 Linux 网桥并将这些 network namespace 连接到网桥实现互通。这正是 Docker 在同一主机上运行的容器之间建立网络的方式！ 让我们创建 namespace 并将其添加到网桥中，<strong>BR</strong> 和 <strong>HOST_IP</strong> 两个变量根据主机的实际情况进行修改。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 变量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">BR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">bridge1</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 网桥名字</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST_IP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.33</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 主机地址</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建 veth 对</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth-br</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth-br</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建网桥</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $BR </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bridge</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建 network namespace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 连接 veth 对与 network namespace </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 连接 veth 对的另一端与网桥</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth-br</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> master</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $BR  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth-br</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> master</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $BR</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 启用网桥，接口</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $BR </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">up</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth-br</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth-br</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 为接口添加 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.11/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1-veth</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1-veth</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.1/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $BR</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420161407.png" alt=""></p><p>使用 ping 命令，我们可以验证两个 network namespace 已经连接并且可以访问。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (172.30.0.12) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) bytes of data.  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.138</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.091</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.073</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.070</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.12:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.107</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span></code></pre></div><p>如果上面的 ping 命令不通可能是由于 Docker 将 iptables 的 FORWARD 链默认动作设置为 DROP，参见 <a href="https://docs.docker.com/network/iptables/#docker-on-a-router" target="_blank" rel="noreferrer">Docker 官网 [2]</a>。 可以使用以下命令将 FORWARD 设置为 ACCEPT。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -P</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> FORWARD</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ACCEPT</span></span></code></pre></div><p>让我们从 namespace 中 ping 主机地址。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOST_IP </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-c</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">connect:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Network</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> unreachable</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 网络不可达</span></span></code></pre></div><p>收到了“网络不可以达“的响应，这是因为在新创建的 namespace 中没有配置路由。让我们添加一条默认路由。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOST_IP </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-c</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (172.17.0.23) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.053</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.121</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.078</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.129</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0.119</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> statistics</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> transmitted,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> received,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loss,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3999</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">rtt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> min/avg/max/mdev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0.053</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0.100/0.129/0.029</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span></code></pre></div><p>现在通往外部的默认路由指向了网桥，因此在 namespace 中可以访问任何外部服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ping</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.8.8</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -c</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.8.8</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (8.8.8.8) 56(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">84</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) bytes of data.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.8.8:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">117</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3.40</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.8.8:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> icmp_seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">117</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3.81</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">---</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.8.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ping</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> statistics</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> ---</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> transmitted,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> received,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">%</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loss,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> time</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1001</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">rtt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> min/avg/max/mdev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3.403</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/3.610/3.817/0.207</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ms</span></span></code></pre></div><p><strong>那么如何从外部访问私有网络呢？</strong> 如你所见，我们演示的机器已经安装了 Docker，并且 Docker 自动创建了一个名为 <strong>docker0</strong> 的网桥。在 network namespace 中运行 Web 服务并不容易，因为所有的 Linux namespace 都需要互通以模拟这种情况。让我们使用 Docker 来模拟场景。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> encap:Ethernet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  HWaddr</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 02</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:42:e2:44:07:39</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr:172.18.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Bcast:172.18.0.255</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Mask:255.255.255.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> BROADCAST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MULTICAST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  MTU:1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Metric:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> frame:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          TX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> carrier:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          collisions:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> txqueuelen:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes:0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (0.0 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  TX bytes:0 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><p>现在让我们启动一个 Nginx 容器并查看它。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 启动 Nginx 容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> web</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --rm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nginx</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">efff2d2c98f94671f69cddc5cc88bb7a0a5a2ea15dc3c98d911e39bf2764a556</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 获取容器 IP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">WEB_IP=\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inspect </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;{{ .NetworkSettings.IPAddress }}&quot; web\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 获取容器的 network namespace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inspect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> web</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --format</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;{{ .NetworkSettings.SandboxKey }}&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/var/run/docker/netns/c009f2a4be71</span></span></code></pre></div><p>由于 Docker 不会在默认位置（<em>var/run/netns/</em> 目录）创建 <strong>netns</strong>，因此 <strong>ip netns list</strong> 命令不会显示这个 network namespace。我们可以创建符号连接指向预期位置来解决。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">container_id=web</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">container_netns=$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inspect \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">container_id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">--format</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;{{ .NetworkSettings.SandboxKey }}&#39;)</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/run/netns</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/run/netns/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${container_id}  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -sv</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> \${container_netns} </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/var/run/netns/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${container_id}  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">&#39;/var/run/netns/web&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/var/run/docker/netns/c009f2a4be71&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">web</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 容器的 network namespace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">server1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">client1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (id: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><p>让我们检查一下 web namespace 中的 IP 地址。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> web</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LOOPBACK,UP,LOWER_U</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">P</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noqueue</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> UNKNOWN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qlen</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/loopback</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 00</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.1/8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> host</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> lo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> eth0@if12:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">P</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mtu</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> qdisc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> noqueue</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    link/ether</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 02</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:42:ac:12:00:03</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ff:ff:ff:ff:ff:ff</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link-netnsid</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    inet</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.18</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.3/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> brd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.18</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.255</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> global</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       valid_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> preferred_lft</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forever</span></span></code></pre></div><p>让我们检查一下 Docker 容器中的 IP 地址。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">WEB_IP=\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inspect </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;{{ .NetworkSettings.IPAddress }}&quot; web\`</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $WEB_IP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">172.18.0.3</span></span></code></pre></div><p>很明显，Docker 使用了所有的 Linux namespace 并将容器与主机隔离开来。让我们尝试从主机访问运行在 web namespace 中的 Web 服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">curl</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $WEB_IP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DOCTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> htm</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    body</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        width:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 35</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">em</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        margin:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> auto</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        font-family:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Tahoma,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Verdana,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Arial,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sans-serif</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">If you see this page, the nginx web server is successfully installed and</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">working.</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Further</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> required.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">For online documentation and support please refer to</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.org/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.org</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">br/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Commercial</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> support</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> available</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.com/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.com</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p&gt;&lt;em</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Thank you </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> using nginx.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/em&gt;&lt;/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><p>是否可以从外部网络访问这个 Web 服务呢？是的，需要添加端口转发。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PREROUTING</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --dport</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DNAT</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --to-destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $WEB_IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:80</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">echo</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOST_IP  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">172.17.0.23</span></span></code></pre></div><p>让我们尝试在外部主机访问 Web 服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">node01</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 172.17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.23</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DOCTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> htm</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    body</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        width:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 35</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">em</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        margin:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> auto</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        font-family:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Tahoma,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Verdana,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Arial,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sans-serif</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">If you see this page, the nginx web server is successfully installed and</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">working.</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Further</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> required.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">For online documentation and support please refer to</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.org/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.org</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">br/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Commercial</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> support</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> available</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.com/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.com</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p&gt;&lt;em</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Thank you </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> using nginx.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/em&gt;&lt;/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420170033.png" alt=""></p><p>CNI 插件执行上述的命令（不完全是，但类似）来设置 loopback 接口，eth0 接口，并将 IP 地址分配给容器。容器运行时（例如 Kubernetes，Podman 等等）利用 CNI 来设置 Pod 网络。让我们在下一个章节讨论 CNI。</p><h2 id="什么是-cni" tabindex="-1">什么是 CNI？ <a class="header-anchor" href="#什么是-cni" aria-label="Permalink to &quot;什么是 CNI？&quot;">​</a></h2><p>CNI 插件负责将网络接口接入容器的 network namespace（例如 veth 对的一端）并在主机上进行任何必要的更改（例如将 veth 的另一端连接到网桥中）。然后调用合适的 IPAM 插件为接口分配 IP 地址并设置路由。</p><p><strong>等等，似曾相识？</strong> 是的，我们已经在<strong>容器网络</strong>章节中提到了这一点。</p><p>CNI (Container Network Interface，容器网络接口) 是一个 Cloud Native Computing Foundation（云原生计算基金会）的项目，由一系列规范和库组成，用于编写配置 Linux 容器网络的插件。由于 CNI 规范专注于容器的网络连接，并且易于实现，因此得到了广泛的支持。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420172228.png" alt=""></p><p>详情参见：<a href="https://github.com/containernetworking/cni/blob/master/SPEC.md" target="_blank" rel="noreferrer">CNI 规范 [3]</a>。以下是我在第一次通读时发现的一些有趣的点：</p><ul><li>规范中将容器定义为 Linux network namespace。我们应该对这个定义感到满意，因为像 Docker 这样的容器运行时会为每个容器创建一个新的 network namespace。</li><li>网络配置由 JSON 对象组成。</li><li>网络配置通过 STDIN 输入流的方式传递给插件，也就是说主机上没有用于网络配置的文件。</li><li>其他参数通过环境变量传递给插件。</li><li>CNI 插件被实现为一个可执行文件。</li><li>CNI 插件负责连接容器，也就是说它需要将容器接入网络。</li><li>CNI 插件负责调用 IPAM 插件为容器分配 IP 地址并设置路由。</li></ul><p>让我们尝试在没有 Kubernetes 的情况下手动模拟 Pod 的创建，并通过 CNI 插件分配 IP 地址。 第 1 步：下载 CNI 插件。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cni</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cni</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -O</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://github.com/containernetworking/cni/releases/download/v0.4.0/cni-amd64-v0.4.0.tgz</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -xvf</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cni-amd64-v0.4.0.tgz</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./macvlan</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./dhcp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./loopback</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ptp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ipvlan</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./bridge</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./tuning</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./noop</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./host-local</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./cnitool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./flannel</span></span></code></pre></div><p>第 2 步：创建 JSON 格式的 CNI 配置。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/00-demo.conf</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;"> EOF</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;cniVersion&quot;: &quot;0.2.0&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;name&quot;: &quot;demo_br&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;type&quot;: &quot;bridge&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;bridge&quot;: &quot;cni_net0&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;isGateway&quot;: true,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;ipMasq&quot;: true,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    &quot;ipam&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;type&quot;: &quot;host-local&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;subnet&quot;: &quot;10.0.10.0/24&quot;,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &quot;routes&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            { &quot;dst&quot;: &quot;0.0.0.0/0&quot; },</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            { &quot;dst&quot;: &quot;1.1.1.1/32&quot;, &quot;gw&quot;:&quot;10.0.10.1&quot;}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        ]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span></span></code></pre></div><p>CNI 的配置参数如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-:CNI</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 通用参数:-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cniVersion:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 定义</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> CNI</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 的版本。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 网络名称。</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">使用的插件名称。在本例中,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 是插件可执行文件的名称。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">args:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 可选的附加参数。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ipMasq:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 为网络配置源地址转换（SNAT）。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ipam:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IPAM</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 插件名称。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    subnet:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 分配的子网。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    routes:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        dst:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 目的网段。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        gw:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 去往目的网段的下一跳地址，如果没有指定则使用子网的默认网关。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">dns:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    nameservers:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DNS服务器列表。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    domain:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DNS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 请求的搜索域。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    search:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DNS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 请求的搜索域列表。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    options:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 传递给接收者的选项列表。</span></span></code></pre></div><p>第 3 步：创建一个具有 <strong>none</strong> 网络类型的容器，这样容器就不会使用任何 IP 地址。你可以使用任何镜像来创建容器，这里我使用 <strong>pause</strong> 容器来模拟 Kubernetes。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建容器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pause_demo</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --network</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> none</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubernetes/pause</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 将 Docker 创建的 network namespace 文件软连接到默认路径</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">container_id=pause_demo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">container_netns=$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inspect \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">container_id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">--format</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;{{ .NetworkSettings.SandboxKey }}&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/run/netns</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/run/netns/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${container_id}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -sv</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> \${container_netns} </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/var/run/netns/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${container_id}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">&#39;/var/run/netns/pause_demo&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/var/run/docker/netns/0297681f79b5&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 查看 network namespace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pause_demo</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 查看容器接口</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $container_id </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ifconfig</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">lo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        Link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> encap:Local</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Loopback</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr:127.0.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Mask:255.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOOPBACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RUNNING</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  MTU:65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Metric:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> frame:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          TX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> carrier:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          collisions:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> txqueuelen:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes:0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (0.0 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  TX bytes:0 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><p>第 4 步：用配置文件执行 CNI 插件。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CNI_CONTAINERID=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$container_id </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">CNI_IFNAME=eth10 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CNI_COMMAND=ADD</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">CNI_NETNS=/var/run/netns/$container_id </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">CNI_PATH=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">pwd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> ./bridge</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/00-demo.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 返回结果，第一次执行该命令会报错，容器网络仍然会设置成功</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># /var/lib/cni/networks/demo_br/last_reserved_ip 文件用于记录已经分配的 IP 地址</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第一次执行以后会自动生成该文件，后续执行就不会报错了</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">2020/10/17</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 17</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:32:37</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Error</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> retriving</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> last</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reserved</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Failed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> retrieve</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> last</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reserved</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> open</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/lib/cni/networks/demo_br/last_reserved_ip:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> no</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> such</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> directory</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    &quot;ip4&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        &quot;ip&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;10.0.10.2/24&quot;,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        &quot;gateway&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;10.0.10.1&quot;,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        &quot;routes&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">                &quot;dst&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;0.0.0.0/0&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">                &quot;dst&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;1.1.1.1/32&quot;,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">                &quot;gw&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;10.0.10.1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    &quot;dns&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><ul><li><strong>CNI_COMMAND=ADD</strong> — 操作（可选值: ADD/DEL/CHECK）</li><li><strong>CNI_CONTAINER=pause_demo</strong> — 我们告诉 CNI 插件在名为 <strong>pause_demo</strong> 的 network namespace 进行操作。</li><li><strong>CNI_NETNS=/var/run/netns/pause_demo</strong> — namespace 文件所在的路径。</li><li><strong>CNI_IFNAME=eth10</strong> — 希望在容器中设置的网络接口名称。</li><li><strong>CNI_PATH=<code>pwd</code></strong> — 告诉 CNI 插件可执行文件所在的路径，由于我们当前正好在 CNI 插件的目录中，因此可以使用 <code>pwd</code> 获取路径。</li></ul><blockquote><p>我强烈建议你阅读 CNI 规范以获取有关插件及其功能的更多信息。你可以在同一个 JSON 文件中使用多个插件执行一系列操作，例如添加防火墙规则等等。</p></blockquote><p>第 5 步：运行上述命令会返回一些内容。首先，会返回一个错误，因为 IPAM 驱动程序找不到它用来在本地存储 IP 信息的文件。如果我们为不同的 network namespace 再次运行该命令时，将不会收到此错误，因为该文件是在第一次运行插件时创建的。其次，我们可以得到一个 JSON 对象，表明了插件配置的相关 IP 配置。在本例中，网桥的 IP 地址应当被设置为 10.0.10.1/24，容器接口的 IP 地址应当被设置为 10.0.10.2/24，在容器中还添加了我们在 JSON 配置文件中定义的默认路由和 1.1.1.1/32 的路由。让我们看看它做了什么。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pause_demo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ifconfig</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">eth10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> encap:Ethernet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  HWaddr</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">a:58:0a:00:0a:02</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr:10.0.10.2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Bcast:0.0.0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Mask:255.255.255.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> BROADCAST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RUNNING</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MULTICAST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  MTU:1500</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Metric:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:18</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> frame:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          TX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> carrier:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          collisions:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> txqueuelen:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes:1476</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1.4 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">KB</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  TX bytes:0 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">lo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        Link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> encap:Local</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Loopback</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> addr:127.0.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Mask:255.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          UP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOOPBACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RUNNING</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  MTU:65536</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Metric:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> frame:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          TX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> packets:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> errors:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dropped:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> overruns:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> carrier:0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          collisions:0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> txqueuelen:1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">          RX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes:0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (0.0 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)  TX bytes:0 (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> netns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pause_demo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.10.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> eth10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1.1.1.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> via</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.10.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> eth10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">10.0.10.0/24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dev</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> eth10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  proto</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kernel</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  scope</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  src</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.10.2</span></span></code></pre></div><p>第 6 步：启动 Web 服务容器与 <strong>pause</strong> 容器共享 namespace。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> web_demo</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --rm</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --network</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> container:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$container_id </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">8fadcf2925b779de6781b4215534b32231685b8515f998b2a66a3c7e38333e30</span></span></code></pre></div><p>第 7 步：使用 pause 容器的 IP 地址来访问 Web 服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">controlplane</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $ </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/lib/cni/networks/demo_br/last_reserved_ip\`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DOCTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> htm</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">l</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/title</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    body</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        width:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 35</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">em</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        margin:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> auto</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        font-family:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Tahoma,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Verdana,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Arial,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sans-serif</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/head</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Welcome to nginx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/h</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">1&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">If you see this page, the nginx web server is successfully installed and</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">working.</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Further</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> required.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">For online documentation and support please refer to</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.org/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.org</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">br/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Commercial</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> support</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> available</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">a href=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;http://nginx.com/&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">nginx.com</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p&gt;&lt;em</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Thank you </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> using nginx.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/em&gt;&lt;/p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/body</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/html</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><p>现在让我们看看下一节中 Pod 的定义。</p><h2 id="pod-网络命名空间" tabindex="-1">Pod 网络命名空间 <a class="header-anchor" href="#pod-网络命名空间" aria-label="Permalink to &quot;Pod 网络命名空间&quot;">​</a></h2><p>在 Kubernetes 中首先要理解的是，<strong>Pod</strong> 实际上并不等同于容器，而是容器的集合。并且这些同一个集合的容器都共享一个网络堆栈。Kubernetes 通过在 <strong>pause</strong> 容器上设置网络来进行管理，你可以在创建的每个 Pod 中找到它。pause 容器本身只负责提供网络，所有其他的容器都连接到 pause 容器所在的网络。因此，在同一个 Pod 中的一个容器也可以通过 localhost 与另一个容器中的服务进行通信。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220420205102.png" alt=""></p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><ul><li>[1] 原文链接: <a href="https://medium.com/@dramasamy/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051" target="_blank" rel="noreferrer">https://medium.com/@dramasamy/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051</a></li><li>[2] Docker 官网: <a href="https://docs.docker.com/network/iptables/#docker-on-a-router" target="_blank" rel="noreferrer">https://docs.docker.com/network/iptables/#docker-on-a-router</a></li><li>[3] CNI 规范: <a href="https://github.com/containernetworking/cni/blob/master/SPEC.md" target="_blank" rel="noreferrer">https://github.com/containernetworking/cni/blob/master/SPEC.md</a></li></ul>`,90))])}const N=e(o,[["render",A]]);export{q as __pageData,N as default};
