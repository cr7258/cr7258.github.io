import{_ as p}from"./chunks/ArticleMetadata.CBANxfkh.js";import{_ as e,C as r,c as F,o as h,k as t,G as d,P as g,a as y,w as c,b as D,e as o}from"./chunks/framework.BhFhJsV2.js";import"./chunks/md5.Ek22RXBH.js";const q=JSON.parse('{"title":"Kubenetes 高可用集群搭建","description":"","frontmatter":{"title":"Kubenetes 高可用集群搭建","author":"Se7en","date":"2022/10/01 22:36","categories":["原创"],"tags":["Kubernetes"]},"headers":[],"relativePath":"blogs/original/2022/01-kubernetes-setup.md","filePath":"blogs/original/2022/01-kubernetes-setup.md","lastUpdated":1707227798000}'),C={name:"blogs/original/2022/01-kubernetes-setup.md"};function A(i,s,u,B,m,b){const k=p,l=r("ClientOnly");return h(),F("div",null,[s[0]||(s[0]=t("h1",{id:"kubenetes-高可用集群搭建",tabindex:"-1"},[y("Kubenetes 高可用集群搭建 "),t("a",{class:"header-anchor",href:"#kubenetes-高可用集群搭建","aria-label":'Permalink to "Kubenetes 高可用集群搭建"'},"​")],-1)),d(l,null,{default:c(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),D(k,{key:0,article:i.$frontmatter},null,8,["article"])):o("",!0)]}),_:1}),s[1]||(s[1]=g(`<h2 id="集群拓扑" tabindex="-1">集群拓扑 <a class="header-anchor" href="#集群拓扑" aria-label="Permalink to &quot;集群拓扑&quot;">​</a></h2><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Kubernetes/20201128223233.png" alt=""></p><h2 id="架构说明" tabindex="-1">架构说明 <a class="header-anchor" href="#架构说明" aria-label="Permalink to &quot;架构说明&quot;">​</a></h2><p>部署主要分为以下4个步骤：</p><ul><li>1.<strong>搭建外部etcd集群</strong>: etcd是kubernetes集群中的一个十分重要的组件，用于保存集群所有的网络配置和对象的状态信息。本次实验通过kubelet部署static pod方式在集群外部部署一个3节点的etcd集群。</li><li>2.<strong>负载均衡配置</strong>：haproxy为3个k8s master的apiserver提供反向代理功能，另外还是用keepalived为2个haproxy提供一个VIP（虚拟IP），当主haproxy发生故障时，VIP可以自动切换到备haproxy。</li><li>3.<strong>kubeadm部署集群</strong>：部署3 master，3 worker高可用集群。</li><li>4.<strong>部署Rancher</strong>（可选）：在kubernetes集群中安装rancher-agent，将kubeadm部署的k8s集群纳管到Rancher中。Rancher可以提供可视化管理界面。</li></ul><h2 id="ip地址规划" tabindex="-1">IP地址规划 <a class="header-anchor" href="#ip地址规划" aria-label="Permalink to &quot;IP地址规划&quot;">​</a></h2><table><thead><tr><th>IP</th><th>主机名</th><th>用途</th></tr></thead><tbody><tr><td>192.168.1.242</td><td>etcd1</td><td>etcd</td></tr><tr><td>192.168.1.243</td><td>etcd2</td><td>etcd</td></tr><tr><td>192.168.1.244</td><td>etcd3</td><td>etcd</td></tr><tr><td>192.168.1.245</td><td>master1</td><td>k8s master</td></tr><tr><td>192.168.1.246</td><td>master2</td><td>k8s master</td></tr><tr><td>192.168.1.247</td><td>master3</td><td>k8s master</td></tr><tr><td>192.168.1.248</td><td>worker1</td><td>k8s worker</td></tr><tr><td>192.168.1.249</td><td>worker2</td><td>k8s worker</td></tr><tr><td>192.168.1.250</td><td>worker3</td><td>k8s worker</td></tr><tr><td>192.168.1.251</td><td>haproxy-master</td><td>haproxy-master</td></tr><tr><td>192.168.1.252</td><td>haproxy-backup</td><td>haproxy-backup</td></tr><tr><td>192.168.1.253</td><td></td><td>k8s api-server VIP</td></tr></tbody></table><h2 id="部署操作" tabindex="-1">部署操作 <a class="header-anchor" href="#部署操作" aria-label="Permalink to &quot;部署操作&quot;">​</a></h2><h3 id="_1-etcd集群搭建" tabindex="-1">1 etcd集群搭建 <a class="header-anchor" href="#_1-etcd集群搭建" aria-label="Permalink to &quot;1 etcd集群搭建&quot;">​</a></h3><h4 id="_1-1-前提准备" tabindex="-1">1.1 前提准备 <a class="header-anchor" href="#_1-1-前提准备" aria-label="Permalink to &quot;1.1 前提准备&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#关闭selinux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">setenforce</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/selinux/config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#关闭swap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">swapoff</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/ swap / s/^\\(.*\\)$/#\\1/g&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/fstab</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#安装kubectl,kubeadm,kubelet</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[kubernetes]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">name=Kubernetes</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">enabled=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">gpgcheck=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">repo_gpgcheck=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">setenforce</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span></span></code></pre></div><h4 id="_1-2-kubelet配置" tabindex="-1">1.2 kubelet配置 <a class="header-anchor" href="#_1-2-kubelet配置" aria-label="Permalink to &quot;1.2 kubelet配置&quot;">​</a></h4><p>kubelet会根据/etc/kubernetes/manifests目录中的yaml文件拉起etcd的容器：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;"> EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ExecStart=</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">#  Replace &quot;systemd&quot; with the cgroup driver of your container runtime. The default value in the kubelet is &quot;cgroupfs&quot;.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=cgroupfs</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Restart=always</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span></span></code></pre></div><h4 id="_1-3-创建kubeadm配置文件" tabindex="-1">1.3 创建kubeadm配置文件 <a class="header-anchor" href="#_1-3-创建kubeadm配置文件" aria-label="Permalink to &quot;1.3 创建kubeadm配置文件&quot;">​</a></h4><p>使用以下脚本为每个将要运行 etcd 成员的主机生成一个 kubeadm 配置文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 指定etcd集群成员IP地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> HOST1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.242</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> HOST2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.243</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> HOST3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.244</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建临时目录来存储将被分发到其它主机上的文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST1}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST2}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST3}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ETCDHOSTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(\${HOST1} \${HOST2} \${HOST3})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">NAMES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;infra0&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;infra1&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;infra2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;\${</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ETCDHOSTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[@]}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${ETCDHOSTS[$i]}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">NAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${NAMES[$i]}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;"> EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> /tmp/\${HOST}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apiVersion: &quot;kubeadm.k8s.io/v1beta2&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kind: ClusterConfiguration</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">etcd:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    local:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        serverCertSANs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        - &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        peerCertSANs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        - &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        extraArgs:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            initial-cluster: infra0=https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ETCDHOSTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[0]}:2380,infra1=https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ETCDHOSTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[1]}:2380,infra2=https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ETCDHOSTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[2]}:2380</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            initial-cluster-state: new</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            name: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            listen-peer-urls: https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}:2380</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            listen-client-urls: https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}:2379</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            advertise-client-urls: https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}:2379</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            initial-advertise-peer-urls: https://\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}:2380</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span></code></pre></div><h4 id="_1-4-生成证书颁发机构" tabindex="-1">1.4 生成证书颁发机构 <a class="header-anchor" href="#_1-4-生成证书颁发机构" aria-label="Permalink to &quot;1.4 生成证书颁发机构&quot;">​</a></h4><p>在HOST1（192.168.1.242）主机上生成证书颁发机构：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-ca</span></span></code></pre></div><p>创建了如下两个文件：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/etc/kubernetes/pki/etcd/ca.key</span></span></code></pre></div><p>复制 CA 的 crt 和 key 文件到 etc/kubernetes/pki/etcd/ca.crt 和 /etc/kubernetes/pki/etcd/ca.key。</p><h4 id="_1-5-为每个成员创建证书" tabindex="-1">1.5 为每个成员创建证书 <a class="header-anchor" href="#_1-5-为每个成员创建证书" aria-label="Permalink to &quot;1.5 为每个成员创建证书&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST3</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-peer</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST3</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-healthcheck-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST3</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST3</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubernetes/pki</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST3}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 清理不可重复使用的证书</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubernetes/pki</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -not</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -not</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> f</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -delete</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-peer</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-healthcheck-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -R</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubernetes/pki</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST2}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubernetes/pki</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -not</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -not</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> f</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -delete</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-peer</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-healthcheck-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> phase</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config=/tmp/\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">HOST1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">}/kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST1}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/kubeadmcfg.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  /etc/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 不需要移动 certs 因为它们是给 HOST1 使用的</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 清理不应从此主机复制的证书</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST3} </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> f</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -delete</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">find</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${HOST2} </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">-name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> f</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -delete</span></span></code></pre></div><h4 id="_1-6-复制证书和kubeadm配置文件到其他两个etcd节点" tabindex="-1">1.6 复制证书和kubeadm配置文件到其他两个etcd节点 <a class="header-anchor" href="#_1-6-复制证书和kubeadm配置文件到其他两个etcd节点" aria-label="Permalink to &quot;1.6 复制证书和kubeadm配置文件到其他两个etcd节点&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>scp -r /tmp/\${HOST2}/* root@\${HOST2}:/etc/kubernetes</span></span>
<span class="line"><span>scp -r /tmp/\${HOST3}/* root@\${HOST3}:/etc/kubernetes</span></span></code></pre></div><p>确保已经所有预期的文件都存在：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@etcd1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]# tree /etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> manifests</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">│  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">└──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pki</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.key</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> directories,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 12</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> files</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@etcd2 kubernetes]# tree /etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> manifests</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">│  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">└──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pki</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.key</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> directories,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 11</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> files</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@etcd3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]# tree /etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/etc/kubernetes/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadmcfg.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> manifests</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">│  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">└──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pki</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver-etcd-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ca.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthcheck-client.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> peer.key</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        └──</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server.key</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> directories,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 11</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> files</span></span></code></pre></div><h4 id="_1-7-生成静态pod配置文件" tabindex="-1">1.7 生成静态Pod配置文件 <a class="header-anchor" href="#_1-7-生成静态pod配置文件" aria-label="Permalink to &quot;1.7 生成静态Pod配置文件&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>[root@etcd1 ~]#  kubeadm init phase etcd local --config=/etc/kubernetes/kubeadmcfg.yaml  </span></span>
<span class="line"><span>[root@etcd2 ~]#  kubeadm init phase etcd local --config=/etc/kubernetes/kubeadmcfg.yaml  </span></span>
<span class="line"><span>[root@etcd3 ~]#  kubeadm init phase etcd local --config=/etc/kubernetes/kubeadmcfg.yaml</span></span></code></pre></div><h4 id="_1-8-检查etcd集群运行情况" tabindex="-1">1.8 检查etcd集群运行情况 <a class="header-anchor" href="#_1-8-检查etcd集群运行情况" aria-label="Permalink to &quot;1.8 检查etcd集群运行情况&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@etcd1 kubernetes]# docker run --rm -it --name etcd-check \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> --net host \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> -v /etc/kubernetes:/etc/kubernetes k8s.gcr.io/etcd:\${ETCD_TAG} etcdctl \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> --cert /etc/kubernetes/pki/etcd/peer.crt \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> --key /etc/kubernetes/pki/etcd/peer.key \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> --cacert /etc/kubernetes/pki/etcd/ca.crt \\</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> --endpoints https://\${HOST1}:2379 endpoint health --cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">https://192.168.1.244:2379</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthy:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> committed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> proposal:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> took</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 29.827986</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">https://192.168.1.243:2379</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthy:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> committed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> proposal:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> took</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 30.169169</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">https://192.168.1.242:2379</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> healthy:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> committed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> proposal:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> took</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 31.270748</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ms</span></span></code></pre></div><h3 id="_2-负载均衡配置" tabindex="-1">2 负载均衡配置 <a class="header-anchor" href="#_2-负载均衡配置" aria-label="Permalink to &quot;2 负载均衡配置&quot;">​</a></h3><h4 id="_2-1-部署haproxy" tabindex="-1">2.1 部署haproxy <a class="header-anchor" href="#_2-1-部署haproxy" aria-label="Permalink to &quot;2.1 部署haproxy&quot;">​</a></h4><h5 id="_2-1-1-安装haproxy" tabindex="-1">2.1.1 安装haproxy <a class="header-anchor" href="#_2-1-1-安装haproxy" aria-label="Permalink to &quot;2.1.1 安装haproxy&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>yum install -y haproxy</span></span></code></pre></div><h5 id="_2-1-2-修改haproxy配置文件" tabindex="-1">2.1.2 修改haproxy配置文件 <a class="header-anchor" href="#_2-1-2-修改haproxy配置文件" aria-label="Permalink to &quot;2.1.2 修改haproxy配置文件&quot;">​</a></h5><p>vim /etc/haproxy/haproxy.cfg，两台haproxy的配置文件是一致的。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Example configuration for a possible web application.  See the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># full configuration options online.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Global settings</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">global</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # to have these messages end up in /var/log/haproxy.log you will</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # need to:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # 1) configure syslog to accept network log events.  This is done</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #    by adding the &#39;-r&#39; option to the SYSLOGD_OPTIONS in</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #    /etc/sysconfig/syslog</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # 2) configure local2 events to go to the /var/log/haproxy.log</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #   file. A line like the following can be added to</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #   /etc/sysconfig/syslog</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #    local2.*                       /var/log/haproxy.log</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    log</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> local2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    chroot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      /var/lib/haproxy</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    pidfile</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /var/run/haproxy.pid</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    maxconn</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     4000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    user</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        haproxy</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    group</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       haproxy</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    daemon</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    # turn on stats unix socket</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    stats</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> socket</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/lib/haproxy/stats</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># common defaults that all the &#39;listen&#39; and &#39;backend&#39; sections will</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># use if not designated in their block</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">defaults</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                    http</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    log</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     global</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                  httplog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                  dontlognull</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> http-server-close</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> forwardfor</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       except</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                  redispatch</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    retries</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> http-request</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> queue</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> connect</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> http-keep-alive</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    timeout</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    maxconn</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                 3000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># main frontend which proxys to the backends</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">frontend</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    bind</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:6443</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcplog</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    default_backend</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># static backend for serving up images, stylesheets and such</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">backend</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apiserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> httpchk</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /healthz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    http-check</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> expect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 200</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    option</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ssl-hello-chk</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    balance</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  roundrobin</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #server为三个k8s master的地址:端口</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  master1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.245:6443</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  master2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.246:6443</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  master3</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.247:6443</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check</span></span></code></pre></div><h5 id="_2-1-3-启动haproxy" tabindex="-1">2.1.3 启动haproxy <a class="header-anchor" href="#_2-1-3-启动haproxy" aria-label="Permalink to &quot;2.1.3 启动haproxy&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>systemctl enable haproxy --now</span></span></code></pre></div><h4 id="_2-2-部署keepalived" tabindex="-1">2.2 部署keepalived <a class="header-anchor" href="#_2-2-部署keepalived" aria-label="Permalink to &quot;2.2 部署keepalived&quot;">​</a></h4><h5 id="_2-2-1-安装keepalived" tabindex="-1">2.2.1 安装keepalived <a class="header-anchor" href="#_2-2-1-安装keepalived" aria-label="Permalink to &quot;2.2.1 安装keepalived&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>yum install -y keepalived</span></span></code></pre></div><h5 id="_2-2-2-修改keepalived配置文件" tabindex="-1">2.2.2 修改keepalived配置文件 <a class="header-anchor" href="#_2-2-2-修改keepalived配置文件" aria-label="Permalink to &quot;2.2.2 修改keepalived配置文件&quot;">​</a></h5><p>vim /etc/keepalived/keepalived.conf keepalived master配置文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">global_defs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    router_id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LVS_DEVEL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">vrrp_script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check_apiserver</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  interval</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  weight</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  fall</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  rise</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">vrrp_instance</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VI_1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MASTER</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #Master</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    interface</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ens192</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    virtual_router_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 51</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #主备的router_id保存一致</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    priority</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 101</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">   #Master的优先级要高于Backup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    authentication</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        auth_type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        auth_pass</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 42</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #主备的auth_pass保存一致</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    virtual_ipaddress</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        192.168.1.253</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #VIP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    track_script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        check_apiserver</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>keepalived backup配置文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">global_defs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    router_id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LVS_DEVEL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">vrrp_script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> check_apiserver</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  interval</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  weight</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  fall</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  rise</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">vrrp_instance</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VI_1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> BACKUP</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #BACKUP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    interface</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ens192</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    virtual_router_id</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 51</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #主备的router_id保存一致</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    priority</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 100</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #Master的优先级要高于Backup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    authentication</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        auth_type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PASS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        auth_pass</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 42</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #主备的auth_pass保存一致</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    virtual_ipaddress</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        192.168.1.253</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  #VIP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    track_script</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        check_apiserver</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h5 id="_2-2-3-编辑健康检查脚本" tabindex="-1">2.2.3 编辑健康检查脚本 <a class="header-anchor" href="#_2-2-3-编辑健康检查脚本" aria-label="Permalink to &quot;2.2.3 编辑健康检查脚本&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>#!/bin/sh</span></span>
<span class="line"><span></span></span>
<span class="line"><span>errorExit() {</span></span>
<span class="line"><span>    echo &quot;*** $*&quot; 1&gt;&amp;2</span></span>
<span class="line"><span>    exit 1</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>curl --silent --max-time 2 --insecure https://localhost:6443/ -o /dev/null || errorExit &quot;Error GET https://localhost:6443/&quot;</span></span>
<span class="line"><span>if ip addr | grep -q 192.168.1.253; then</span></span>
<span class="line"><span>    curl --silent --max-time 2 --insecure https://192.168.1.253:6443/ -o /dev/null || errorExit &quot;Error GET https://192.168.1.253:6443/&quot;</span></span>
<span class="line"><span>fi</span></span></code></pre></div><h5 id="_2-2-4-启动keepalived" tabindex="-1">2.2.4 启动keepalived <a class="header-anchor" href="#_2-2-4-启动keepalived" aria-label="Permalink to &quot;2.2.4 启动keepalived&quot;">​</a></h5><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>systemctl enable keepalived --now</span></span></code></pre></div><h3 id="_3-kubeadm部署集群" tabindex="-1">3 kubeadm部署集群 <a class="header-anchor" href="#_3-kubeadm部署集群" aria-label="Permalink to &quot;3 kubeadm部署集群&quot;">​</a></h3><h4 id="_3-1-前提准备" tabindex="-1">3.1 前提准备 <a class="header-anchor" href="#_3-1-前提准备" aria-label="Permalink to &quot;3.1 前提准备&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#关闭selinux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">setenforce</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s/^SELINUX=.*/SELINUX=disabled/&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/selinux/config</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#关闭swap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">swapoff</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/ swap / s/^\\(.*\\)$/#\\1/g&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/fstab</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#安装kubectl,kubeadm,kubelet</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> /etc/yum.repos.d/kubernetes.repo</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">[kubernetes]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">name=Kubernetes</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">enabled=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">gpgcheck=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">repo_gpgcheck=1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#ADBAC7;">EOF</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">setenforce</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubelet</span></span></code></pre></div><h4 id="_3-2-初始化集群" tabindex="-1">3.2 初始化集群 <a class="header-anchor" href="#_3-2-初始化集群" aria-label="Permalink to &quot;3.2 初始化集群&quot;">​</a></h4><p>kubeadm初始化yaml文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterConfiguration</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kubernetesVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">stable</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">controlPlaneEndpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;192.168.1.253:6443&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #haproxy的keepalived提供的VIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">etcd</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    external</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        endpoints</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">https://192.168.1.242:2379</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">https://192.168.1.243:2379</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">https://192.168.1.244:2379</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        caFile</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/etc/kubernetes/pki/etcd/ca.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        certFile</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/etc/kubernetes/pki/apiserver-etcd-client.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        keyFile</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/etc/kubernetes/pki/apiserver-etcd-client.key</span></span></code></pre></div><p>执行初始化命令：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#--upload-certs命令用于分发证书到其他控制节点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@master1 kubernetes]# kubeadm init --config kubeadm-config.yaml --upload-certs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">W1125</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 16</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:28:56.393074</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   13988</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configset.go:348]</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> WARNING:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cannot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> validate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> component</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> API</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> groups</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [kubelet.config.k8s.io </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kubeproxy.config.k8s.io]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[init] Using Kubernetes version: v1.19.4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[preflight] Running pre-flight checks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        [WARNING IsDockerSystemdCheck]</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> detected</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cgroupfs&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Docker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cgroup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> driver.</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> The</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> recommended</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> driver</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;systemd&quot;.</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Please</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> follow</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> guide</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://kubernetes.io/docs/setup/cri/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[preflight] Pulling images required </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> setting up a Kubernetes cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[preflight] This might take a minute or two, depending on the speed of your internet connection</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[preflight] You can also perform this action </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> beforehand using </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;kubeadm config images pull&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Using certificateDir folder </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/etc/kubernetes/pki&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;ca&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;apiserver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] apiserver serving cert is signed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master1] and IPs [</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">10.96</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.0.1 </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.1.245 </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">192.168</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.1.253]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;apiserver-kubelet-client&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;front-proxy-ca&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;front-proxy-client&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] External etcd mode: Skipping etcd/ca certificate authority generation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] External etcd mode: Skipping etcd/server certificate generation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] External etcd mode: Skipping etcd/peer certificate generation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] External etcd mode: Skipping etcd/healthcheck-client certificate generation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] External etcd mode: Skipping apiserver-etcd-client certificate generation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[certs] Generating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;sa&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> key and public key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubeconfig] Using kubeconfig folder </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/etc/kubernetes&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubeconfig] Writing </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;admin.conf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> kubeconfig file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubeconfig] Writing </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kubelet.conf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> kubeconfig file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubeconfig] Writing </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;controller-manager.conf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> kubeconfig file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubeconfig] Writing </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;scheduler.conf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> kubeconfig file</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubelet-start] Writing kubelet environment file with flags to file </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubelet-start] Writing kubelet configuration to file </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubelet-start] Starting the kubelet</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[control-plane] Using manifest folder </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/etc/kubernetes/manifests&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[control-plane] Creating static Pod manifest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;kube-apiserver&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[control-plane] Creating static Pod manifest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;kube-controller-manager&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[control-plane] Creating static Pod manifest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;kube-scheduler&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[wait-control-plane] Waiting </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the kubelet to boot up the control plane as static Pods from directory </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/etc/kubernetes/manifests&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">. This can take up to 4m0s</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[apiclient] All control plane components are healthy after 22.048332 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[upload-config] Storing the configuration used </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ConfigMap </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kubeadm-config&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Namespace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubelet] Creating a ConfigMap </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kubelet-config-1.19&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> namespace kube-system with the configuration </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the kubelets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[upload-certs] Storing the certificates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Secret </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kubeadm-certs&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Namespace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[upload-certs] Using certificate key:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">467b45aac2ebf12a6bd88d71abc91e6628698b5310529b83f9c8a8b5ec7831e6</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[mark-control-plane] Marking the node master1 as control-plane by adding the label </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;node-role.kubernetes.io/master=&#39;&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[mark-control-plane] Marking the node master1 as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] Using token: d0idxe.5qepodyefo6ohfey</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> order </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> nodes to get long term certificate credentials</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] configured RBAC rules to allow certificate rotation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> all node client certificates </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[bootstrap-token] Creating the </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;cluster-info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ConfigMap </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> the </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kube-public&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> namespace</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kubelet-finalize] Updating </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/etc/kubernetes/kubelet.conf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> to point to a rotatable kubelet client certificate and key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[addons] Applied essential addon: CoreDNS</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[addons] Applied essential addon: kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Your</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> initialized</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">To</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> using</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> need</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> regular</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> user:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/.kube</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubernetes/admin.conf</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/.kube/config</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">):$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">id</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -g</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> should</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> now</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deploy</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> network</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Run</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> one</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> options</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> listed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">You</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> can</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> now</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> any</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> number</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> running</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> command</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> each</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.253:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --token</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> d0idxe.5qepodyefo6ohfey</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sha256:2e864b2742535b83090b51416290d5b48cebe7b2d7b487c273e5e1bfe6248cca</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --control-plane</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --certificate-key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 467</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">b45aac2ebf12a6bd88d71abc91e6628698b5310529b83f9c8a8b5ec7831e6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Please</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> note</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> that</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certificate-key</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> gives</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> access</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sensitive</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> data,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> keep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> it</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> secret!</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">As</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> safeguard,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> uploaded-certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> will</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> be</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deleted</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> two</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hours</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">If</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> necessary,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> can</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> use</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reload</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> afterward.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Then</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> you</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> can</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> any</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> number</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> worker</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nodes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> running</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> each</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> as</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.253:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --token</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> d0idxe.5qepodyefo6ohfey</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sha256:2e864b2742535b83090b51416290d5b48cebe7b2d7b487c273e5e1bfe6248cca</span></span></code></pre></div><h4 id="_3-3-加入新的master节点" tabindex="-1">3.3 加入新的master节点 <a class="header-anchor" href="#_3-3-加入新的master节点" aria-label="Permalink to &quot;3.3 加入新的master节点&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.253:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --token</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> d0idxe.5qepodyefo6ohfey</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sha256:2e864b2742535b83090b51416290d5b48cebe7b2d7b487c273e5e1bfe6248cca</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --control-plane</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --certificate-key</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 467</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">b45aac2ebf12a6bd88d71abc91e6628698b5310529b83f9c8a8b5ec7831e6</span></span></code></pre></div><h4 id="_3-4-加入新的worker节点" tabindex="-1">3.4 加入新的worker节点 <a class="header-anchor" href="#_3-4-加入新的worker节点" aria-label="Permalink to &quot;3.4 加入新的worker节点&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubeadm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> join</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.253:6443</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --token</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> d0idxe.5qepodyefo6ohfey</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    --discovery-token-ca-cert-hash</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sha256:2e864b2742535b83090b51416290d5b48cebe7b2d7b487c273e5e1bfe6248cca</span></span></code></pre></div><h4 id="_3-5-查看创建完的集群" tabindex="-1">3.5 查看创建完的集群 <a class="header-anchor" href="#_3-5-查看创建完的集群" aria-label="Permalink to &quot;3.5 查看创建完的集群&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@master1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]# kubectl get node -o wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   INTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   OS-IMAGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                KERNEL-VERSION</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          CONTAINER-RUNTIME</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d8h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.245</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d6h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.246</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d6h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.247</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">worker1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.248</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">worker2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.249</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">worker3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d5h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   192.168</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.250</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CentOS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Linux</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Core)   3.10.0-693.el7.x86_64   docker://18.9.4</span></span></code></pre></div><h3 id="_4-部署rancher" tabindex="-1">4 部署Rancher <a class="header-anchor" href="#_4-部署rancher" aria-label="Permalink to &quot;4 部署Rancher&quot;">​</a></h3><h4 id="_4-1-安装rancher" tabindex="-1">4.1 安装Rancher <a class="header-anchor" href="#_4-1-安装rancher" aria-label="Permalink to &quot;4.1 安装Rancher&quot;">​</a></h4><p>本次实验Rancher部署在k8s集群中，需要另外搭建一个k8s集群用于部署Rancher，这里跳过搭建k8s集群的步骤。 通过helm部署Rancher：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rancher-latest</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://releases.rancher.com/server-charts/rancher-latest</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rancher</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rancher-latest/rancher</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cattle-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hostname=www.chengzw.top</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #安装完成后，修改cattle-system命名空间中名为rancher的service的模式为NodePort，方便我们在集群外部访问Rancher</span></span></code></pre></div><h4 id="_4-2-部署nginx-ssl卸载-可选" tabindex="-1">4.2 部署Nginx SSL卸载（可选） <a class="header-anchor" href="#_4-2-部署nginx-ssl卸载-可选" aria-label="Permalink to &quot;4.2 部署Nginx SSL卸载（可选）&quot;">​</a></h4><p>部署一台nginx用于反向代理Rancher：</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">events</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    worker_connections </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">1024;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    #Rancher http NodePort地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    upstream</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> rancher </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 192.168.1.228:32284;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 192.168.1.229:32284;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 192.168.1.230:32284;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">http_upgrade</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $connection_upgrade {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        default</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> Upgrade;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      close;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        listen </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">443 ssl http2;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">www.chengzw.top;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">        #提前导入www.chengzw.top证书和私钥到指定目录</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/root/cert/chengzwtop_2020.crt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/root/cert/chengzwtop_2020.key;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Host $host;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            #注意：如果存在此标头，则rancher/rancher不会将 HTTP 重定向到 HTTPS。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">X-Forwarded-Proto $scheme;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">X-Forwarded-Port $server_port;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">http://rancher;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Upgrade $http_upgrade;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Connection $connection_upgrade;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_http_version </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">1.1;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">            # This allows the ability for the execute sh window to remain open for up to 15 minutes. Without this parameter, the default is 1 minute and will automatically close.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_read_timeout </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">900s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            proxy_buffering </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">off;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        listen </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">80;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">www.chengzw.top;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 301</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> https://$server_name$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h4 id="_4-3-导入kubernetes集群" tabindex="-1">4.3 导入Kubernetes集群 <a class="header-anchor" href="#_4-3-导入kubernetes集群" aria-label="Permalink to &quot;4.3 导入Kubernetes集群&quot;">​</a></h4><p>在rancher页面点击添加集群--&gt;导入，下载提供的yaml文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>wget https://www.chengzw.top/v3/import/cdvk6hs4bt7kcdxnrplpnf9sbw2gpjzshzxbgxs854d6t9f8lscp29.yaml</span></span></code></pre></div><p>修改cattle-cluster-agent的yaml文件，添加hostAlias指定Pod的host记录，否则Pod会去根据DNS去解析www.chengzw.top（计算宿主机写了host记录也没用，我们这里内部要解析到nginx上，如果用DNS解析会解析到公网上）。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-cluster-agent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-system</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-cluster-agent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-cluster-agent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      affinity</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        nodeAffinity</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          requiredDuringSchedulingIgnoredDuringExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            nodeSelectorTerms</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">matchExpressions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">beta.kubernetes.io/os</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                  operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NotIn</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                  values</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">windows</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          preferredDuringSchedulingIgnoredDuringExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">weight</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            preference</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">              matchExpressions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">node-role.kubernetes.io/controlplane</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">In</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                values</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">weight</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            preference</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">              matchExpressions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">node-role.kubernetes.io/etcd</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">In</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">                values</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      serviceAccountName</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      tolerations</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">operator</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Exists</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      #为cattle-cluster-agent添加host记录</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      hostAliases</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;192.168.1.231&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        hostnames</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;www.chengzw.top&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluster-register</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          env</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_FEATURES</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_IS_RKE</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;false&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_SERVER</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;https://www.chengzw.top&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_CA_CHECKSUM</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_CLUSTER</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CATTLE_K8S_MANAGED</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rancher/rancher-agent:v2.5.3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-credentials</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/cattle-credentials</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            readOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          readinessProbe</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            initialDelaySeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            periodSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            httpGet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">              path</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/health</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">              port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">8080</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-credentials</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        secret</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          secretName</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cattle-credentials-049e86b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          defaultMode</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">320</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>我们这里使用的证书是在阿里云上申请的受信任的证书，如果是自签名证书需要注意要将ca证书导入rancher-agent：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #自签名证书需要添加ca.crt到cattle-cluster-agent内部</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rancher-certs</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/etc/kubernetes/ssl/certs/ca.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  subPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ca.crt</span></span></code></pre></div><h4 id="_4-4-访问rancher管理界面" tabindex="-1">4.4 访问Rancher管理界面 <a class="header-anchor" href="#_4-4-访问rancher管理界面" aria-label="Permalink to &quot;4.4 访问Rancher管理界面&quot;">​</a></h4><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Kubernetes/20210103152811.png" alt=""></p>`,84))])}const _=e(C,[["render",A]]);export{q as __pageData,_ as default};
