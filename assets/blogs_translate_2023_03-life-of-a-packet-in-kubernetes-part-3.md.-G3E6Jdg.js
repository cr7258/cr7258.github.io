import{_ as p}from"./chunks/ArticleMetadata.d4_nZKBO.js";import{_ as t,D as e,o as n,c as F,I as r,w as d,k as h,a as g,R as y,b as D,e as c}from"./chunks/framework.FHZ5yb6k.js";import"./chunks/md5.0oexlRJv.js";const w=JSON.parse('{"title":"Kubernetes 中数据包的生命周期 -- 第 3 部分","description":"","frontmatter":{"title":"Kubernetes 中数据包的生命周期 -- 第 3 部分","author":"Se7en","date":"2023/08/01 22:36","categories":["翻译"],"tags":["Kubernetes"]},"headers":[],"relativePath":"blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3.md","filePath":"blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3.md","lastUpdated":1707227798000}'),C={name:"blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3.md"},o=h("h1",{id:"kubernetes-中数据包的生命周期-第-3-部分",tabindex:"-1"},[g("Kubernetes 中数据包的生命周期 -- 第 3 部分 "),h("a",{class:"header-anchor",href:"#kubernetes-中数据包的生命周期-第-3-部分","aria-label":'Permalink to "Kubernetes 中数据包的生命周期 -- 第 3 部分"'},"​")],-1),A=y(`<blockquote><p>本文翻译自：<a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f" target="_blank" rel="noreferrer">Life of a Packet in Kubernetes — Part 3 [1]</a><br> 作者：Dinesh Kumar Ramasamy<br> 本文在原文的基础上做了适当的修改，如有疑问请查阅原文。</p></blockquote><p>本文是 Kubernetes 中数据包的生命周期系列文章的第 3 部分。我们将讨论 Kubernetes 的 <code>kube-proxy</code> 组件如何使用 <code>iptables</code> 来控制流量。 了解 <code>kube-proxy</code> 在 Kubernetes 环境中的作用以及它如何使用 <code>iptables</code> 来控制流量非常重要。</p><p>本文包含以下章节：</p><ul><li>1.Pod-to-Pod</li><li>2.Pod-to-External</li><li>3.Pod-to-Service</li><li>4.NodePort（External-to-Pod）</li><li>5.External Traffic Policy</li><li>6.Kube-Proxy</li><li>7.iptables 规则处理流程</li><li>8.Headless Service</li><li>9.Network Policy</li></ul><h2 id="_1-pod-to-pod" tabindex="-1">1 Pod-to-Pod <a class="header-anchor" href="#_1-pod-to-pod" aria-label="Permalink to &quot;1 Pod-to-Pod&quot;">​</a></h2><p><code>kube-proxy</code> 不会参与 Pod 之间的通信，因为 CNI 会为 Node 和 Pod 配置所需的路由。所有容器都可以在没有 NAT 的情况下与其他容器进行通信。所有节点都可以在没有 NAT 的情况下与容器通信（反之亦然）。</p><p>注意：Pod 的 IP 地址不是静态的（静态 IP 有多种配置方式，但默认配置不保证静态 IP 地址）。当 Pod 重启时，CNI 会为 Pod 分配一个新的 IP 地址，因为 CNI 不会维护 Pod 和 IP 地址之间的映射关系。另外，通过 Deployment 方式部署的 Pod 的名字也不是静态的。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220427202448.png" alt=""></p><p>实际上，通过 Deployment 部署的 Pod 应该使用负载均衡类型的实体来发布服务，因为应用程序是无状态的，并且通常会有多个 Pod 托管应用程序。负载均衡器类型的实体在 Kubernetes中称为 <strong>Service</strong>。</p><h2 id="_2-pod-to-external" tabindex="-1">2 Pod-to-external <a class="header-anchor" href="#_2-pod-to-external" aria-label="Permalink to &quot;2 Pod-to-external&quot;">​</a></h2><p>对于从 Pod 到外部地址的流量，Kubernetes 使用 SNAT（源地址转换）。它所做的是将 <strong>Pod IP:Port</strong> 替换为<strong>主机 IP:Port</strong>。当返回的数据包到主机时，主机会修改数据包中的目标 IP 和端口为 <strong>Pod IP:Port</strong>，并将数据包发回原始的 Pod。整个过程对原始 Pod 是透明的，Pod 并不知道发生了地址转换。</p><h2 id="_3-pod-to-service" tabindex="-1">3 Pod-to-Service <a class="header-anchor" href="#_3-pod-to-service" aria-label="Permalink to &quot;3 Pod-to-Service&quot;">​</a></h2><p>Kubernetes 中有一个叫做 <strong>Service</strong> 的概念，它是 Pod 前面的 L4 负载均衡器。在 Kubernetes 中有几种不同类型的 Service，最基本的类型称为 ClusterIP。这种类型的 Service 有一个唯一的 VIP 地址，只能在集群内部路由。</p><p>仅仅通过 Pod IP 将流量发送到特定的应用程序并不容易。Kubernetes 集群的动态特性意味着 Pod 可以被移动，重启，升级或者扩缩容。此外，一些服务会有很多副本，因此我们需要一些方法来平衡它们之间的负载。</p><p>Kubernetes 通过 Service 解决了这个问题。Service 是一个 API 对象，它将单个虚拟 IP（VIP）映射到一组 Pod IP。此外，Kubernetes 还为每个 Service 的 VIP 提供了 DNS 的解析条目，以便可以轻松通过域名来访问 Service。</p><p>集群内 VIP 到 Pod IP 的映射由每个节点上的 <code>kube-proxy</code> 进程协调。kube-proxy 通过设置 iptables 或者 IPVS 规则将目的地址是 Service VIP 的请求转换为 Pod IP。请求建立的连接会被追踪，因此数据包从 Pod 返回时可以正确地转换为 Service 的 VIP 再响应客户端。IPVS 和 iptables 可以将单个 Service 的 VIP 负载均衡到多个 Pod IP，IPVS 和 iptables 相比有着更好的性能和更灵活的负载均衡算法。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430155411.png" alt=""> 接下来创建 FrontEnd 和 Backend 两个 Deployment，并通过 ClusterIP 类型的 Service 作为负载均衡。</p><p><strong>FrontEnd Deployment:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span></code></pre></div><p><strong>Backend Deployment:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span></code></pre></div><p><strong>Service:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span></code></pre></div><p>现在 FrontEnd Pod 可以通过 ClusterIP 或者 Kubernetes 添加的 <strong>DNS</strong> 条目访问 Backend。一个集群感知的 DNS 服务器，例如 CoreDNS，监视 Kubernetes API 获取新创建的服务，并为每个服务创建一组 DNS 记录。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430160235.png" alt=""></p><blockquote><p>“普通“服务（除了无头服务）会以 <code>your-svc.your-namespace.svc.cluster.local</code> 这种名字的形式分配一个 DNS 记录。 该名称会解析成对应 Service 的 ClusterIP。</p></blockquote><h2 id="_4-nodeport-external-to-pod" tabindex="-1">4 NodePort（External-to-Pod） <a class="header-anchor" href="#_4-nodeport-external-to-pod" aria-label="Permalink to &quot;4 NodePort（External-to-Pod）&quot;">​</a></h2><p>现在我们可以在集群内部通过 VIP 或者域名访问 Service。<strong>然而，由于 VIP 是虚拟和私有的，此时外部请求还无法到达集群内的 Service</strong>。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430161334.png" alt=""></p><p>让我们创建一个 NodePort 类型的服务将 FrontEnd 服务暴露到集群外部。如果将 Service 的 <code>type</code> 字段设置为 <code>NodePort</code> 时，Kubernetes 会为该服务分配一个随机端口。端口的默认范围是 30000-32767，可以通过 API Server 的 <code>--service-node-port-range</code> 参数进行设置。每个节点会将访问 nodePort 端口（每个端口号相同）的请求代理到你的 Service。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NodePort</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 将 Service 设置为 NodePort 类型</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the \`targetPort\` is set to the same value as the \`port\` field.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # Optional field</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      nodePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">31380</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 指定端口</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430162259.png" alt=""></p><p>现在我们可以在集群外部通过 &lt;任何一个节点 IP&gt;:&lt;nodePort 端口&gt; 访问 FrontEnd Service 了。如果你需要指定特定的端口号，那么可以在 <code>nodePort</code> 字段中进行设置。这意味着你需要自己处理可能的端口冲突，同时你还必须使用一个有效的端口号，当设置的 nodePort 冲突或超过范围时，API Server 会返回错误信息。</p><h2 id="_5-external-traffic-policy" tabindex="-1">5 External Traffic Policy <a class="header-anchor" href="#_5-external-traffic-policy" aria-label="Permalink to &quot;5 External Traffic Policy&quot;">​</a></h2><p>ExternalTrafficPolicy 表示该 Service 是否希望将外部流量路由到节点本地或集群范围的端点。<strong>Local</strong> 表示保留客户端的源 IP，并且 NodePort 或者 LoadBalancer 类型的 Service 将不会把流量分发到其他节点上的 Pod，这样可以避免产生额外的网络跳数，与此同时可能会存在流量传播不平衡的风险。<strong>Cluster</strong> 隐藏了客户端的源 IP，并且可能会将流量分发到其他节点上的 Pod， 此时会产生额外的网络跳数，但这样会具有良好的整体负载均衡。</p><h3 id="_5-1-cluster-traffic-policy" tabindex="-1">5.1 Cluster Traffic Policy <a class="header-anchor" href="#_5-1-cluster-traffic-policy" aria-label="Permalink to &quot;5.1 Cluster Traffic Policy&quot;">​</a></h3><p>Cluster Traffic Policy 是 Kubernetes Service <strong>默认</strong>的 ExternalTrafficPolicy 策略。这里假设的是，你总是希望将流量平衡地路由到 Service 下的所有 Pod。</p><p>使用此策略的一个注意事项是，当外部流量访问 NodePort Service 时，你可能会在节点之间看到不必要的网络跃点。例如，当通过 NodePort 接收外部流量，NodePort Service 可能会（随机）将流量路由到另一台主机上的 Pod，而它本来可以将流量路由到同一主机上的 Pod，从而避免额外的网络跳数。</p><p><strong>Cluster</strong> Traffic Policy 中数据包的流量如下：</p><ul><li>客户端发送数据包到 <code>Node2:3138</code>。</li><li><code>Node2</code> 将数据包的目标 IP 通过 <strong>DNAT</strong>（目标地址）转换为 Pod IP。</li><li><code>Node2</code> 将数据包的源 IP 通过 <strong>SNAT</strong>（源地址转换）转换为 <code>Node2</code> 自身的 IP。</li><li>数据包路由到 Node1 或者 Node3，然后交给节点上的 Pod。</li><li>Pod 的响应回到 <code>Node2</code>，源 IP 是 Pod IP，目标 IP 是 <code>Node2</code> 的 IP。</li><li><code>Node2</code> 将 Pod 返回数据包的源 IP 修改为 <code>Node2</code> 的 IP，目标 IP 修改为客户端的 IP，然后响应客户端。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430164546.png" alt=""></p><h3 id="_5-2-local-traffic-policy" tabindex="-1">5.2 Local Traffic Policy <a class="header-anchor" href="#_5-2-local-traffic-policy" aria-label="Permalink to &quot;5.2 Local Traffic Policy&quot;">​</a></h3><p>当使用 Local Traffic Policy 策略时，kube-proxy 将仅为同一节点（本地）上的 Pod 添加代理规则，而不是为 Service 的每个 Pod 添加代理规则。此时 kube-proxy 只会将请求代理到本地端点，而不会将流量转发到其他节点。<strong>这样可以保留原始的源 IP 地址。</strong> 如果没有本地端点，则丢弃发送到节点的数据包。</p><p>如果你尝试在 Serivce 上设置 <code>externalTrafficPolicy: Local</code>，Kubernetes API 将要求你使用 LoadBalancer 或 NodePort 类型的 Service。这是因为 Local 模式的 ExternalTrafficPolicy 策略仅与外部流量相关，因此只适用于这两种类型的 Service。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NodePort</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  externalTrafficPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Local</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 仅转发到本地 Pod，保留客户端源 IP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the \`targetPort\` is set to the same value as the \`port\` field.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # Optional field</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      nodePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">31380</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p><strong>Local</strong> Traffic Policy 中数据包的流量如下：</p><ul><li>客户端发送数据包到 <code>Node1:31380</code>，该节点上有 FrontEnd 的 Pod。</li><li>Node1 将数据包路由到本地的 Pod，保留正确的源 IP。</li><li>由于设置了 Local 的转发策略，因此 Node1 不会将数据包路由到 Node3。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501193843.png" alt=""></p><ul><li>客户端发送数据包到 <code>Node2:31380</code>，该节点上没有 FrontEnd 的 Pod。</li><li>数据包将会被 Node2 丢弃。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501194355.png" alt=""></p><h3 id="_5-3-local-traffic-policy-in-loadbalancer-service-type" tabindex="-1">5.3 Local traffic policy in LoadBalancer Service type <a class="header-anchor" href="#_5-3-local-traffic-policy-in-loadbalancer-service-type" aria-label="Permalink to &quot;5.3 Local traffic policy in LoadBalancer Service type&quot;">​</a></h3><p>当你将公有云的 Kubernetes 服务（例如 Google Kubernetes Engine，GCE）中的 Service 设置为 <code>externalTrafficPolicy: Local</code> 时，如果节点中没有 Service 对应的 Pod，将不会通过负载均衡器（LB）的健康检查而被移出转发列表，在这种情况下不会发生数据包的丢弃。这种模式非常适合有大量的入访流量，同时希望避免网络上不必要的跃点以减少延迟的应用程序。同时我们还可以保留真正的客户端 IP，因为我们不再需要来自代理节点的 SNAT 流量！然而，正如 Kubernetes 文档中提到的，使用 Local traffic policy 策略的最大缺点是应用程序的流量可能不平衡。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501194522.png" alt=""></p><h2 id="_6-kube-proxy-iptable-mode" tabindex="-1">6 Kube-Proxy (iptable mode) <a class="header-anchor" href="#_6-kube-proxy-iptable-mode" aria-label="Permalink to &quot;6 Kube-Proxy (iptable mode)&quot;">​</a></h2><p>Kubernetes 中实现 Service 的组件称为 <strong>kube-proxy</strong>。它位于每个节点上，编写复杂的 iptables 规则以在 Pod 和 Service 之间进行各种过滤和 NAT。如果你到 Kubernetes 节点上执行 <code>iptables-save</code> 命令，你将能够看到 Kubernetes 或者其他程序插入的 iptables 规则。其中最重要的链是  <code>KUBE-SERVICES</code>, <code>KUBE-SVC-*</code> 和 <code>KUBE-SEP-*</code>。</p><ul><li><code>KUBE-SERVICES</code> 链是访问 Service 的入口，它的作用是匹配目标 IP:Port 并将数据包分发到相应的 <code>KUBE-SVC-*</code> 链。</li><li><code>KUBE-SVC-*</code> 链充当负载均衡器（Service），将数据包平均分配到 <code>KUBE-SEP-*</code> 链。每个 <code>KUBE-SVC-*</code> 链中含有与其后面端点数量相同的 <code>KUBE-SEP-*</code> 链。</li><li><code>KUBE-SEP-*</code> 链代表一个服务端点（Pod），它只做 DNAT，将 Service 的 IP:Port 替换为 Pod 的 IP:Port。</li></ul><p>对于 DNAT，conntrack 会跟踪连接状态，因为它需要记住修改的目标地址，以便数据包返回时将其更改回来。iptables 还可以依靠 conntrack 状态 (ctstate) 来决定数据包的命运。这 4 个 conntrack 状态尤其重要：</p><ul><li><strong>NEW</strong>：一个连接的初始状态（例如：TCP 连接中，一个 SYN 包的到来）。</li><li><strong>ESTABLISHED</strong>：连接已经建立完成。</li><li><strong>RELATED</strong>：这是一个关联连接，是一个主链接的子连接，例如 FTP 的数据通道的连接。</li><li><strong>INVALID</strong>：这是一个特殊的状态，用于记录那些没有按照预期行为进行的连接。</li></ul><p>以下是 Pod 和 Service 之间连接的工作方式，事件的顺序如下：</p><ul><li>左侧的客户端 Pod 向 Service 2.2.2.10:80 发送数据包。</li><li>数据包在客户端节点经过 iptables 规则，目的 IP 被更改为服务端 Pod IP（1.1.1.20:80）。</li><li>数据包返回客户端节点，conntrack 识别到数据包并将源地址重写回 2.2.2.2:80。</li><li>客户端 Pod 收到响应数据包。</li></ul><p><strong>GIF 动图演示：</strong></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/1_1u1d1WU1SqTiiJFyHO-X_A.gif" alt=""></p><h2 id="_7-iptables-规则处理流程" tabindex="-1">7 Iptables 规则处理流程 <a class="header-anchor" href="#_7-iptables-规则处理流程" aria-label="Permalink to &quot;7 Iptables 规则处理流程&quot;">​</a></h2><p><code>netfilter</code> 是 Linux 内核中一个对数据包进行控制、修改和过滤的框架。<code>iptables</code> 是配置 <code>netfilter</code> 过滤功能的用户空间工具。</p><h3 id="_7-1-chains-链" tabindex="-1">7.1 Chains 链 <a class="header-anchor" href="#_7-1-chains-链" aria-label="Permalink to &quot;7.1 Chains 链&quot;">​</a></h3><p>iptables 中有 5 条链，每条链负责一个特定的任务：</p><ul><li><strong>PREROUTING</strong>：在数据包做路由选择前应用此链路中的规则，所有的数据包进来时都先由这条链处理。</li><li><strong>INPUT</strong>：经过路由表判断后，目的为本机的数据包应用这条链上的策略。</li><li><strong>FORWARD</strong>：经过路由表判断后，目标地址不为本机，转发数据包时应用这条链上的策略。</li><li><strong>OUTPUT</strong>：由本机产生的往外发送的数据包应用这条链中的策略。</li><li><strong>POSTROUTING</strong>：数据包发送到网卡之前应用这条链中的策略，所有的数据包出来的时候都由这条链处理。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220503203749.png" alt=""></p><ul><li>进入的数据包目的是本机：<code>PREROUTING -&gt; INPUT</code>。</li><li>进入的数据包目的是其他主机：<code>PREROUTING -&gt; FORWARD -&gt; POSTROUTING</code>。</li><li>本机产生的数据包：<code>OUTPUT -&gt; POSTROUTING</code>。</li></ul><p><strong>FORWARD</strong> 链仅当 Linux 服务器中启用 <code>ip_forward</code> 时才有效，这就是以下命令在设置和调试 Kubernetes 集群时很重要的原因。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">node-1#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> net.ipv4.ip_forward=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">net.ipv4.ip_forward</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">node-1#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /proc/sys/net/ipv4/ip_forward</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1</span></span></code></pre></div><p>上述命令的修改不是永久的，要在 Linux 系统上永久启用 IP 转发，请编辑 <em>/etc/sysctl.conf</em> 并添加以下内容：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">net.ipv4.ip_forward</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span></code></pre></div><h3 id="_7-2-tables-表" tabindex="-1">7.2 Tables 表 <a class="header-anchor" href="#_7-2-tables-表" aria-label="Permalink to &quot;7.2 Tables 表&quot;">​</a></h3><p>iptables 中有 5 种表：</p><ul><li><strong>Filter</strong>：这是默认的表，用于过滤数据包。</li><li><strong>NAT</strong>：网络地址转换（端口映射、地址映射等）。</li><li><strong>Mangle</strong>：主要功能是根据规则修改数据包的一些标志位，以便其他规则或程序可以利用这些标志对数据包进行过滤或策略路由。</li><li><strong>Raw</strong>：设置 RAW 表时一般是为了不再让 iptables 做数据包的链接跟踪处理，以提高性能。</li><li><strong>Security</strong>：用于在数据包上设置内部 SELinux 安全上下文标记。</li></ul><h3 id="_7-3-kubernetes-中的-iptables-配置" tabindex="-1">7.3 Kubernetes 中的 iptables 配置 <a class="header-anchor" href="#_7-3-kubernetes-中的-iptables-配置" aria-label="Permalink to &quot;7.3 Kubernetes 中的 iptables 配置&quot;">​</a></h3><p>让我们在 Kubernetes 中部署一个副本数为 2 的 Nginx 应用程序并查看 iptables 规则。Service 类型：<strong>NodePort</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:31380/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d13h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get ep webapp </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ENDPOINTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.102:80,10.244.120.103:80</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d13h</span></span></code></pre></div><p>ClusterIP 在主机的接口上并不存在，它的虚拟 IP 存在于 iptables 规则中，在 CoreDNS 中添加了下面这个 DNS 条目。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -i -t dnsutils -- nslookup webapp.default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Server:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  10.96</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.96</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.10#53</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> webapp.default.svc.cluster.local</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span></span></code></pre></div><p>Kubernetes 在 iptables 中创建了 KUBE-SERVICES 链以便对数据包进行过滤和 NAT。它将会把所有 PREROUTING 和 OUTPUT 链的流量重定向到 KUBE-SERVICES 链上。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PREROUTING</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            PREROUTING</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (policy  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ACCEPT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                      </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cali-PREROUTING</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        cali:6gwbT8clXdHdC1b1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                 </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SERVICES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   portals</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DOCKER</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                  dst-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  LOCAL</span></span></code></pre></div><p>在将 KUBE-SERVICES 链用于包过滤和 NAT 后，Kubernetes 可以检查到 Service 的流量并相应地应用 SNAT/DNAT。在 KUBE-SERVICES 链的末端，它将插入另一个自定义链 KUBE-NODEPORTS 来处理 Service 类型是 NodePort 的流量。</p><p>如果流量是针对 ClusterIP 的，<strong>KUBE-SVC-2IRACUALRELARSND</strong> 链会处理流量；否则，下一条链将处理流量，即 <strong>KUBE-NODEPORTS</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SERVICES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-SERVICES</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (2   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   !10.244.0.0/16</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                   cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   dpt:www</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                          </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                   cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   dpt:www</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-NODEPORTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  nodeports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;  </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NOTE:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  this</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  must</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        be</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  last</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  rule</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  this</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dst-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  LOCAL</span></span></code></pre></div><p>让我们查看一下 <strong>KUBE-NODEPORTS</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)     </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                               </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dpt:31380</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dpt:31380</span></span></code></pre></div><p>可以看到 <strong>KUBE-NODEPORTS</strong> 链最终也会将流量送到 <strong>KUBE-SVC-2IRACUALRELARSND</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># statistic  mode  random -&gt; Random load-balancing between endpoints.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Service 的流量随机分发给两个 Pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (2   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Pod1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  statistic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  random</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  probability</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  0.50000000000</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Pod2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 流量分发到 Pod1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.102</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DNAT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  to:10.244.120.102:80</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 流量分发到 Pod2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">       </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DNAT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  to:10.244.120.103:80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 源地址转换</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-MARK-MASQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   KUBE-MARK-MASQ</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (24  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                         </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">MARK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     MARK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  or</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  0x4000</span></span></code></pre></div><p>总结一下： <strong>ClusterIP</strong>: KUBE-SERVICES → KUBE-SVC-XXX → KUBE-SEP-XXX。 <strong>NodePort</strong>: KUBE-SERVICES → KUBE-NODEPORTS → KUBE-SVC-XXX → KUBE-SEP-XXX。</p><p>注意：NodePort 类型的 Service 将分配一个 ClusterIP 来处理内部和外部流量。</p><p>上述规则的示意图如下：</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220503213518.png" alt=""><strong>ExtrenalTrafficPolicy: Local</strong> 如前所述，使用 externalTrafficPolicy: Local 将保留源 IP 并丢弃没有本地端点的数据包。让我们来看看没有本地端点的节点中的 iptables 规则。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get nodes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">minikube</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   6</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d1h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">minikube-m02</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   85</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    v1.19.2</span></span></code></pre></div><p>这次只部署 1 个 Nginx Pod，Service 设置为 externalTrafficPolicy: Local。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get pods nginx-deployment-7759cc5c66-p45tz -o wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                                READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       NOMINATED</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   READINESS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> GATES</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-deployment-7759cc5c66-p45tz</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.111</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   minikube</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><p>检查 externalTrafficPolicy。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp -o wide -o jsonpath={.spec.externalTrafficPolicy}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Local</span></span></code></pre></div><p>获取 Service。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp -o wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)        </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   SELECTOR</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.111</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.243.62</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:30080/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   app=webserver</span></span></code></pre></div><p>让我们检查 minikube-m02 节点中的 iptables 规则，<strong>应该有一个 DROP 规则来丢弃数据包，因为该节点上没有 Nginx Pod</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span></code></pre></div><p>检查 <strong>KUBE-XLB-2IRACUALRELARSND</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Redirect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pods</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> trying</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reach</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> external</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loadbalancer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> masquerade</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 丢弃没有本地端点的数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> no</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> endpoints</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span></code></pre></div><p>查看 minikube 节点的 iptables，该节点上有 Nginx Pod，因此不会丢弃数据包。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># NodePort 规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 不会丢弃数据包，最后没有 DROP 规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Redirect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pods</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> trying</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reach</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> external</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loadbalancer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> masquerade</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-5T4S2ILYSXWY3R2J</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Balancing</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rule</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Service 规则，将流量分发到 Pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (3 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-5T4S2ILYSXWY3R2J</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span></code></pre></div><h2 id="_8-headless-service" tabindex="-1">8 Headless Service <a class="header-anchor" href="#_8-headless-service" aria-label="Permalink to &quot;8 Headless Service&quot;">​</a></h2><p>有的应用并不需要负载均衡和服务 IP。在这种情况下就可以使用 Headless Service，只要设置 <code>.spec.clusterIP</code> 为 <code>None</code> 即可。</p><p>可以借助这种服务类型和其他服务发现机制协作，无需和 Kubernetes 绑定。Headless Service 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 另外，DNS 的配置要根据 selector 来确定。</p><p><strong>带选择器（selector）的服务</strong></p><p>定义了 selector 的 Headless Service，Endpoint 控制器会创建 Endpoints 记录， 并修改 DNS 记录，通过域名可以直接访问 <code>Service</code> 的后端 Pod 。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp-hs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp-hs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ClusterIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">         &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get ep webapp-hs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        ENDPOINTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                             AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp-hs</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.109:80,10.244.120.110:80</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   31</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span></code></pre></div><p><strong>无选择器的服务</strong></p><p>没有定义 selector 的 Headless Service，也就没有 Endpoint 记录。然而 DNS 系统会尝试配置：</p><ul><li><code>ExternalName</code> 类型的服务，会产生 <code>CNAME</code> 记录。</li><li>所有其他类型的服务，查找与 Service 名称相同的 <code>Endpoints</code> 的记录。</li></ul><h2 id="_9-network-policy" tabindex="-1">9 Network Policy <a class="header-anchor" href="#_9-network-policy" aria-label="Permalink to &quot;9 Network Policy&quot;">​</a></h2><p>到目前为止，你可能已经了解了 Kubernetes 中的网络策略是如何实现的。是的，又是 <strong>iptables</strong>；CNI 负责实施网络策略，而不是 <strong>kube-proxy</strong>。</p><p>让我们创建 3 个服务：FrontEnd, Backend 和 DB。默认情况下，Pod 是非隔离的；他们接受来自任何来源的流量。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220504172414.png" alt=""></p><p>但是，应该有一个网络策略将 DB pod 与 FrontEnd pod 隔离，以避免它们之间的任何流量。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220504173902.png" alt=""></p><p>我们可以通过设置 NetworkPolicy 来实现网络策略，如果入访的 Pod 带有 <code>networking/allow-db-access: &quot;true&quot;</code> 标签，则允许访问 DB。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 网络策略</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 匹配应用策略的 Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;db&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 匹配入访 Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          networking/allow-db-access</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Backend 服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        networking/allow-db-access</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 网络策略会允许有该标签的 Pod 访问 DB 服务</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        emptyDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/usr/share/nginx/html</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      initContainers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">install</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">busybox</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        command</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;sh&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;-c&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;echo $HOSTNAME &gt; /work-dir/index.html&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/work-dir&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>应用上面的 NetworkPolicy，可以看到 FrontEnd 可以正常访问 Backend，但是已经无法访问 DB 了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -it frontend-8b474f47-zdqdv -- /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl backend</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">backend-867fd6dff-mjf92</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl db</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">curl:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (7) Failed to connect to db port 80: Connection timed out</span></span></code></pre></div><p>但是 Backend 依然可以访问 DB。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -it backend-867fd6dff-mjf92 -- /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl db</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">db-8d66ff5f7-bp6kf</span></span></code></pre></div><p>如果使用的 CNI 是 Calico，Calico 会将 Kubernetes 的网络策略转换为 Calico 的格式。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # calicoctl get networkPolicy --output yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/v3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">items</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/v3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    creationTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;2020-11-05T05:26:27Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">knp.default.allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    resourceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/53872</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    uid</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">1b3eb093-b1a8-4429-a77d-a9a054a6ae90</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">action</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Allow</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      source</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/orchestrator == &#39;k8s&#39; &amp;&amp; networking/allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          == &#39;true&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    order</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/orchestrator == &#39;k8s&#39; &amp;&amp; app == &#39;db&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    types</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicyList</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  resourceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">56821/56821</span></span></code></pre></div><p>使用 calicoctl 获取工作负载端点的详细信息。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # calicoctl get workloadEndpoint</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">WORKLOAD</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                         NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       NETWORKS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        INTERFACE</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">         </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">backend-867fd6dff-mjf92</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.27/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali2b1490aa46a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">db-8d66ff5f7-bp6kf</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.26/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali95aa86cbb2a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">frontend-8b474f47-zdqdv</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.24/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali505cfbeac50</span></span></code></pre></div><p><strong>cali95aa86cbb2a</strong> 是 DB pod 正在使用的 veth 对的主机端。我们来获取这个接口相关的 iptables 规则。从 iptables 规则中，可以看到只有数据包来着 Backend Pod 时才允许进入 DB Pod。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Calico iptables 规则链命名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cali-: 前缀，calico 的规则链 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># tw: 简写，to wordkoad endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># wl: 简写，workload endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># fw: 简写，from workload endpoint </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># from-XXX: XXX发出的报文 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># to-XXX: 发送到XXX的报文 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pi: 简写，policy inbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># po: 简写，policy outbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pri: 简写，profile inbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pro: 简写，profile outbound </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables-save</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali95aa86cbb2a</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 先检查 fw: from workload 的规则，再检查 tw: to workload 的规则，下面以 tw 的规则进行说明</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第一步：如果 conntrack 表中能够检索到该连接的状态，可以直接根据状态放行或者丢弃</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:eCrqwxNk3cKw9Eq6&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> conntrack</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --ctstate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RELATED,ESTABLISHED</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ACCEPT</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:_krp5nzavhAu5avJ&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> conntrack</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --ctstate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> INVALID</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DROP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第二步：先对数据包进行标记，--set-xmark value[/mask]，value 表示要匹配的 mark 的值，mask 代表掩码，如果要完全匹配可以省略掉掩码</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 如果经过 Network Policy 后 mark 值没有修改，第七步会丢弃该数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:leBL64hpAXM9y4nk&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Start of policies&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MARK</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --set-xmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第三步（重点）：进入 cali-pi-_tTE-E7yY40ogArNVgKt 链进行 Network Policy 判断</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:pm-LK-c1ra31tRwz&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第六步：如果 Network Policy 检查通过（检查是否匹配 mark 0x10000/0x10000）, 匹配说明通过，直接 RETURN，不再检查其他的规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:q_zG8dAujKUIBe0Q&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Return if policy accepted&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RETURN</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第七步：如果 mark 没有修改，与原先一致，视为没有任何一个 Network Policy允许该包通过，丢弃数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:FUDVBYh1Yr6tVRgq&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Drop if no policies passed packet&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DROP</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Network Policy 规则判断</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables-save</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> filter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第四步（重点）：如果源 IP 匹配 ipsetali40s:LrVD8vMIGQDyv8Y7sPFB1Ge，将数据包添加 mark 0x10000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:M4Und37HGrw6jUk8&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --match-set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MARK</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --set-xmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第五步：检查是否匹配 mark，如果匹配就 RETURN 放行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:sEnlfZagUFRSPRoe&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RETURN</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>Calico 使用 ipset 进行流量管理，ipset 是 iptables 的扩展，有以下几个优点：</p><ul><li>允许在一条规则中根据多个 IP 地址和端口号进行匹配。</li><li>允许针对 IP 地址或者端口号动态更新 iptables 规则。</li><li>ipset 使用 set 集合作为存储结构，set 在查询时十分高效。</li></ul><p>通过检查 ipset，很明显看到只允许从 Backend Pod 的 IP 10.88.0.27 访问 DB Pod。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@minikube /]# ipset list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hash:net</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Revision:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 6</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Header:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> family</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hashsize</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1024</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> maxelem</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1048576</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Size</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> memory:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 408</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">References:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Number</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> entries:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Members:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">10.88.0.27</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><ul><li>[1] 原文: <a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f" target="_blank" rel="noreferrer">https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f</a></li><li>[2] iptables四表五链及规则组成: <a href="https://blog.csdn.net/wfs1994/article/details/89047230" target="_blank" rel="noreferrer">https://blog.csdn.net/wfs1994/article/details/89047230</a>)</li><li>[3] 使用 iptables、ipset 的全局智能代理: <a href="https://blog.chih.me/global-proxy-within-ipset-and-iptables.html" target="_blank" rel="noreferrer">https://blog.chih.me/global-proxy-within-ipset-and-iptables.html</a></li><li>[4] networkpolicy的实践--felix: <a href="https://segmentfault.com/a/1190000039030174" target="_blank" rel="noreferrer">https://segmentfault.com/a/1190000039030174</a></li><li>[5] calico iptables详解: <a href="https://blog.csdn.net/ptmozhu/article/details/73301971" target="_blank" rel="noreferrer">https://blog.csdn.net/ptmozhu/article/details/73301971</a></li><li>[6] iptables mark: <a href="https://www.kancloud.cn/pshizhsysu/linux/2084993" target="_blank" rel="noreferrer">https://www.kancloud.cn/pshizhsysu/linux/2084993</a></li></ul><h2 id="欢迎关注" tabindex="-1">欢迎关注 <a class="header-anchor" href="#欢迎关注" aria-label="Permalink to &quot;欢迎关注&quot;">​</a></h2><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220104221116.png" alt=""></p>`,142);function B(s,u,E,b,m,P){const l=p,k=e("ClientOnly");return n(),F("div",null,[o,r(k,null,{default:d(()=>{var i,a;return[(((i=s.$frontmatter)==null?void 0:i.aside)??!0)&&(((a=s.$frontmatter)==null?void 0:a.showArticleMetadata)??!0)?(n(),D(l,{key:0,article:s.$frontmatter},null,8,["article"])):c("",!0)]}),_:1}),A])}const N=t(C,[["render",B]]);export{w as __pageData,N as default};
