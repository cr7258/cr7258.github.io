import{_ as p}from"./chunks/ArticleMetadata.Et6qEObI.js";import{_ as k,C as r,c as d,o as t,k as l,G as c,P as g,a as F,w as o,b as y,e as C}from"./chunks/framework.BhFhJsV2.js";import"./chunks/md5.Ek22RXBH.js";const w=JSON.parse('{"title":"Cilium 多集群 Cluster Mesh 介绍","description":"","frontmatter":{"title":"Cilium 多集群 Cluster Mesh 介绍","author":"Se7en","date":"2023/01/08 22:00","categories":["原创"],"tags":["Cilium","Multi-Cluster"]},"headers":[],"relativePath":"blogs/original/2023/08-cilium-cluster-mesh.md","filePath":"blogs/original/2023/08-cilium-cluster-mesh.md","lastUpdated":1707227798000}'),u={name:"blogs/original/2023/08-cilium-cluster-mesh.md"};function D(i,s,m,b,A,B){const e=p,h=r("ClientOnly");return t(),d("div",null,[s[0]||(s[0]=l("h1",{id:"cilium-多集群-cluster-mesh-介绍",tabindex:"-1"},[F("Cilium 多集群 Cluster Mesh 介绍 "),l("a",{class:"header-anchor",href:"#cilium-多集群-cluster-mesh-介绍","aria-label":'Permalink to "Cilium 多集群 Cluster Mesh 介绍"'},"​")],-1)),c(h,null,{default:o(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(t(),y(e,{key:0,article:i.$frontmatter},null,8,["article"])):C("",!0)]}),_:1}),s[1]||(s[1]=g(`<p>Cluster Mesh 是 Cilium 的多集群实现，可以帮助 Cilium 实现跨数据中心、跨 VPC 的多 Kubernetes 集群管理，Cluster Mesh 主要有以下功能：</p><ul><li>1.通过隧道或直接路由的方式，在多个 Kubernetes 集群间进行 Pod IP 路由，而无需任何网关或代理。</li><li>2.使用标准 Kubernetes 服务发现机制。</li><li>3.跨多个集群的网络策略。策略可以使用 Kubernetes 原生的 NetworkPolicy 资源或者扩展的 CiliumNetworkPolicy CRD。</li><li>4.透明加密本集群以及跨集群节点间所有通信的流量。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511125746.png" alt=""></p><p>接下来让我们一起看看 Cilium Cluster Mesh 有哪些具体的使用场景。</p><h2 id="_1-使用场景" tabindex="-1">1 使用场景 <a class="header-anchor" href="#_1-使用场景" aria-label="Permalink to &quot;1 使用场景&quot;">​</a></h2><h3 id="_1-1-高可用" tabindex="-1">1.1 高可用 <a class="header-anchor" href="#_1-1-高可用" aria-label="Permalink to &quot;1.1 高可用&quot;">​</a></h3><p>对大多数人来说，高可用是最普遍的使用场景。可以在多个区域（regions）或可用区（availability zones）中运行多个 Kubernetes 集群，并在每个集群中运行相同服务的副本。 一旦发生异常，请求可以故障转移到其他集群。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511145843.png" alt=""></p><h3 id="_1-2-共享服务" tabindex="-1">1.2 共享服务 <a class="header-anchor" href="#_1-2-共享服务" aria-label="Permalink to &quot;1.2 共享服务&quot;">​</a></h3><p>某些公共基础服务可以在集群间进行共享（如密钥管理，日志记录，监控或 DNS 服务等），以避免额外的资源开销。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511145853.png" alt=""></p><h3 id="_1-3-拆分有状态和无状态服务" tabindex="-1">1.3 拆分有状态和无状态服务 <a class="header-anchor" href="#_1-3-拆分有状态和无状态服务" aria-label="Permalink to &quot;1.3 拆分有状态和无状态服务&quot;">​</a></h3><p>运行有状态或无状态服务的操作复杂性是非常不同的。无状态服务易于扩展，迁移和升级。 完全使用无状态服务运行集群可使集群保持灵活和敏捷。有状态服务（例如 MySQL，Elasticsearch, Etcd 等）可能会引入潜在的复杂依赖，迁移有状态服务通常涉及存储的迁移。为无状态和有状态服务分别运行独立的集群可以将依赖复杂性隔离到较少数量的集群中。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511145905.png" alt=""></p><h2 id="_2-架构" tabindex="-1">2 架构 <a class="header-anchor" href="#_2-架构" aria-label="Permalink to &quot;2 架构&quot;">​</a></h2><p>Cilium Cluster Mesh 的架构如下：</p><ul><li>每个 Kubernetes 集群都维护自己的 etcd 集群，保存自身集群的状态。来自多个集群的状态永远不会在本集群的 etcd 中混淆。</li><li>每个集群通过一组 <strong>etcd 代理</strong>暴露自己的 etcd，在其他集群中运行的 Cilium agent 连接到 etcd 代理以监视更改。</li><li>Cilium 使用 <strong>clustermesh-apiserver</strong> Pod 来建立多集群的互联，在 <strong>clustermesh-apiserver</strong> Pod 中有两个容器：其中 apiserver 容器负责将多集群的相关信息写入 etcd 容器；etcd 容器（etcd 代理）用来存储 Cluster Mesh 相关的配置信息。</li><li><strong>从一个集群到另一个集群的访问始终是只读的</strong>。这确保了故障域保持不变，即一个集群中的故障永远不会传播到其他集群。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511152250.png" alt=""></p><h2 id="_3-前提条件" tabindex="-1">3 前提条件 <a class="header-anchor" href="#_3-前提条件" aria-label="Permalink to &quot;3 前提条件&quot;">​</a></h2><h3 id="_3-1-安装相关软件" tabindex="-1">3.1 安装相关软件 <a class="header-anchor" href="#_3-1-安装相关软件" aria-label="Permalink to &quot;3.1 安装相关软件&quot;">​</a></h3><ul><li>安装 Kubectl：<a href="https://kubernetes.io/zh/docs/tasks/tools/" target="_blank" rel="noreferrer">https://kubernetes.io/zh/docs/tasks/tools/</a></li><li>安装 Kind：<a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation" target="_blank" rel="noreferrer">https://kind.sigs.k8s.io/docs/user/quick-start/#installation</a></li><li>安装 Helm：<a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noreferrer">https://helm.sh/docs/intro/install/</a></li><li>安装 Cilium Cli：<a href="https://github.com/cilium/cilium-cli" target="_blank" rel="noreferrer">https://github.com/cilium/cilium-cli</a></li></ul><p><a href="https://kind.sigs.k8s.io/" target="_blank" rel="noreferrer">Kind [1]</a>（Kubernetes in Docker） 是一个使用 Docker 容器运行本地 Kubernetes 集群的工具。为了方便实验，本文使用 Kind 来搭建 Kubernetes 多集群环境。</p><h3 id="_3-2-环境要求" tabindex="-1">3.2 环境要求 <a class="header-anchor" href="#_3-2-环境要求" aria-label="Permalink to &quot;3.2 环境要求&quot;">​</a></h3><ul><li>1.必须为所有 Kubernetes 的工作节点分配唯一的 IP 地址，并且节点之间 IP 路由可达。</li><li>2.每个集群都要分配唯一的 Pod CIDR。</li><li>3.Cilium 必须使用 etcd 作为 kv 存储。</li><li>4.集群之间的网络必须互通，具体的通信的端口号参见<a href="https://docs.cilium.io/en/stable/operations/system_requirements/#firewall-requirements" target="_blank" rel="noreferrer">防火墙规则 [2]</a>。</li></ul><p>本实验相关的配置文件可以在: <a href="https://github.com/cr7258/kubernetes-guide/tree/master/cilium/cluster_mesh" target="_blank" rel="noreferrer">cluster_mesh [3]</a> 获取。</p><h2 id="_4-准备-kubernetes-环境" tabindex="-1">4 准备 Kubernetes 环境 <a class="header-anchor" href="#_4-准备-kubernetes-环境" aria-label="Permalink to &quot;4 准备 Kubernetes 环境&quot;">​</a></h2><p>准备两个 Kind 配置文件用于搭建 Kubernetes 集群。</p><p>c1 集群配置文件。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># kind-config1.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Cluster</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kind.x-k8s.io/v1alpha4</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">nodes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">control-plane</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">worker</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">networking</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  disableDefaultCNI</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 禁用默认的 CNI</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  podSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;10.10.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  serviceSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;10.11.0.0/16&quot;</span></span></code></pre></div><p>c2 集群 配置文件。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># kind-config2.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Cluster</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kind.x-k8s.io/v1alpha4</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">nodes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">control-plane</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">worker</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">networking</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  disableDefaultCNI</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 禁用默认的 CNI</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  podSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;10.20.0.0/16&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  serviceSubnet</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;10.21.0.0/16&quot;</span></span></code></pre></div><p>使用 <code>kind create cluster</code> 命令创建两个 Kubernetes 集群。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kind</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-config1.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kind</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --config</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-config2.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509092022.png" alt=""></p><p>查看两个 Kubernetes 集群。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> wide</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509091440.png" alt=""></p><h2 id="_5-安装-cilium" tabindex="-1">5 安装 Cilium <a class="header-anchor" href="#_5-安装-cilium" aria-label="Permalink to &quot;5 安装 Cilium&quot;">​</a></h2><p>添加 Helm Repo。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://helm.cilium.io/</span></span></code></pre></div><p>在c1 集群上安装 Cilium，使用 <code>--kube-context</code> 参数指定不同的集群上下文。必须为每个集群分配一个唯一的名称和集群 id，<code>cluster.id</code> 参数指定集群 id，范围 1-255，<code>cluster.name</code> 参数指定集群名称。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1.11</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ipam.mode=kubernetes</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster.id=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster.name=cluster1</span></span></code></pre></div><p>在 c2 集群上安装 Cilium。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium/cilium</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --version</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1.11</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.4</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ipam.mode=kubernetes</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster.id=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster.name=cluster2</span></span></code></pre></div><p>查看 Cilium Pod 状态。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509095905.png" alt=""></p><p>查看 Cilium 状态。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509181156.png" alt=""></p><h2 id="_6-安装-metallb-可选" tabindex="-1">6 安装 Metallb（可选） <a class="header-anchor" href="#_6-安装-metallb-可选" aria-label="Permalink to &quot;6 安装 Metallb（可选）&quot;">​</a></h2><p>在 <strong>7 启用 Cluster Mesh</strong> 章节中会介绍发布 <strong>clustermesh-apiserver</strong> 服务使用的 Service 类型，建议使用 LoadBalancer 类型的 Service，这样可以保证提供一个稳定且唯一的 LoadBalancer IP。在公有云提供的 Kubernetes 集群中，LoadBalancer 类型的 Service 通常会通过公有云的负载均衡设备（例如 AWS 的 ELB，阿里云的 SLB 等）来发布。在私有环境中可以使用 <a href="https://metallb.universe.tf/" target="_blank" rel="noreferrer">MetalLB [4]</a> 实现。</p><p>准备两个集群的 Metallb 配置文件。 c1 集群配置文件。注意分配的网络要和节点 IP 在同一网段。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># metallb-config1.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">configInline</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  peers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  address-pools</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">layer2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">172.22.0.50-172.22.0.100</span></span></code></pre></div><p>c2 集群配置文件。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">configInline</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  peers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  address-pools</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">layer2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">172.22.0.101-172.22.0.150</span></span></code></pre></div><p>使用以下命令在 c1 和 c2 集群中部署 Metallb。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bitnami</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://charts.bitnami.com/bitnami</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> metallb</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bitnami/metallb</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> metallb-config1.yaml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">helm</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --kube-context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> metallb</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bitnami/metallb</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  --namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> metallb-config2.yaml</span></span></code></pre></div><p>查看 Metallb Pod 状态。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509114032.png" alt=""></p><h2 id="_7-启用-cluster-mesh" tabindex="-1">7 启用 Cluster Mesh <a class="header-anchor" href="#_7-启用-cluster-mesh" aria-label="Permalink to &quot;7 启用 Cluster Mesh&quot;">​</a></h2><p>使用 <code>cilium clustermesh enable</code> 命令在 c1 集群上启用 Cluster Mesh：</p><ul><li><code>--create-ca</code> 参数表示自动创建 CA 证书，该证书需要在集群之间共享，以确保跨集群的 mTLS 能够正常工作。</li><li><code>--service-type</code> 参数指定发布 <strong>clustermesh-apiserver</strong> 服务的方式，有以下 3 种方式： <ul><li><strong>LoadBalancer</strong>（推荐）: 使用 LoadBalancer 类型的 Service 发布服务，这样可以使用稳定的 LoadBalancer IP，通常是最佳选择。</li><li><strong>NodePort</strong>: 使用 NodePort 类型的 Service 发布服务，如果一个节点消失，Cluster Mesh 将不得不重新连接到另一个节点，可能会造成网络的中断。</li><li><strong>ClusterIP</strong>: 使用 ClusterIP 类型的 Service 发布服务，这要求 ClusterIP 在集群间是可路由的。</li></ul></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --create-ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --service-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LoadBalancer</span></span></code></pre></div><p>执行命令后会在集群中部署 clustermesh-apiserver 服务，并生成相关必要的证书。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509114525.png" alt=""></p><p>创建的 CA 保存在 <code>kube-system</code> Namespace 下的 cilium-ca Secret 中。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">$ kubectl --context kind-c1 get secret -n kube-system cilium-ca -o yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ca.crt</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNFekNDQWJxZ0F3SUJBZ0lVZmVPNHlYbVZSSU1ZZVppSjZyODJ6L05FejBVd0NnWUlLb1pJemowRUF3SXcKYURFTE1Ba0dBMVVFQmhNQ1ZWTXhGakFVQmdOVkJBZ1REVk5oYmlCR2NtRnVZMmx6WTI4eEN6QUpCZ05WQkFjVApBa05CTVE4d0RRWURWUVFLRXdaRGFXeHBkVzB4RHpBTkJnTlZCQXNUQmtOcGJHbDFiVEVTTUJBR0ExVUVBeE1KClEybHNhWFZ0SUVOQk1CNFhEVEl5TURVd09UQXpNemt3TUZvWERUSTNNRFV3T0RBek16a3dNRm93YURFTE1Ba0cKQTFVRUJoTUNWVk14RmpBVUJnTlZCQWdURFZOaGJpQkdjbUZ1WTJselkyOHhDekFKQmdOVkJBY1RBa05CTVE4dwpEUVlEVlFRS0V3WkRhV3hwZFcweER6QU5CZ05WQkFzVEJrTnBiR2wxYlRFU01CQUdBMVVFQXhNSlEybHNhWFZ0CklFTkJNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVTQVNHRERDdnhsUmpYNTEwMEpCQnoxdXIKb29sMktUNVh6MUNYS1paVk5Pc1M5ZmVrOEJUOTRqTXpZcHpsZW5hZXdwczVDZGhWckkvSU9mK2RtaTR3UjZOQwpNRUF3RGdZRFZSMFBBUUgvQkFRREFnRUdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGTlVwCjBBRVROZ0JHd2ZEK0paRDFWV2w2elNvVk1Bb0dDQ3FHU000OUJBTUNBMGNBTUVRQ0lHZUszUklreUJzQnFxL0MKdzRFTU9nMjk1T244WDFyYVM5QVZMZmlzS2JJVEFpQW5Da3NQTm9BYmZVZ1lyMkVGaFZZaDU0bjlZMVlyU0NlZAprOEZ3Nnl2MWNBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ca.key</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU9uWG9WTmhIdEJ0TTFaMFFlTWE5UWlLV1QvdXVNMk9jUXNmU252bXEwL2RvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFU0FTR0REQ3Z4bFJqWDUxMDBKQkJ6MXVyb29sMktUNVh6MUNYS1paVk5Pc1M5ZmVrOEJUOQo0ak16WXB6bGVuYWV3cHM1Q2RoVnJJL0lPZitkbWk0d1J3PT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  creationTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;2022-05-09T03:44:03Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cilium-ca</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kube-system</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  resourceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;20625&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  uid</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">7e4b2f21-815d-4191-974b-316c629e325c</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Opaque</span></span></code></pre></div><p>将 c1 集群的 Cilium CA 证书导入集群 c2。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 将 c1 集群的 Cilium CA 证书导出</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> secret</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium-ca</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> yaml</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium-ca.yaml</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 将 CA 证书导入 c2 集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cilium-ca.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p>在 c2 集群上启用 Cluster Mesh。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --service-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LoadBalancer</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509115004.png" alt=""></p><p>查看 c1 和 c2 集群的 clustermesh-apiserver Pod 状态。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509120827.png" alt=""></p><p>查看 c1 和 c2 集群的 clustermesh-apiserver Service，可以看到 Servie 的类型是 LoadBalancer，这是 Metallb 分配的 IP 地址。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220511162335.png" alt=""></p><p>查看 Cilium 状态。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509181041.png" alt=""></p><p>查看 c1 和 c2 集群的 Cluster Mesh 状态，当前两个集群都已经成功启用 Cluster Mesh，但是还未互相连接。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509115212.png" alt=""></p><h2 id="_8-连接集群" tabindex="-1">8 连接集群 <a class="header-anchor" href="#_8-连接集群" aria-label="Permalink to &quot;8 连接集群&quot;">​</a></h2><p>在 c1 集群上执行 <code>cilium clustermesh connect</code> 命令连接 c2 集群。只需要在一个集群上执行即可。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> connect</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --destination-context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509115353.png" alt=""></p><p>查看 Cilium Cluster Mesh 状态，此时 c1 和 c1 集群已经建立了 Cluster Mesh 连接。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509120942.png" alt=""></p><p>现在我们已经成功建立了集群间的互联，接下来验证一下 Cluster Mesh 模式下的负载均衡和网络策略。</p><h2 id="_9-负载均衡" tabindex="-1">9 负载均衡 <a class="header-anchor" href="#_9-负载均衡" aria-label="Permalink to &quot;9 负载均衡&quot;">​</a></h2><h3 id="_9-1-全局负载均衡" tabindex="-1">9.1 全局负载均衡 <a class="header-anchor" href="#_9-1-全局负载均衡" aria-label="Permalink to &quot;9.1 全局负载均衡&quot;">​</a></h3><p>在集群中部署两个应用，其中 x-wing 是客户端，rebel-base 是服务端，要求对 rebel-base 服务实现全局负载均衡。需要保证每个集群中的 rebel-base 服务名称相同并且在相同的命名空间中，然后添加 <code>io.cilium/global-service: &quot;true&quot;</code> 声明为全局服务，这样 Cilium 便会自动对两个集群中的 Pod 执行负载均衡。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rebel-base</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    io.cilium/global-service</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 启用全局负载均衡</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rebel-bas</span></span></code></pre></div><p>在 c1 和 c2 集群创建应用服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster1.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster2.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span></span></code></pre></div><p>查看服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509122013.png" alt=""> 在任意一个集群访问 rebel-base 服务，可以看到流量被分发到了两个集群。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1..10}</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment/x-wing</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509142925.png" alt=""></p><h3 id="_9-2-禁用全局服务共享" tabindex="-1">9.2 禁用全局服务共享 <a class="header-anchor" href="#_9-2-禁用全局服务共享" aria-label="Permalink to &quot;9.2 禁用全局服务共享&quot;">​</a></h3><p>默认情况下，全局服务将在多个集群中的后端进行负载均衡。如果想要禁止本集群的服务被共享给其他集群，可以设置 <code>io.cilium/shared-service: &quot;false&quot;</code> 注解来实现。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">io.cilium/shared-service=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;false&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --overwrite</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span></code></pre></div><p>在 c1 集群可以访问到两个集群的 rebel-base 服务。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1..10}</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment/x-wing</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509143238.png" alt=""></p><p>但是此时 c2 集群就只能访问到本集群的 rebel-base 服务了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1..10}</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment/x-wing</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509143731.png" alt=""></p><p>将 c1 集群 rebel-base 服务的注解 <code>io.cilium/shared-service</code> 去掉。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> annotate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> io.cilium/shared-service-</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span></code></pre></div><p>现在 c2 集群可以重新访问两个集群的 rebel-base 服务了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1..10}</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment/x-wing</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509143921.png" alt=""></p><h2 id="_10-网络策略" tabindex="-1">10 网络策略 <a class="header-anchor" href="#_10-网络策略" aria-label="Permalink to &quot;10 网络策略&quot;">​</a></h2><p>创建 CiliumNetworkPolicy 策略只允许 c1 集群中带有 x-wing 标签的 Pod 访问 c2 集群中带有 rebel-base 标签的 Pod。集群名字是在 <strong>5 安装 Cilium</strong>章节中通过 <code>--cluster-name</code> 参数指定的，也可以在 <strong>cilium-config</strong> Configmap 中找到。除了应用服务之间的流量，还需注意放行 DNS 的流量，否则无法直接通过 Service 名字进行访问。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># networkpolicy.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cilium.io/v2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CiliumNetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;allow-dns&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  endpointSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  egress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">toEndpoints</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            io.kubernetes.pod.namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kube-system</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            k8s-app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">kube-dns</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      toPorts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;53&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">              protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">UDP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          rules</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">            dns</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">matchPattern</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;*&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;cilium.io/v2&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">CiliumNetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;allow-cross-cluster&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  description</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;Allow x-wing in cluster1 to contact rebel-base in cluster2&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  endpointSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">x-wing</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      io.cilium.k8s.policy.cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluster1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  egress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">toEndpoints</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rebel-base</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        io.cilium.k8s.policy.cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluster2</span></span></code></pre></div><p>Kubernetes 的网络策略不会自动发布到所有集群，你需要在每个集群上下发 <code>NetworkPolicy</code> 或 <code>CiliumNetworkPolicy</code>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> networkpolicy.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> networkpolicy.yaml</span></span></code></pre></div><p>在 c1 集群上访问 rebel-base 服务，可以看到只有分发到 c2 集群上的请求才可以成功得到响应。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ti</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment/x-wing</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rebel-base</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509145613.png" alt=""></p><h2 id="_11-troubleshooting" tabindex="-1">11 Troubleshooting <a class="header-anchor" href="#_11-troubleshooting" aria-label="Permalink to &quot;11 Troubleshooting&quot;">​</a></h2><p>在启用 Cluster Mesh 的时候遇到以下报错。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cilium</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> status</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509120001.png" alt=""></p><p>查看 Pod 信息发现拉取的镜像不存在。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> describe</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  clustermesh-apiserver-754c5479dd-zsg8t</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509120223.png" alt=""></p><p>到 Cilium 镜像仓库上看了下发现镜像后面的 sha256 值对不上。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509120320.png" alt=""></p><p>编辑 clustermesh-apiserver Deployment 的镜像，将镜像版本后面的 shasum 值去掉即可。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> edit</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh-apiserver</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> edit</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kind-c2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clustermesh-apiserver</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220509175220.png" alt=""></p><h2 id="_12-参考资料" tabindex="-1">12 参考资料 <a class="header-anchor" href="#_12-参考资料" aria-label="Permalink to &quot;12 参考资料&quot;">​</a></h2><ul><li>[1] Kind: <a href="https://kind.sigs.k8s.io/" target="_blank" rel="noreferrer">https://kind.sigs.k8s.io/</a></li><li>[2] 防火墙规则: <a href="https://docs.cilium.io/en/stable/operations/system_requirements/#firewall-requirements" target="_blank" rel="noreferrer">https://docs.cilium.io/en/stable/operations/system_requirements/#firewall-requirements</a></li><li>[3] cluster_mesh: <a href="https://github.com/cr7258/kubernetes-guide/tree/master/cilium/cluster_mesh" target="_blank" rel="noreferrer">https://github.com/cr7258/kubernetes-guide/tree/master/cilium/cluster_mesh</a></li><li>[4] MetalLB: <a href="https://metallb.universe.tf/" target="_blank" rel="noreferrer">https://metallb.universe.tf/</a></li><li>[5] 深入了解Cilium多集群: <a href="https://cloudnative.to/blog/deep-dive-into-cilium-multi-cluster/" target="_blank" rel="noreferrer">https://cloudnative.to/blog/deep-dive-into-cilium-multi-cluster/</a></li><li>[6] API server for Cilium ClusterMesh: <a href="https://github.com/cilium/cilium/tree/master/clustermesh-apiserver" target="_blank" rel="noreferrer">https://github.com/cilium/cilium/tree/master/clustermesh-apiserver</a></li><li>[7] Setting up Cluster Mesh: <a href="https://docs.cilium.io/en/stable/gettingstarted/clustermesh/clustermesh/#gs-clustermesh" target="_blank" rel="noreferrer">https://docs.cilium.io/en/stable/gettingstarted/clustermesh/clustermesh/#gs-clustermesh</a></li><li>[8] BurlyLuo/clustermesh: <a href="https://github.com/BurlyLuo/clustermesh" target="_blank" rel="noreferrer">https://github.com/BurlyLuo/clustermesh</a></li><li>[9] eCHO Episode 41: Cilium Clustermesh: <a href="https://www.youtube.com/watch?v=VBOONHW65NU&amp;t=2653s" target="_blank" rel="noreferrer">https://www.youtube.com/watch?v=VBOONHW65NU&amp;t=2653s</a></li><li>[10] Deep Dive into Cilium Multi-cluster: <a href="https://cilium.io/blog/2019/03/12/clustermesh" target="_blank" rel="noreferrer">https://cilium.io/blog/2019/03/12/clustermesh</a></li><li>[11] Multi Cluster Networking with Cilium and Friends: <a href="https://cilium.io/blog/2022/04/12/cilium-multi-cluster-networking" target="_blank" rel="noreferrer">https://cilium.io/blog/2022/04/12/cilium-multi-cluster-networking</a></li><li>[12] Kubernetes Multi-Cluster Networking -Cilium Cluster Mesh: <a href="https://itnext.io/kubernetes-multi-cluster-networking-cilium-cluster-mesh-bca0f5367d84" target="_blank" rel="noreferrer">https://itnext.io/kubernetes-multi-cluster-networking-cilium-cluster-mesh-bca0f5367d84</a></li><li>[13] A multi-cluster shared services architecture with Amazon EKS using Cilium ClusterMesh: <a href="https://aws.amazon.com/cn/blogs/containers/a-multi-cluster-shared-services-architecture-with-amazon-eks-using-cilium-clustermesh/" target="_blank" rel="noreferrer">https://aws.amazon.com/cn/blogs/containers/a-multi-cluster-shared-services-architecture-with-amazon-eks-using-cilium-clustermesh/</a></li></ul><h2 id="_13-欢迎关注" tabindex="-1">13 欢迎关注 <a class="header-anchor" href="#_13-欢迎关注" aria-label="Permalink to &quot;13 欢迎关注&quot;">​</a></h2><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220104221116.png" alt=""></p>`,141))])}const x=k(u,[["render",D]]);export{w as __pageData,x as default};
