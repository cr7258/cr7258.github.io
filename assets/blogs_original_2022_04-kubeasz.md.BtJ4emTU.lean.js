import{_ as p}from"./chunks/ArticleMetadata.BGfgJEkN.js";import{_ as e,C as F,c as d,o as h,k as t,G as r,P as g,a as y,w as c,b as D,e as o}from"./chunks/framework.hsaHFr3N.js";import"./chunks/md5.Csn9Gkkw.js";const f=JSON.parse('{"title":"使用 ezctl 工具部署和管理 Kubernetes 集群","description":"","frontmatter":{"title":"使用 ezctl 工具部署和管理 Kubernetes 集群","author":"Se7en","date":"2022/04/03 20:00","categories":["原创"],"tags":["Kubernetes"]},"headers":[],"relativePath":"blogs/original/2022/04-kubeasz.md","filePath":"blogs/original/2022/04-kubeasz.md","lastUpdated":1707227798000}'),C={name:"blogs/original/2022/04-kubeasz.md"};function u(i,s,b,m,A,v){const l=p,k=F("ClientOnly");return h(),d("div",null,[s[0]||(s[0]=t("h1",{id:"使用-ezctl-工具部署和管理-kubernetes-集群",tabindex:"-1"},[y("使用 ezctl 工具部署和管理 Kubernetes 集群 "),t("a",{class:"header-anchor",href:"#使用-ezctl-工具部署和管理-kubernetes-集群","aria-label":'Permalink to "使用 ezctl 工具部署和管理 Kubernetes 集群"'},"​")],-1)),r(k,null,{default:c(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(h(),D(l,{key:0,article:i.$frontmatter},null,8,["article"])):o("",!0)]}),_:1}),s[1]||(s[1]=g(`<h2 id="_1-ezctl-命令行介绍" tabindex="-1">1 ezctl 命令行介绍 <a class="header-anchor" href="#_1-ezctl-命令行介绍" aria-label="Permalink to &quot;1 ezctl 命令行介绍&quot;">​</a></h2><p>kubeasz 项目致力于快速部署高可用的 Kubernetes 集群，同时也提供了关于 Kubernetes 详细的学习资料，在这里强烈推荐给初学者。kubeasz 项目地址：<a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noreferrer">https://github.com/easzlab/kubeasz</a> 。</p><p>kubeasz 项目使用 ezctl 方便地创建和管理多个 Kubernetes 集群，ezctl 使用 shell 脚本封装 ansible-playbook 执行命令，它十分轻量、简单和易于扩展。查看 ezctl 工具的命令行提示信息，如下所示：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Usage:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> COMMAND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [args]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-------------------------------------------------------------------------------------</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setups:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    list</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">		                     to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> managed</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clusters</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    checkout</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> switch</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeconfig</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    new</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">         &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> new</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deploy</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;cluster&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    setup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">       &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> also</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> supporting</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> step-by-step</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> way</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    start</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">       &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> services</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> stopped</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> by</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;ezctl stop&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    stop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> services</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> temporarily</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    upgrade</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> upgrade</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    destroy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destroy</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    backup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (etcd </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">snapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    restore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> restore</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> state</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> backups</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    start-aio</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">		                 to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> quickly</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> an</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all-in-one</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> with</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;default&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> settings</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ops:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    add-etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    add-master</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    add-node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> work</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    del-etcd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd-node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    del-master</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    del-node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> work</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Extra</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> operation:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    kcfg-adm</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cluste</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">arg</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> manage</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeconfig</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Use</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;ezctl help &lt;command&gt;&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> more</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> information</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> about</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> given</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> command.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   命令集</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">：集群安装相关操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   显示当前所有管理的集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   切换默认集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   创建新集群配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   安装新集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   启动临时停止的集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   临时停止某个集群（包括集群内运行的</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   升级集群</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 组件版本</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   删除集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   备份集群（仅</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 数据，不包括</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pv</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 数据和业务应用数据）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   从备份中恢复集群</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   创建单机集群（类似</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> minikube）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   命令集</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">：集群节点操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   增加</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   增加主节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   增加工作节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   删除</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> etcd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> 节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   删除主节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   删除工作节点</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   命令集3：额外操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   管理客户端</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubeconfig</span></span></code></pre></div><h2 id="_2-单机-all-in-one-快速部署-kubernetes-环境" tabindex="-1">2 单机 All in One 快速部署 Kubernetes 环境 <a class="header-anchor" href="#_2-单机-all-in-one-快速部署-kubernetes-环境" aria-label="Permalink to &quot;2 单机 All in One 快速部署 Kubernetes 环境&quot;">​</a></h2><p>首先介绍一下如何在单机环境上快速部署一个单节点的 Kubernetes 集群，在国内环境下比官方的 minikube 方便、简单很多。</p><h3 id="_2-1-基础系统配置" tabindex="-1">2.1 基础系统配置 <a class="header-anchor" href="#_2-1-基础系统配置" aria-label="Permalink to &quot;2.1 基础系统配置&quot;">​</a></h3><ul><li>准备一台虚机配置内存 2G，硬盘 30G 以上。</li><li>最小化安装<code>Ubuntu 16.04 server</code>或者<code>CentOS 7 Minimal</code>。</li></ul><p><strong>注意:</strong> 确保在干净的系统上开始安装，不要使用曾经装过 kubeadm 或其他 Kubernetes 发行版的环境。</p><h3 id="_2-2-下载文件" tabindex="-1">2.2 下载文件 <a class="header-anchor" href="#_2-2-下载文件" aria-label="Permalink to &quot;2.2 下载文件&quot;">​</a></h3><p>下载工具脚本 ezdown，例如使用最新的 kubeasz 版本 3.1.1。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> release</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3.1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://github.com/easzlab/kubeasz/releases/download/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${release}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/ezdown</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">chmod</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> +x</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ./ezdown</span></span></code></pre></div><p>下载安装部署 Kubernetes 需要的依赖和镜像。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezdown</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -D</span></span></code></pre></div><p>下载系统包（可选，当无法使用 yum/apt 在线安装系统包时可以使用）</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezdown</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -P</span></span></code></pre></div><p>上述脚本运行成功后，所有文件（kubeasz 代码、二进制、离线镜像）均已整理好放入目录 <code>/etc/kubeasz</code>。</p><ul><li><code>/etc/kubeasz</code> 包含 kubeasz 版本为 \${release} 的发布代码。</li><li><code>/etc/kubeasz/bin</code> 包含 kubernetes/etcd/docker/cni 等二进制文件。</li><li><code>/etc/kubeasz/down</code> 包含集群安装时需要的离线容器镜像。</li><li><code>/etc/kubeasz/down/packages</code> 包含集群安装时需要的系统基础软件。</li></ul><h3 id="_2-3-安装集群" tabindex="-1">2.3 安装集群 <a class="header-anchor" href="#_2-3-安装集群" aria-label="Permalink to &quot;2.3 安装集群&quot;">​</a></h3><p>运行 kubeasz 容器，在 kubeasz 容器中封装了 ezctl 和 ansible。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezdown</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -S</span></span></code></pre></div><p>使用默认配置安装 aio(All in One) 集群。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>docker exec -it kubeasz ezctl start-aio</span></span></code></pre></div><p>接下来 kubeasz 会使用 ansible playbook 来部署 Kubernetes，运行完毕后如下图所示。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211213130452.png" alt=""></p><h3 id="_2-4-验证安装" tabindex="-1">2.4 验证安装 <a class="header-anchor" href="#_2-4-验证安装" aria-label="Permalink to &quot;2.4 验证安装&quot;">​</a></h3><p>如果提示 <code>kubectl: command not found</code>，退出重新 ssh 登录一下，让环境变量生效即可。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> version</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">         # 验证集群版本 </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> node</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">        # 验证节点就绪 (Ready) 状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # 验证集群 pod 状态，默认已安装网络插件、coredns、metrics-server 等</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -A</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # 验证集群服务状态</span></span></code></pre></div><h3 id="_2-5-登录-dashboard" tabindex="-1">2.5 登录 Dashboard <a class="header-anchor" href="#_2-5-登录-dashboard" aria-label="Permalink to &quot;2.5 登录 Dashboard&quot;">​</a></h3><p>默认情况下，Kubernetes Dashboard 已经使用 NodePort 类型的 Service 发布服务了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dashboard</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">dashboard-metrics-scraper</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.53.35</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        8000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                 10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubernetes-dashboard</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.181.208</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        443</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:31538/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span></code></pre></div><p>在 Kubernetes 集群外部通过 https://&lt;节点 IP&gt;:&lt;NodePort 端口&gt; 访问 Dashboard。我们选择使用 Token 方式登录 Dashboard，使用以下命令获取 Token。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 获取 Bearer Token，找到输出中 ‘token:’ 开头的后面部分</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> describe</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> secret</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kube-system get secret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> admin-user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;{print $1}&#39;)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">         admin-user-token-4mj2j</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Namespace:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    kube-system</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Labels:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">       &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Annotations:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  kubernetes.io/service-account.name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> admin-user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">              kubernetes.io/service-account.uid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 86</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">a705ae-50be-4523-8ccb-ceaa0e2bc224</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  kubernetes.io/service-account-token</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">====</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">token:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      eyJhbGciOiJSUzI1NiIsImtpZCI6InlMTng0WTE5NUh3UTg0ZVZ5U1pqTjN6RWZjOHZjT25DRXZmRmdBWjNPQ0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTRtajJqIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4NmE3MDVhZS01MGJlLTQ1MjMtOGNjYi1jZWFhMGUyYmMyMjQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.QHOOBISVRqvdKCbt53-tK2wa9FF3vxvWI4bZLlThhNScqP77q6g3wINVa7f4FGomi7uyuvnU4Hsgdzvey9k_FFg5qtpfR4Rzk8i9GcN7N9-FJFZ9w5yXjbftd0hSQynnySQDD_T2hDdID07LJX_fIbSlNhiRtf-FJVD0LyNxVPgdF9XQ8D_Liqs2IQMhWYD6fVb5QNlm98wzFP8B6RD_X7iMW_CFjyKyxOG7-20cm733ilcumQA8qXty1iTcO4WHasJzFLH7Ovd7Ds-9vcgYiJESPvn9oQV8cilJ5DDhTd9tkPxvYP0aYXDpH3ipjOrPONbBjzjbJ7wFItVOjWAr4A</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ca.crt:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1350</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">namespace:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  11</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> bytes</span></span></code></pre></div><p>粘贴 Token，点击登录。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211213132600.png" alt=""></p><p>登录成功后的页面如下图所示。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211213132933.png" alt=""></p><h3 id="_2-6-清理现场" tabindex="-1">2.6 清理现场 <a class="header-anchor" href="#_2-6-清理现场" aria-label="Permalink to &quot;2.6 清理现场&quot;">​</a></h3><p>在宿主机上，按照如下步骤清理</p><ul><li>清理集群 <code>docker exec -it kubeasz ezctl destroy default</code>。</li><li>清理运行的容器 <code>./ezdown -C</code>。</li><li>清理容器镜像 <code>docker system prune -a</code>。</li><li>停止 docker 服务 <code>systemctl stop docker</code>。</li><li>使用以下命令删除 docker 文件。</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span> umount /var/run/docker/netns/default</span></span>
<span class="line"><span> umount /var/lib/docker/overlay</span></span>
<span class="line"><span> rm -rf /var/lib/docker /var/run/docker</span></span></code></pre></div><p>上述清理脚本执行成功后，建议重启节点，以确保清理残留的虚拟网卡、路由等信息。</p><h2 id="_3-部署多套-kubernetes-集群" tabindex="-1">3 部署多套 Kubernetes 集群 <a class="header-anchor" href="#_3-部署多套-kubernetes-集群" aria-label="Permalink to &quot;3 部署多套 Kubernetes 集群&quot;">​</a></h2><p>使用一台单独的机器作为 ezctl 的部署节点，ezctl 节点需要能够免密登录部署 Kubernetes 的机器，并且在 ezctl 节点上安装好 ansible（或者直接使用 kubeasz 容器）。 <img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211214205711.png" alt=""></p><h3 id="_3-1-机器规划" tabindex="-1">3.1 机器规划 <a class="header-anchor" href="#_3-1-机器规划" aria-label="Permalink to &quot;3.1 机器规划&quot;">​</a></h3><table><thead><tr><th>主机名</th><th>IP 地址</th><th>角色</th><th>集群</th></tr></thead><tbody><tr><td>cluster01-1</td><td>11.8.36.159</td><td>master</td><td>集群 1</td></tr><tr><td>cluster01-2</td><td>11.8.36.161</td><td>worker</td><td>集群 1</td></tr><tr><td>cluster01-3</td><td>11.8.36.160</td><td>worker</td><td>集群 1</td></tr><tr><td>cluster02-1</td><td>11.8.36.162</td><td>master</td><td>集群 2</td></tr><tr><td>cluster02-2</td><td>11.8.36.163</td><td>worker</td><td>集群 2</td></tr><tr><td>cluster02-3</td><td>11.8.38.148</td><td>worker</td><td>集群 2</td></tr><tr><td>ansible01</td><td>11.8.36.21</td><td>ezctl 节点</td><td></td></tr></tbody></table><h3 id="_3-2-配置免密登录" tabindex="-1">3.2 配置免密登录 <a class="header-anchor" href="#_3-2-配置免密登录" aria-label="Permalink to &quot;3.2 配置免密登录&quot;">​</a></h3><p>在 ansible01 机器上配置对 Kubernetes 节点的免密登录。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 生产公私钥对</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-keygen</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 拷贝公钥到其他机器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.36.159</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.36.161</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.36.160</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.36.162</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.36.163</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root@11.8.38.148</span></span></code></pre></div><h3 id="_3-3-创建配置文件" tabindex="-1">3.3 创建配置文件 <a class="header-anchor" href="#_3-3-创建配置文件" aria-label="Permalink to &quot;3.3 创建配置文件&quot;">​</a></h3><p>使用以下命令生成 Kubernetes 集群的配置文件，在 <code>/etc/kubeasz/clusters/&lt;集群名&gt;</code> 目录下会生产 hosts 和 config.yml 两个配置文件。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cluster01 是自己取的集群名</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> new</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span></span></code></pre></div><p>修改 hosts 配置文件，设置相关节点角色的 IP 地址，其他配置可以保持默认。config.yml 配置文件可以保持默认。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cluster01 主机信息</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># &#39;etcd&#39; cluster should have odd member(s) (1,3,5,...)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[etcd]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.159</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.161</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.160</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># master node(s)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kube_master]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.159</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># work node(s)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[kube_node]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.161</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.160</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 设置网络插件为 calico (可选)，默认是 flannel </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">CLUSTER_NETWORK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> &quot;calico&quot;</span></span></code></pre></div><h3 id="_3-4-安装集群" tabindex="-1">3.4 安装集群 <a class="header-anchor" href="#_3-4-安装集群" aria-label="Permalink to &quot;3.4 安装集群&quot;">​</a></h3><p>使用以下命令安装 Kubernetes 集群。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 一键安装</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 或者分步安装，具体使用 ezctl help setup 查看分步安装帮助信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 01</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 02</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 03</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 04</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>重复步骤 3.3 创建配置文件和 3.4 安装集群创建 cluster02 集群。</p><h3 id="_3-5-查看集群状态" tabindex="-1">3.5 查看集群状态 <a class="header-anchor" href="#_3-5-查看集群状态" aria-label="Permalink to &quot;3.5 查看集群状态&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cluster01 状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">root@cluster01-1:/root</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #kubectl get node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.159</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   91</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.160</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     90</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.161</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     90</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cluster02 状态</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">root@cluster02-1:/root</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #kubectl get node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.162</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m43s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.36.163</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m56s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">11.8.38.148</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      node</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m56s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.22.2</span></span></code></pre></div><h2 id="_4-备份和恢复-etcd" tabindex="-1">4 备份和恢复 Etcd <a class="header-anchor" href="#_4-备份和恢复-etcd" aria-label="Permalink to &quot;4 备份和恢复 Etcd&quot;">​</a></h2><p>Kubernetes 使用 Etcd 数据库来存储集群中的数据，Etcd 备份的是某一时刻 Kubernetes 集群中的完整状态。接下来将分别介绍 Etcd 的备份与恢复：</p><ul><li>从运行的 Etcd 集群备份数据到磁盘文件。</li><li>从 Etcd 备份文件恢复数据，从而使集群恢复到备份时状态。</li></ul><p>首先在已经搭建好的 Kubernetes 集群中部署两个测试 deployment。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nginx-a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --image=nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nginx-b</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --image=nginx</span></span></code></pre></div><p>查看 deployment 和 pod 运行状态。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployments.apps</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           34</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-b</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           30</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-a-76865cf8c8-w4mqf</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-b-6bcf96755c-wwgs4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          25</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span></code></pre></div><h3 id="_4-1-备份数据" tabindex="-1">4.1 备份数据 <a class="header-anchor" href="#_4-1-备份数据" aria-label="Permalink to &quot;4.1 备份数据&quot;">​</a></h3><p>接下来使用 <code>ezctl backup</code> 命令对集群 cluster01 的 Etcd 进行备份，在备份的时候 Kubernetes 集群中的服务不受影响。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> backup</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span></span></code></pre></div><p>执行完毕可以在部署 ezctl 主机的 <code> /etc/kubeasz/clusters/&lt;集群名&gt;/backup/</code>目录下检查备份情况，其中，snapshot.db 始终为最近一次备份文件，还有一个带有时间戳的文件表示具体的备份版本，因为我们当前只有一次备份，因此这两个备份文件的内容是一样的。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/kubeasz/clusters/cluster01/backup/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 6160</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-rw-------</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3149856</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 14</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:28</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> snapshot_202112141328.db</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-rw-------</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3149856</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Dec</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 14</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 13</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> snapshot.db</span></span></code></pre></div><p>现在我们假装误删除 deployment nginx-a。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployments.apps</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nginx-a</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 查看当前的 deployment，现在只剩下 nginx-b</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployments.apps</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-b</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           10</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span></code></pre></div><h3 id="_4-2-恢复数据" tabindex="-1">4.2 恢复数据 <a class="header-anchor" href="#_4-2-恢复数据" aria-label="Permalink to &quot;4.2 恢复数据&quot;">​</a></h3><p>然后使用 <code>ezctl restore</code> 命令来恢复 Etcd 的备份数据，默认情况下是恢复最近一次的备份文件 snapshot.db，如果需要指定恢复的版本，可以在 <code>roles/cluster-restore/defaults/main.yml</code> 文件中配置需要恢复的 Etcd 备份版本。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> restore</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cluster01</span></span></code></pre></div><p>在恢复的时候会停止 kube-apiserver，kube-controller-manager, kube-scheduler, kubelet, etcd 等服务，待 Etcd 恢复完毕后，再重启启动服务。 查看恢复后的 deployment 和 pod，可以看到现在 nginx-a deployment 已经恢复。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> deployments.apps</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           14</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-b</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           14</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-a-76865cf8c8-w4mqf</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          15</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-b-6bcf96755c-wwgs4</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          14</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span></span></code></pre></div><h2 id="_5-参考资料" tabindex="-1">5 参考资料 <a class="header-anchor" href="#_5-参考资料" aria-label="Permalink to &quot;5 参考资料&quot;">​</a></h2><ul><li><a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noreferrer">kubeasz github 项目地址</a></li><li><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noreferrer">Deploy a Production Ready Kubernetes Cluster</a></li><li><a href="https://cloud.tencent.com/developer/article/1564975" target="_blank" rel="noreferrer">Ansible for k8s</a></li><li><a href="http://www.xuyasong.com/?p=2052" target="_blank" rel="noreferrer">K8S 集群备份与恢复</a></li><li><a href="http://www.mydlq.club/article/74/" target="_blank" rel="noreferrer">Kubernetes Etcd 数据备份与恢复</a></li><li><a href="https://mp.weixin.qq.com/s/4b2COdr5q4SFfJTy3wl8gA" target="_blank" rel="noreferrer">通过备份 Etcd 来完美恢复 Kubernetes 中的误删数据</a></li></ul>`,81))])}const _=e(C,[["render",u]]);export{f as __pageData,_ as default};
