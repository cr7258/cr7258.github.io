import{_ as e}from"./chunks/ArticleMetadata.Cxlq8Gj7.js";import{_ as k,C as r,c as F,o as t,k as l,G as d,P as g,a as c,w as o,b as y,e as D}from"./chunks/framework.DIkCQIk8.js";import"./chunks/md5.BFEskVOY.js";const E=JSON.parse('{"title":"ArgoCD 简明教程","description":"","frontmatter":{"title":"ArgoCD 简明教程","author":"Se7en","date":"2023/11/01 22:36","categories":["原创"],"tags":["ArgoCD","DevOps"]},"headers":[],"relativePath":"blogs/original/2023/01-argocd-quickstart.md","filePath":"blogs/original/2023/01-argocd-quickstart.md","lastUpdated":1707227798000}'),C={name:"blogs/original/2023/01-argocd-quickstart.md"};function A(i,s,m,u,b,v){const p=e,h=r("ClientOnly");return t(),F("div",null,[s[0]||(s[0]=l("h1",{id:"argocd-简明教程",tabindex:"-1"},[c("ArgoCD 简明教程 "),l("a",{class:"header-anchor",href:"#argocd-简明教程","aria-label":'Permalink to "ArgoCD 简明教程"'},"​")],-1)),d(h,null,{default:o(()=>{var a,n;return[(((a=i.$frontmatter)==null?void 0:a.aside)??!0)&&(((n=i.$frontmatter)==null?void 0:n.showArticleMetadata)??!0)?(t(),y(p,{key:0,article:i.$frontmatter},null,8,["article"])):D("",!0)]}),_:1}),s[1]||(s[1]=g(`<h2 id="_1-argo-cd-简介" tabindex="-1">1 Argo CD 简介 <a class="header-anchor" href="#_1-argo-cd-简介" aria-label="Permalink to &quot;1 Argo CD 简介&quot;">​</a></h2><p>Argo CD 是一个为 Kubernetes 而生的，遵循声明式 GitOps 理念的持续部署（CD）工具，它的配置和使用非常简单，并且自带一个简单易用的 Dashboard 页面，并且支持多种配置管理/模板工具（例如 Kustomize、Helm、Ksonnet、Jsonnet、plain-YAML）。 Argo CD 被实现为一个 Kubernetes 控制器，它持续监控正在运行的应用程序并将当前的实时状态与所需的目标状态（例如 Git 仓库中的配置）进行比较，在 Git 仓库更改时自动同步和部署应用程序。</p><h2 id="_2-架构图" tabindex="-1">2 架构图 <a class="header-anchor" href="#_2-架构图" aria-label="Permalink to &quot;2 架构图&quot;">​</a></h2><p><code>Argo CD</code> 在 CI/CD 流程中的位置如下图所示，Argo CD 的主要职责是 CD（Continuous Delivery，持续交付），将应用部署到 Kubernetes 等环境中，而 CI（Continuous Integration，持续集成）主要是交给 Jenkins，Gitlab CI 等工具来完成。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211219161612.png" alt=""></p><p>这里简单介绍一下 <code>GitOps</code> 的概念，GitOps 这个词出现于 2017 年，是由 <code>Weaveworks</code> 公司根据多年云计算基础设施和应用程序管理经验而提出的一个概念，它是一种进行 Kubernetes 集群管理和应用程序交付的方式，GitOps 使用 Git 作为声明性基础设施和应用程序的单一事实来源。</p><p>GitOps 的核心思想是拥有一个 Git 仓库，包含目标环境中当前所需基础设施的<strong>声明性</strong>描述，以及使目标环境与 Git 仓库中描述的状态相匹配的自动化过程，Argo CD 就是一个遵循了 GitOps 理念的持续部署（CD）工具。</p><p>在 GitOps 模式的 CI/CD 流水线包含以下几个流程：</p><ul><li>1.将应用的 Git 仓库分为 Application Deployment file 和 Docker file 两个库。 Docker file 用于存放应用的核心代码以及 Docker build file，后续将会直接打包成 Docker image；Application Deployment file 可以 Kustomize、Helm、Ksconnet、Jsonnet 等多种 Kubernetes 包管理工具来定义；以 Helm 为例，Chart 中所使用到的 Image 由 Docker file Code 打包完成后提供。</li><li>2.使用 Jenkins 或 Gitlab 等 CI 工具进行自动化构建打包，并将 Docker image push 到 Harbor 镜像仓库。</li><li>3.使用 Argo CD 部署应用。Argo CD 可以独立于集群之外，并且支持管理多个 Kubernetes 集群。在 Argo CD 上配置好应用部署的相关信息后 Argo CD 便可以正常工作，Argo CD 会自动和代码仓库 Application deployment file 的内容进行校验，当代码仓库中应用属性等信息发生变化时，Argo CD 会自动同步更新 Kubernetes 集群中的应用；应用启动时，会从 Harbor 镜像仓库拉取 Docker image。</li></ul><p>本文主要介绍第 3 部分 Argo CD 部署应用，关于 GitOps 的完整实践后续会发文进行介绍。</p><h2 id="_3-快速开始" tabindex="-1">3 快速开始 <a class="header-anchor" href="#_3-快速开始" aria-label="Permalink to &quot;3 快速开始&quot;">​</a></h2><h3 id="_3-1-前提条件" tabindex="-1">3.1 前提条件 <a class="header-anchor" href="#_3-1-前提条件" aria-label="Permalink to &quot;3.1 前提条件&quot;">​</a></h3><ul><li>1.准备好一套 Kubernetes 集群，参见 <a href="https://mp.weixin.qq.com/s/8T1nc3N2f7TsZFErNZF2Wg" target="_blank" rel="noreferrer">使用 ezctl 工具部署和管理 Kubernetes 集群</a>。</li><li>2.搭建好 Gitlab 代码仓库，参见 <a href="https://about.gitlab.cn/install/" target="_blank" rel="noreferrer">Gitlab 安装指南</a>。</li></ul><h3 id="_3-2-安装-argo-cd" tabindex="-1">3.2 安装 Argo CD <a class="header-anchor" href="#_3-2-安装-argo-cd" aria-label="Permalink to &quot;3.2 安装 Argo CD&quot;">​</a></h3><p>使用以下命令在 argocd 命名空间部署 Argo CD。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 创建命名空间</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 部署 argo cd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">wget</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install.yaml</span></span></code></pre></div><h3 id="_3-3-安装-argo-cd-cli" tabindex="-1">3.3 安装 Argo CD CLI <a class="header-anchor" href="#_3-3-安装-argo-cd-cli" aria-label="Permalink to &quot;3.3 安装 Argo CD CLI&quot;">​</a></h3><p>Argo CD CLI 是用于管理 Argo CD 的命令行工具，不同操作系统具体的安装方式可以参考 <a href="https://argo-cd.readthedocs.io/en/stable/cli_installation/" target="_blank" rel="noreferrer">Argo CD CLI Installation</a></p><p>Mac 系统可以直接使用 brew install 进行安装。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">brew</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span></span></code></pre></div><h3 id="_3-4-发布-argo-cd-服务" tabindex="-1">3.4 发布 Argo CD 服务 <a class="header-anchor" href="#_3-4-发布-argo-cd-服务" aria-label="Permalink to &quot;3.4 发布 Argo CD 服务&quot;">​</a></h3><p>默认情况下， Argo CD 服务不对外暴露服务，可以通过 LoadBalancer 或者 NodePort 类型的 Service、Ingress、Kubectl 端口转发等方式将 Argo CD 服务发布到 Kubernetes 集群外部。</p><p>这里使用以下命令通过 NodePort 服务的方式暴露 Argo CD 到集群外部。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> patch</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;}}&#39;</span></span></code></pre></div><p>现在我们已经将名字为 argocd-server 的 Service 改成 NodePort 类型了，可以在集群外部通过 &lt;节点 IP&gt;:&lt;随机生成的 NodePort 端口&gt; 来访问 Argo CD，我这里随机生成的 NodePort 端口是 32313。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> svc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                    TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                      </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-dex-server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.51.140</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        5556</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP,5557/TCP,5558/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m11s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-metrics</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.76.255</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        8082</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                     5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m11s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-redis</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.223.131</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        6379</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                     5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m11s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-repo-server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.1.35</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        8081</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP,8084/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m11s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.49.24</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">     &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:30582/TCP,443:32313/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m11s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd-server-metrics</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ClusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.107.188</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        8083</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                     5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m10s</span></span></code></pre></div><p>浏览器输入 https://&lt;节点 IP&gt;:32313 访问 Argo CD。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211212173942.png" alt=""></p><h3 id="_3-5-获取-argo-cd-密码" tabindex="-1">3.5 获取 Argo CD 密码 <a class="header-anchor" href="#_3-5-获取-argo-cd-密码" aria-label="Permalink to &quot;3.5 获取 Argo CD 密码&quot;">​</a></h3><p>默认情况下 <code>admin</code> 帐号的初始密码是自动生成的，会以明文的形式存储在 Argo CD 安装的命名空间中名为 <code>argocd-initial-admin-secret</code> 的 Secret 对象下的 <code>password</code> 字段下，我们可以用下面的命令来获取：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> secret</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">argocd-initial-admin-secret </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">-o </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">jsonpath=&quot;{.data.password}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 返回结果</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kj8bDMiDTnsEfnjg</span></span></code></pre></div><p>在浏览器输入密码登录 Argo CD。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211212174737.png" alt=""></p><p>登录后的界面如下所示。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211212174808.png" alt=""></p><p>命令行可以使用以下方式登录。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">❯</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> login</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">节点</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> I</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">P</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:32313</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 接收证书风险</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">WARNING:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> server</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> had</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> error:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> x509:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cannot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> validate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 11.8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.38.43</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> because</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> it</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> doesn&#39;t contain any IP SANs. Proceed insecurely (y/n)? y</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Username:  # 输入用户名</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Password: # 输入密码</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;admin:login&#39; logged in successfully</span></span></code></pre></div><h3 id="_3-6-准备-git-仓库" tabindex="-1">3.6 准备 Git 仓库 <a class="header-anchor" href="#_3-6-准备-git-仓库" aria-label="Permalink to &quot;3.6 准备 Git 仓库&quot;">​</a></h3><p>在 Gitlab 上创建项目，取名为 argocd-lab，为了方便实验将仓库设置为 public 公共仓库。在仓库中创建 quickstart 目录，在目录中创建两个 yaml 资源文件，分别是 myapp-deployment.yaml 和 myapp-service.yaml。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/Xnip2021-12-19_18-20-01.png" alt=""></p><p>yaml 资源文件内容如下：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># myapp-deployment.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">apiVersion:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> apps/v1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Deployment</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  replicas:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">      app:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  template:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">      labels:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        app:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> image:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> registry.cn-shanghai.aliyuncs.com/public-namespace/myapp:v1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        ports:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">        -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> containerPort:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># myapp-service.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">apiVersion:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> v1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kind:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">spec:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  -</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> port:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    targetPort:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    nodePort:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 32060</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NodePort</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    app:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span></code></pre></div><p>实验所需的镜像我已经在阿里云的镜像仓库中准备好了，大家可以直接使用。</p><h3 id="_3-7-创建-argo-cd-app" tabindex="-1">3.7 创建 Argo CD App <a class="header-anchor" href="#_3-7-创建-argo-cd-app" aria-label="Permalink to &quot;3.7 创建 Argo CD App&quot;">​</a></h3><p>首先创建一个命名空间 devops 用于 Argo CD 部署应用。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ns</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> devops</span></span></code></pre></div><h4 id="_3-7-1-方式一-使用-ui-创建-app" tabindex="-1">3.7.1 方式一：使用 UI 创建 App <a class="header-anchor" href="#_3-7-1-方式一-使用-ui-创建-app" aria-label="Permalink to &quot;3.7.1 方式一：使用 UI 创建 App&quot;">​</a></h4><ul><li>Application Name: 自定义的应用名。</li><li>Project: 使用默认创建好的 default 项目。</li><li>SYNC POLICY： 同步方式，可以选择自动或者手动，这里我们选择手动同步。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218192900.png" alt=""></p><ul><li>Repository URL: 项目的 Git 地址。</li><li>Revision: 分支名。</li><li>Path: yaml 资源文件所在的相对路径。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218193803.png" alt=""></p><ul><li>Cluster URL: Kubernetes API Server 的访问地址，由于 Argo CD 和下发应用的 Kubernetes 集群是同一个，因此可以直接使用 <a href="https://kubernetes.default.svc" target="_blank" rel="noreferrer">https://kubernetes.default.svc</a> 来访问。关于 Kubernetes 中 DNS 解析规则可以查看 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noreferrer">Pod 与 Service 的 DNS</a>。</li><li>Namespace: 部署应用的命名空间。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218193347.png" alt=""></p><p>创建完成后如下图所示，此时处于 OutOfSync 的状态：</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218193842.png" alt=""></p><p>由于我设置的是手动同步，因此需要点一下下面的 SYNC 进行同步。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218193921.png" alt=""></p><p>在弹出框点击 SYNCHRONIZE，确认同步。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218193945.png" alt=""></p><p>等待同步完成。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218194139.png" alt=""></p><p>在 Argo CD 上点击应用进入查看详情。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218194201.png" alt=""></p><p>在 Kubernetes 查看部署的资源。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">root@cluster01-1:/root</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> #kubectl get all -n devops </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                         READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pod/myapp-865f9f464f-qpjbc</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m25s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)        </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">service/myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.68</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.93.5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:32060/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m25s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                    READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   UP-TO-DATE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AVAILABLE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">deployment.apps/myapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">     1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">           2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m25s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                               DESIRED</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   CURRENT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">replicaset.apps/myapp-865f9f464f</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">       2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m25s</span></span></code></pre></div><p>在集群外部通过 <code>&lt;节点 IP&gt;:&lt;NodePort&gt;</code> 端口访问 myapp 程序，可以看到此时是 v1 版本。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218194557.png" alt=""></p><h4 id="_3-7-2-方式二-使用-cli-创建-app" tabindex="-1">3.7.2 方式二：使用 CLI 创建 APP <a class="header-anchor" href="#_3-7-2-方式二-使用-cli-创建-app" aria-label="Permalink to &quot;3.7.2 方式二：使用 CLI 创建 APP&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">argocd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> app</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp2</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">--repo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">http://11.8.36.29/root/argocd-lab.git</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">--path </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">quickstart</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --dest-server</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">https://kubernetes.default.svc </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">--dest-namespace </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">devops</span></span></code></pre></div><p>使用 argocd 命令查看创建的应用。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 列出应用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">❯</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> app</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   CLUSTER</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                         NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  PROJECT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  HEALTH</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   SYNCPOLICY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  CONDITIONS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  REPO</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                                   PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        TARGET</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  https://kubernetes.default.svc</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  devops</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Synced</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Healthy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">      &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      http://11.8.36.29/root/argocd-lab.git</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  quickstart</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 查看 myapp 应用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">❯</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> argocd</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> app</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Project:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Server:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             https://kubernetes.default.svc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Namespace:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          devops</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">URL:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                https://11.8.36.159:32313/applications/myapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Repo:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               http://11.8.36.29/root/argocd-lab.git</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Target:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             main</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Path:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               quickstart</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">SyncWindow:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">         Sync</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Allowed</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Sync</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Policy:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Sync</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Status:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        Synced</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (82baed1)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Health</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Status:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      Healthy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">GROUP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  KIND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  HEALTH</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   HOOK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  MESSAGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">       Service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     devops</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Synced</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Healthy</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        service/myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">apps</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Deployment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  devops</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Synced</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  Healthy</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        deployment.apps/myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> created</span></span></code></pre></div><h4 id="_3-7-3-方式三-使用-yaml-文件创建" tabindex="-1">3.7.3 方式三：使用 YAML 文件创建 <a class="header-anchor" href="#_3-7-3-方式三-使用-yaml-文件创建" aria-label="Permalink to &quot;3.7.3 方式三：使用 YAML 文件创建&quot;">​</a></h4><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">argoproj.io/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Application</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">myapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">argocd</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">devops</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 部署应用的命名空间</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">https://kubernetes.default.svc</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # API Server 地址</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  project</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">default</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 项目名</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  source</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    path</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">quickstart</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 资源文件路径</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    repoURL</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">http://11.8.36.29/root/argocd-lab.git</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # Git 仓库地址</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    targetRevision</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">main</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 分支名</span></span></code></pre></div><h3 id="_3-8-版本升级" tabindex="-1">3.8 版本升级 <a class="header-anchor" href="#_3-8-版本升级" aria-label="Permalink to &quot;3.8 版本升级&quot;">​</a></h3><p>这次我们将 myapp 应用从手动同步改成自动同步。点击 APP DETAILS -&gt; SYNC POLICY，点击 ENABLE AUTO-SYNC。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218195602.png" alt=""> 编辑 myapp 资源文件，将版本从 v1 改为 v2，点击 Commit changes，提交更改。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218195345.png" alt=""></p><p>等待一会 Argo CD 会自动更新应用，如果你等不及可以点击 Refresh，Argo CD 会去立即获取最新的资源文件。可以看到此时 myapp Deployment 会新创建 v2 版本的 Replicaset，v2 版本的 Replicaset 会创建并管理 v2 版本的 Pod。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218200227.png" alt=""></p><p>在集群外部通过 <code>&lt;节点 IP&gt;:&lt;NodePort&gt;</code> 端口访问 myapp 程序，可以看到此时是 v2 版本。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218201117.png" alt=""></p><h3 id="_3-9-版本回滚" tabindex="-1">3.9 版本回滚 <a class="header-anchor" href="#_3-9-版本回滚" aria-label="Permalink to &quot;3.9 版本回滚&quot;">​</a></h3><p>细心的同学应该会发现升级到 v2 版本以后， v1 版本的 Replicaset 并没有被删除，而是继续保留，这是为了方便我们回滚应用。在 myapp 应用中点击 HISTORY AND ROLLBACK 查看历史记录，可以看到有 2 个历史记录。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218200556.png" alt=""></p><p>假设我们刚刚上线的 v2 版本出现了问题，需要回滚回 v1 版本，那么我们可以选中 v1 版本，然后点击 Rollback 进行回滚。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218200735.png" alt=""> 在回滚的时候需要禁用 AUTO-SYNC 自动同步，点击 OK 确认即可。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218200816.png" alt=""> 等待一会可以看到此时已经回滚成功，此时 Pod 是 v1 版本的，并且由于此时线上的版本并不是 Git 仓库中最新的版本，因此此时同步状态是 OutOfSync。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20211218200909.png" alt=""></p><h2 id="_4-参考资料" tabindex="-1">4 参考资料 <a class="header-anchor" href="#_4-参考资料" aria-label="Permalink to &quot;4 参考资料&quot;">​</a></h2><ul><li><a href="https://argo-cd.readthedocs.io/en/stable/" target="_blank" rel="noreferrer">Argo CD 官方文档</a></li><li><a href="https://blog.csdn.net/weixin_40046357/article/details/118447858" target="_blank" rel="noreferrer">GitOps 持续部署工具 Argo CD 初体验</a></li><li><a href="https://kubeoperator.io/docs/user_manual/argocd/" target="_blank" rel="noreferrer">Argo CD 使用指南</a></li><li><a href="https://cloud.tencent.com/developer/article/1664073?from=article.detail.1755628" target="_blank" rel="noreferrer">使用 GitLab CI 与 Argo CD 进行 GitOps 实践</a></li><li><a href="https://cloud.tencent.com/developer/article/1750692?from=article.detail.1664073" target="_blank" rel="noreferrer">在K8S中使用Argo CD做持续部署</a></li><li><a href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noreferrer">Pod 与 Service 的 DNS</a></li><li><a href="https://www.kubernetes.org.cn/9538.html" target="_blank" rel="noreferrer">2021年25佳DevOps工具, 你用了几个</a></li><li><a href="https://mp.weixin.qq.com/s/MN08YzdpDMYZ5xpQP1ECQQ" target="_blank" rel="noreferrer">微服务 CI/CD 实践-GitOps 完整设计与实现</a></li><li><a href="https://blog.container-solutions.com/fluxcd-argocd-jenkins-x-gitops-tools" target="_blank" rel="noreferrer">FluxCD, ArgoCD or Jenkins X: Which Is the Right GitOps Tool for You?</a></li><li><a href="https://www.redhat.com/zh/topics/devops/what-is-ci-cd" target="_blank" rel="noreferrer">CI/CD是什么？如何理解持续集成、持续交付和持续部署</a></li><li><a href="https://cloud.tencent.com/developer/article/1588400" target="_blank" rel="noreferrer">当下最热门的 GitOps，你了解吗？</a></li><li><a href="https://segmentfault.com/a/1190000040831398" target="_blank" rel="noreferrer">GitOps 应用实践系列 - 综述</a></li></ul>`,90))])}const _=k(C,[["render",A]]);export{E as __pageData,_ as default};
