<!DOCTYPE html>
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Operator | Se7en的架构笔记</title>
    <meta name="description" content="个人技术知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta name="generator" content="VitePress v1.0.0-rc.31">
    <link rel="preload stylesheet" href="/assets/style.B-AioMbt.css" as="style">
    
    <script type="module" src="/assets/app.DVBld735.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.PU6D6dP3.js">
    <link rel="modulepreload" href="/assets/chunks/theme.DpA4p4ed.js">
    <link rel="modulepreload" href="/assets/chunks/md5.BwKp3kP6.js">
    <link rel="modulepreload" href="/assets/chunks/use-popup-manager.Dyp0-4xE.js">
    <link rel="modulepreload" href="/assets/chunks/DirectoryList.ByNdyoTq.js">
    <link rel="modulepreload" href="/assets/courses_interview_云原生_07-operator.md.DhmcWqz3.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="Se7en">
    <meta name="keywords" content="Se7en的架构笔记, 知识库, 博客, Se7en">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="Se7en的架构笔记">
    <meta property="og:description" content="个人技术知识库，记录 &amp; 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta property="og:site" content="https://blog.charles7c.top">
    <meta property="og:site_name" content="Se7en的架构笔记">
    <meta property="og:image" content="https://blog.charles7c.top/logo.jpg">
    <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?53af4b1a12fbe40810ca7ad39f8db9c7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9e99012d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-72cd9e37></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-72cd9e37> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9e99012d data-v-466559ec><div class="VPNavBar" data-v-466559ec data-v-b66379e0><div class="container" data-v-b66379e0><div class="title" data-v-b66379e0><div class="VPNavBarTitle has-sidebar" data-v-b66379e0 data-v-84ea8a27><a class="title" href="/" data-v-84ea8a27><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-db184186><!--]--><!--[-->Se7en的架构笔记<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-b66379e0><div class="curtain" data-v-b66379e0></div><div class="content-body" data-v-b66379e0><!--[--><!--]--><div class="VPNavBarSearch search" data-v-b66379e0><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-b66379e0 data-v-33bf1ed8><span id="main-nav-aria-label" class="visually-hidden" data-v-33bf1ed8>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-33bf1ed8 data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b9e8517a><span class="text" data-v-b9e8517a><!----><span data-v-b9e8517a>博客</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-b9e8517a><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><div class="items" data-v-3835bdd9><!--[--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/blogs/original/index" data-v-5847651d><!--[-->原创<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/blogs/translate/index" data-v-5847651d><!--[-->翻译<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-33bf1ed8 data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b9e8517a><span class="text" data-v-b9e8517a><!----><span data-v-b9e8517a>我的分类</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-b9e8517a><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><div class="items" data-v-3835bdd9><!--[--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/categories/issues/index" data-v-5847651d><!--[-->Bug万象集<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/categories/fragments/index" data-v-5847651d><!--[-->个人速查手册<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/categories/tools/index" data-v-5847651d><!--[-->精选工具箱<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/categories/open-source/index" data-v-5847651d><!--[-->开源项目<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/categories/learning/index" data-v-5847651d><!--[-->学习笔记<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-33bf1ed8 data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b9e8517a><span class="text" data-v-b9e8517a><!----><span data-v-b9e8517a>我的小册</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-b9e8517a><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><div class="items" data-v-3835bdd9><!--[--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/courses/ai-infra/index" data-v-5847651d><!--[-->AI Infra 教程<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/courses/elastic-stack/index" data-v-5847651d><!--[-->Elastic Stack 实战教程<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/courses/observability/index" data-v-5847651d><!--[-->Observability 教程<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link active" href="/courses/interview/index" data-v-5847651d><!--[-->面试宝典<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/courses/algorithm/index" data-v-5847651d><!--[-->数据结构与算法<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/tags" tabindex="0" data-v-33bf1ed8 data-v-46b413af><!--[--><span data-v-46b413af>我的标签</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/archives" tabindex="0" data-v-33bf1ed8 data-v-46b413af><!--[--><span data-v-46b413af>我的归档</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-33bf1ed8 data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-b9e8517a><span class="text" data-v-b9e8517a><!----><span data-v-b9e8517a>关于</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-b9e8517a><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><div class="items" data-v-3835bdd9><!--[--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/about/index" data-v-5847651d><!--[-->关于知识库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-3835bdd9 data-v-5847651d><a class="VPLink link" href="/about/me" data-v-5847651d><!--[-->关于我<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-b66379e0 data-v-e6ef5531 data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-b9e8517a><span class="text" data-v-b9e8517a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-b9e8517a><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-b9e8517a><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><!----><!--[--><!--[--><div class="items" data-v-e6ef5531><p class="title" data-v-e6ef5531>中文</p><!--[--><div class="VPMenuLink" data-v-e6ef5531 data-v-5847651d><a class="VPLink link" href="/en/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/07-operator" data-v-5847651d><!--[-->English<!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-b66379e0 data-v-f4d61957><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-f4d61957 data-v-e7f61156 data-v-f4475a51><span class="check" data-v-f4475a51><span class="icon" data-v-f4475a51><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-e7f61156><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-e7f61156><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-b66379e0 data-v-10a8c006 data-v-82c20696><!--[--><a class="VPSocialLink no-icon" href="https://github.com/cr7258/cr7258.github.io" aria-label="github" target="_blank" rel="noopener" data-v-82c20696 data-v-e79c6ebe><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-b66379e0 data-v-d2d323ab data-v-b9e8517a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b9e8517a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-b9e8517a><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-b9e8517a><div class="VPMenu" data-v-b9e8517a data-v-3835bdd9><!----><!--[--><!--[--><div class="group translations" data-v-d2d323ab><p class="trans-title" data-v-d2d323ab>中文</p><!--[--><div class="VPMenuLink" data-v-d2d323ab data-v-5847651d><a class="VPLink link" href="/en/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/07-operator" data-v-5847651d><!--[-->English<!--]--></a></div><!--]--></div><div class="group" data-v-d2d323ab><div class="item appearance" data-v-d2d323ab><p class="label" data-v-d2d323ab>切换日光/暗黑模式</p><div class="appearance-action" data-v-d2d323ab><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d2d323ab data-v-e7f61156 data-v-f4475a51><span class="check" data-v-f4475a51><span class="icon" data-v-f4475a51><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-e7f61156><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-e7f61156><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-d2d323ab><div class="item social-links" data-v-d2d323ab><div class="VPSocialLinks social-links-list" data-v-d2d323ab data-v-82c20696><!--[--><a class="VPSocialLink no-icon" href="https://github.com/cr7258/cr7258.github.io" aria-label="github" target="_blank" rel="noopener" data-v-82c20696 data-v-e79c6ebe><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-b66379e0 data-v-d94d145c><span class="container" data-v-d94d145c><span class="top" data-v-d94d145c></span><span class="middle" data-v-d94d145c></span><span class="bottom" data-v-d94d145c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-9e99012d data-v-a3e49145><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a3e49145><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-a3e49145><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-a3e49145>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a3e49145 data-v-bd973598><button data-v-bd973598>返回顶部</button><!----></div></div><aside class="VPSidebar" data-v-9e99012d data-v-130219b5><div class="curtain" data-v-130219b5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-130219b5><span class="visually-hidden" id="sidebar-aria-label" data-v-130219b5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>AI (1篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/AI/01-ai" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>AI</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>Elastic Stack (1篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/Elastic%20Stack/01-elasticsearch" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>Elasticsearch</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible has-active" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>云原生 (7篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/01-kubernetes" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>Kubernetes</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/02-container" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-orange mr-[6px]" style="font-weight: 550; display: inline-block;">2</div>容器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/03-storage" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-yellow mr-[6px]" style="font-weight: 550; display: inline-block;">3</div>存储</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/04-network" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">4</div>网络</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/05-security" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">5</div>安全</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/06-rollout" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">6</div>发布</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/07-operator" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">7</div>Operator</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>大数据 (1篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E5%A4%A7%E6%95%B0%E6%8D%AE/01-message-queue" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>消息队列</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>操作系统 (5篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/01-cpu" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>CPU</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/02-memory" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-orange mr-[6px]" style="font-weight: 550; display: inline-block;">2</div>内存</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/03-storage" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-yellow mr-[6px]" style="font-weight: 550; display: inline-block;">3</div>存储</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/04-network" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">4</div>网络</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/05-cgroup" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">5</div>cgroup</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-130219b5><section class="VPSidebarItem level-0 collapsible" data-v-130219b5 data-v-92a339de><div class="item" role="button" tabindex="0" data-v-92a339de><div class="indicator" data-v-92a339de></div><h2 class="text" data-v-92a339de>编程语言 (3篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-92a339de><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-92a339de><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-92a339de><!--[--><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/01-golang" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>Golang</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/02-python" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-orange mr-[6px]" style="font-weight: 550; display: inline-block;">2</div>Python</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-92a339de data-v-92a339de><div class="item" data-v-92a339de><div class="indicator" data-v-92a339de></div><a class="VPLink link link" href="/courses/interview/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/03-algorithm" data-v-92a339de><!--[--><p class="text" data-v-92a339de><div class="text-color-yellow mr-[6px]" style="font-weight: 550; display: inline-block;">3</div>数据结构与算法</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9e99012d data-v-3f1ccbdb><div class="VPDoc has-sidebar has-aside" data-v-3f1ccbdb data-v-80df6e47><!--[--><!--]--><div class="container" data-v-80df6e47><div class="aside" data-v-80df6e47><div class="aside-curtain" data-v-80df6e47></div><div class="aside-container" data-v-80df6e47><div class="aside-content" data-v-80df6e47><div class="VPDocAside" data-v-80df6e47 data-v-76169da3><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-76169da3 data-v-91f6de4d><div class="content" data-v-91f6de4d><div class="outline-marker" data-v-91f6de4d></div><div class="outline-title" role="heading" aria-level="2" data-v-91f6de4d>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-91f6de4d><span class="visually-hidden" id="doc-outline-aria-label" data-v-91f6de4d> Table of Contents for current page </span><ul class="root" data-v-91f6de4d data-v-e032d31f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-76169da3></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-80df6e47><div class="content-container" data-v-80df6e47><!--[--><!--]--><!----><main class="main" data-v-80df6e47><div style="position:relative;" class="vp-doc _courses_interview_%E4%BA%91%E5%8E%9F%E7%94%9F_07-operator" data-v-80df6e47><div><h2 id="client-go" tabindex="-1">Client-Go <a class="header-anchor" href="#client-go" aria-label="Permalink to &quot;Client-Go&quot;">​</a></h2><h3 id="client-go-有哪几种客户端" tabindex="-1">Client-Go 有哪几种客户端？ <a class="header-anchor" href="#client-go-有哪几种客户端" aria-label="Permalink to &quot;Client-Go 有哪几种客户端？&quot;">​</a></h3><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410112137449.png" alt=""></p><p>client-go 支持 4 种客户端对象与 kube-apiserver 进行交互：</p><ul><li><strong>RESTClient</strong> 是最基础的客户端，它主要对 HTTP 请求进行了封装，实现了 RESTful 风格的 API。ClientSet、DynamicClient 和 DiscoveryClient 都是基于 RESTClient 实现的。</li><li><strong>ClientSet</strong> 在 RESTClient 的基础上封装了 Resource 和 Version 的管理方法。每一个 Resource 可以被视为一个客户端，而 ClientSet 则是多个客户端的集合，每一个 Resource 和 Version 都以函数的方式暴露给用户。ClientSet 只能处理 Kubernetes 内置资源，不能直接访问 CRD 资源。如果想用 ClientSet 访问 CRD 资源，则可以通过 client-gen 代码生成器重新生成 ClientSet，在 ClientSet 中自动生成与 CRD 操作相关的接口。</li><li><strong>DynamicClient</strong> 能够处理 Kubernetes 的所有资源，包括 Kubernetes 内置资源和 CRD 资源。</li><li><strong>DiscoveryClient</strong> 用于发现 kube-apiserver 所支持的 Group、Versions 和 Resources。</li></ul><p>有关 client-go 使用示例的完整代码可以在这里找到：<a href="https://github.com/cr7258/hands-on-lab/tree/main/client-go/client" target="_blank" rel="noreferrer">client-go</a></p><h4 id="restclient-使用示例" tabindex="-1">RESTClient 使用示例 <a class="header-anchor" href="#restclient-使用示例" aria-label="Permalink to &quot;RESTClient 使用示例&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 配置 API 路径和请求的资源组/资源版本信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">config.APIPath </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;/api&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">config.GroupVersion </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">corev1.SchemeGroupVersion</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 配置数据的编解码器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">config.NegotiatedSerializer </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> scheme.Codecs</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 实例化 RESTClient 对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">restClient, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> rest.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">RESTClientFor</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(config)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 预设返回值存放对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">corev1.PodList{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Do 方法发起请求并用 Into 方法将 API Server 的返回结果写入 Result 对象中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> restClient.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">().</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    Namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    Resource</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pods&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    VersionedParams</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">metav1.ListOptions{Limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}, scheme.ParameterCodec).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    Do</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(context.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    Into</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(result)</span></span></code></pre></div><h4 id="clientset-使用示例" tabindex="-1">ClientSet 使用示例 <a class="header-anchor" href="#clientset-使用示例" aria-label="Permalink to &quot;ClientSet 使用示例&quot;">​</a></h4><p>在 ClientSet 代码示例中，当使用 <code>kubernetes.NewForConfig</code> 函数初始化 ClientSet 客户端集合时，会级联构造出 CoreV1 资源组和资源版本的客户端集合对象（CoreV1Client）。 当使用 <code>clientset.CoreV1().Pods</code> 函数时会创建出 Pod 的专属客户端。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">clientset, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> kubernetes.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewForConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(config)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">podClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> clientset.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">CoreV1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">().</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Pods</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(apiv1.NamespaceDefault)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">list, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> podClient.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(context.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(), metav1.ListOptions{Limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">})</span></span></code></pre></div><h4 id="dynamicclient-使用示例" tabindex="-1">DynamicClient 使用示例 <a class="header-anchor" href="#dynamicclient-使用示例" aria-label="Permalink to &quot;DynamicClient 使用示例&quot;">​</a></h4><p>DynamicClient 之所以能够处理 CRD 资源，其关键在于 DynamicClient 内部实现了 <a href="https://github.com/kubernetes/apimachinery/blob/ea28d546a962e50982945e357ad9869cee15f291/pkg/runtime/interfaces.go#L362-L386" target="_blank" rel="noreferrer">Unstructured</a>，用于处理非结构化数据（无法提前预知数据结构）。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">dynamicClient, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> dynamic.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewForConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(config)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">gvr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> schema.GroupVersionResource{Version: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;v1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, Resource: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pods&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">unstructObj, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> dynamicClient.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Resource</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(gvr).</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">).</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(context.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(), metav1.ListOptions{Limit: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">apiv1.PodList{}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> runtime.DefaultUnstructuredConverter.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">FromUnstructured</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(unstructObj.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">UnstructuredContent</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(), list)</span></span></code></pre></div><h4 id="discoveryclient-使用示例" tabindex="-1">DiscoveryClient 使用示例 <a class="header-anchor" href="#discoveryclient-使用示例" aria-label="Permalink to &quot;DiscoveryClient 使用示例&quot;">​</a></h4><p>kubectl 命令行工具使用了 DiscoveryClient 的封装类 CachedDiscoveryClient，在第一次获取资源组、资源版本、资源信息时，会将响应缓存在本地磁盘，此后在缓存周期内再次获取资源信息时，会直接从本地缓存返回数据。CachedDiscoveryClient 的缓存信息默认存储在 <code>~/.kube/cache/discovery</code> 和 <code>~/.kube/cache/http</code> 目录中，默认缓存周期为 6 小时。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">discoveryClient, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> discovery.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewDiscoveryClientForConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(config)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">_, APIResourceList, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> discoveryClient.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">ServerGroupsAndResources</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> _, list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> APIResourceList {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    gv, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> schema.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">ParseGroupVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(list.GroupVersion)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> _, resource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> list.APIResources {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Printf</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%v</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">, group: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%v</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">, version: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%v\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, resource.Name, gv.Group, gv.Version)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>参考资料：深入理解 Kubernetes 源码 P200 ～ P214</p><h3 id="list-和-watch-的实现原理" tabindex="-1">List 和 Watch 的实现原理 <a class="header-anchor" href="#list-和-watch-的实现原理" aria-label="Permalink to &quot;List 和 Watch 的实现原理&quot;">​</a></h3><p>List-Watch 机制是 Kubernetes 的系统消息通知机制，该机制确保了消息的实时性、顺序性和可靠性。List 负责调用资源的 List RESTful API，基于 HTTP 短链接实现。</p><p>Watch 基于 HTTP 长链接实现，通过 HTTP/1.1 的分块传输编码（Chunked Transfer-Encoding）机制，在响应头中添加 <code>Transfer-Encoding: chunked</code> 字段，将数据分块传输给客户端。（在 HTTP2 中是基于 <a href="https://datatracker.ietf.org/doc/html/rfc9113#name-server-push" target="_blank" rel="noreferrer">Server Push</a> 实现的）</p><p>可以在访问 kube-apiserver 的 URL 后面添加 <code>?watch=true</code> 参数，即可开启 Watch 监听。例如：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 绕过凭证验证</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> proxy</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --port</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> http://localhost:8080/api/v1/namespaces/default/pods?watch=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span></span></code></pre></div><p>参考资料</p><ul><li><a href="https://www.zhaohuabing.com/post/2023-03-09-how-to-create-a-k8s-controller/" target="_blank" rel="noreferrer">Kubernetes Controller 机制详解（一）</a></li><li><a href="https://www.cnblogs.com/daniel-hutao/p/15424703.html" target="_blank" rel="noreferrer">Kubernetes List-Watch 机制原理与实现 - chunked</a></li></ul><h3 id="informer-机制" tabindex="-1">Informer 机制 <a class="header-anchor" href="#informer-机制" aria-label="Permalink to &quot;Informer 机制&quot;">​</a></h3><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410121540747.png" alt=""></p><h4 id="reflector-数据同步" tabindex="-1">Reflector 数据同步 <a class="header-anchor" href="#reflector-数据同步" aria-label="Permalink to &quot;Reflector 数据同步&quot;">​</a></h4><p>Reflector 的主要职责是从 kube-apiserver 拉取并持续监听（<a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/reflector.go#L348" target="_blank" rel="noreferrer">ListAndWatch</a>） 相关资源类型的增删改 （Added/Updated/Deleted）事件，存储在由 DeltaFIFO 实现的本地缓存 (local store) 中，也就是 Indexer 中。</p><p>第一次拉取全量资源（目标资源类型)）后通过 <a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/reflector.go#L599" target="_blank" rel="noreferrer">syncWith</a> 函数全量替换（Replace） 到 DeltaFIFO 的 queue/items 中，之后通过持续监听 Watch(目标资源类型) 增量事件，并去重更新到 DeltaFIFO queue/items 中，等待被消费。</p><h4 id="deltafifo-操作队列" tabindex="-1">DeltaFIFO 操作队列 <a class="header-anchor" href="#deltafifo-操作队列" aria-label="Permalink to &quot;DeltaFIFO 操作队列&quot;">​</a></h4><p><a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/delta_fifo.go#L101" target="_blank" rel="noreferrer">DeltaFIFO</a> 在 Reflector 内部，它作为远端（API Server）和本地（Indexer、Listener）之间的传输桥梁。简单来说，它是一个生产者消费者队列，记录了资源对象的变化过程，拥有 FIFO 的特性，操作的资源对象为 Delta。每一个 Delta 包含一个操作类型和操作对象。</p><h5 id="deltafifo-使用示例" tabindex="-1">DeltaFIFO 使用示例 <a class="header-anchor" href="#deltafifo-使用示例" aria-label="Permalink to &quot;DeltaFIFO 使用示例&quot;">​</a></h5><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/client-go/tools/cache</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/klog/v2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> pod</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Name  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">float64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> newPod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">float64</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) pod {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pod{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		Name:  name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		Value: v,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> podKeyFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> obj.(pod).Name, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 可以自定义 KeyFunc，默认使用 MetaNamespaceKeyFunc 生成的结果（&lt;namespace&gt;/&lt;name&gt;）作为 DeltaFIFO 的 key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> cache.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewDeltaFIFOWithOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(cache.DeltaFIFOOptions{KeyFunction: podKeyFunc})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> newPod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> newPod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> newPod</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod3)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod1.Value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1.1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Update</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod1)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	df.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Pop</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, isInInitialList </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> _, delta </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> obj.(cache.Deltas) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			klog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Infof</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;delta type: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">, delta object: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, delta.Type, delta.Object)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 运行程序输出结果如下，只可以取到最新的对象 pod1，旧值需要去 Indexer 里取</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// I1012 12:03:54.863048    1437 deltafifo.go:38] delta type: Added, delta object: {pod1 %!s(float64=1)}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// I1012 12:03:54.863415    1437 deltafifo.go:38] delta type: Updated, delta object: {pod1 %!s(float64=1.1)}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// I1012 12:03:54.863429    1437 deltafifo.go:38] delta type: Deleted, delta object: {pod1 %!s(float64=1.1)}</span></span></code></pre></div><h5 id="deltafifo-结构" tabindex="-1">DeltaFIFO 结构 <a class="header-anchor" href="#deltafifo-结构" aria-label="Permalink to &quot;DeltaFIFO 结构&quot;">​</a></h5><p>DeltaFIFO 结构中的主要字段如下：</p><ul><li><code>items</code>：用于存储资源对象的 Delta，key 为资源对象的 key，value 为 Delta。</li><li><code>queue</code>：用于存储资源对象的 key，保证资源对象的顺序。由于 map 是无序的，所以需要 <code>queue</code> 来保证资源对象的顺序。与 <code>items</code> 中的 key 一一对应（正常情况下 <code>queue</code> 与<code> items</code> 数量不多不少，刚好对应）。</li><li><code>keyFunc</code>：生成资源对象的 key 的方法。默认使用 <code>MetaNamespaceKeyFunc</code> 方法，生成的 key 为 <code>namespace/name</code>，如果资源对象没有 namespace，则 key 为 <code>name</code>。</li><li><code>KnownObjects</code>：knownObjects 就是 Indexer，里面存有已知全部的对象。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> DeltaFIFO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// lock/cond protects access to &#39;items&#39; and &#39;queue&#39;.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	lock sync.RWMutex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	cond sync.Cond</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// `items` maps a key to a Deltas.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Each such Deltas has at least one Delta.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]Deltas</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// `queue` maintains FIFO order of keys for consumption in Pop().</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// There are no duplicates in `queue`.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// A key is in `queue` if and only if it is in `items`.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	queue []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// populated is true if the first batch of items inserted by Replace() has been populated</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// or Delete/Add/Update/AddIfNotPresent was called first.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	populated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// initialPopulationCount is the number of items inserted by the first call of Replace()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	initialPopulationCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">int</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// keyFunc is used to make the key used for queued item</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// insertion and retrieval, and should be deterministic.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	keyFunc KeyFunc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// knownObjects list keys that are &quot;known&quot; --- affecting Delete(),</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Replace(), and Resync()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	knownObjects KeyListerGetter</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Used to indicate a queue is closed so a control loop can exit when a queue is empty.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Currently, not used to gate any of CRUD operations.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	closed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// emitDeltaTypeReplaced is whether to emit the Replaced or Sync</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// DeltaType when Replace() is called (to preserve backwards compat).</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	emitDeltaTypeReplaced </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Called with every object if non-nil.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	transformer TransformFunc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>每个 <a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/delta_fifo.go#L184" target="_blank" rel="noreferrer">Delta</a> 的结构如下，其中包含 Type（操作类型）和 Object（操作对象，例如 Pod）两个字段：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Delta</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Type   DeltaType</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Object </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>Type 的类型如下：</p><ul><li>Added ：增加</li><li>Updated：更新</li><li>Deleted：删除</li><li>Replaced：重新 list（relist），这个状态是由于 watch event 出错，导致需要进行 relist 来进行全盘同步。需要设置 <code>EmitDeltaTypeReplaced=true</code> 才能显示这个状态，否为默认为 Sync。</li><li>Sync：本地同步</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Added   DeltaType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Added&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Updated DeltaType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Updated&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Deleted DeltaType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Deleted&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Replaced is emitted when we encountered watch errors and had to do a</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// relist. We don&#39;t know if the replaced object has changed.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	//</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// NOTE: Previous versions of DeltaFIFO would use Sync for Replace events</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// as well. Hence, Replaced is only emitted when the option</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// EmitDeltaTypeReplaced is true.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Replaced DeltaType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Replaced&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Sync is for synthetic events during a periodic resync.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Sync DeltaType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Sync&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><p>下面可视化 DeltaFIFO 中最主要的两个存储结构 <code>queue</code> 和 <code>items</code>。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410121535401.png" alt=""></p><p>DeltaFIFO 的职责是通过队列加锁处理（queueActionLocked）、去重（dedupDeltas）、存储在由 DeltaFIFO 实现的本地存储（Indexer） 中，包括 queue （仅存 objKeys） 和 items（存 objKeys 和对应的 Deltas 增量变化），并通过 Pop 不断消费，通过 Process（item）处理相关逻辑。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410121540719.png" alt=""></p><h5 id="为什么使用-deltafifo-而不是直接使用一个-fifo" tabindex="-1">为什么使用 DeltaFIFO，而不是直接使用一个 FIFO？ <a class="header-anchor" href="#为什么使用-deltafifo-而不是直接使用一个-fifo" aria-label="Permalink to &quot;为什么使用 DeltaFIFO，而不是直接使用一个 FIFO？&quot;">​</a></h5><p>最重要的就是合并请求。也就是在 queue 中的 key 被不断 Pop 处理的过程中，会有大量同一个 Obj 的请求到来，这些请求可能散布在整个请求流中，也即是不是连续的。比如下面的例子：在 7 次请求中，包含 4 次对 Obj1 的请求，请求顺序如下：1-&gt;20-&gt;1-&gt;1-&gt;3-&gt;5-&gt;1，如果直接使用 FIFO，那么在处理完第一个 Obj1 之后，需要处理 Obj20，之后又需要处理 Obj1 的请求，后续同理，这样对 Obj 1 重复多次做了处理，这不是我们希望的。所以在 DeltaFIFO 中，我们将这一时间段内对同一个 Obj 的请求都合并为 Deltas，每一次的请求作为其中的一个 Delta。这里的一段时间指的是这个 Obj 对应的 key 入队列 queue 开始到出队列的这段时间内。</p><p>参考资料：</p><ul><li><a href="https://github.com/k8s-club/k8s-club/blob/main/articles/Informer%E6%9C%BA%E5%88%B6%20-%20DeltaFIFO.md" target="_blank" rel="noreferrer">articles/Informer机制 - DeltaFIFO.md</a></li><li><a href="https://github.com/k8s-club/k8s-club/blob/main/articles/K8s%20%E7%B3%BB%E5%88%97(%E5%9B%9B)%20-%20%E6%B5%85%E8%B0%88%20Informer.md" target="_blank" rel="noreferrer">articles/K8s 系列(四) - 浅谈 Informer.md</a></li></ul><h4 id="indexer-资源缓存" tabindex="-1">Indexer 资源缓存 <a class="header-anchor" href="#indexer-资源缓存" aria-label="Permalink to &quot;Indexer 资源缓存&quot;">​</a></h4><p>Indexer 是 client-go 用来存储资源对象并自带索引功能的本地存储，Reflector 从 DeltaFIFO 中将消费出来的资源对象存储至 Indexer。Indexer 中的数据与 etcd 集群中的数据保持完全一致。client-go 可以很方便地从本地存储中读取相应的资源对象数据，而无须每次都从远程 etcd 集群中读取，这样可以减轻 kube-apiserver 和 etcd 集群的压力。</p><h5 id="indexer-使用示例" tabindex="-1">Indexer 使用示例 <a class="header-anchor" href="#indexer-使用示例" aria-label="Permalink to &quot;Indexer 使用示例&quot;">​</a></h5><p>Indexer 的使用示例如下：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">fmt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">	v1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/api/core/v1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/apimachinery/pkg/api/meta</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">	metav1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/apimachinery/pkg/apis/meta/v1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/client-go/tools/cache</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	NamespaceIndexName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;namespace&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	NodeNameIndexName  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;nodeName&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> NamespaceIndexFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	m, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> meta.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Accessor</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}, fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Errorf</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;object has no meta: </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%v</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{m.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetNamespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> NodeNameIndexFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod, ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> obj.(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">ok {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{pod.Spec.NodeName}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 对象的 objKey 由 MetaNamespaceKeyFunc 函数生成</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 另外自定义了两个 IndexFunc 的 NamespaceIndexFunc 和 NodeNameIndexFunc，分别根据资源对象的命名空间和节点名称生成索引值列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> cache.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewIndexer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(cache.MetaNamespaceKeyFunc, cache.Indexers{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		NamespaceIndexName: NamespaceIndexFunc,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		NodeNameIndexName:  NodeNameIndexFunc,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		ObjectMeta: metav1.ObjectMeta{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Name:      </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Namespace: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		Spec: v1.PodSpec{NodeName: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;node1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		ObjectMeta: metav1.ObjectMeta{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Name:      </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Namespace: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		Spec: v1.PodSpec{NodeName: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;node2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pod3 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		ObjectMeta: metav1.ObjectMeta{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Name:      </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Namespace: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		Spec: v1.PodSpec{NodeName: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;node2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod1)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod3)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// ByIndex 两个参数：IndexName（索引器名称）和 indexKey（需要检索的key）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;=========== NamespaceIndexFunc ==============&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pods, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">ByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(NamespaceIndexName, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> _, pod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pods {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod.(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod).Name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;=========== NodeNameIndexFunc ==============&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	pods, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">ByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(NodeNameIndexName, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;node2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		panic</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> _, pod </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pods {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(pod.(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod).Name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;=========== MetaNamespaceKeyFunc ===============&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 直接通过 &lt;namespace&gt;/&lt;name&gt; 的 key 来获取对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	obj, _, _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> index.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetByKey</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;default/pod-2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj.(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">v1.Pod).Name)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 输出结果为：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//=========== NamespaceIndexFunc ==============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//pod-1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//pod-2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//=========== NodeNameIndexFunc ==============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//pod-3</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//pod-2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//=========== MetaNamespaceKeyFunc ===============</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">//pod-2</span></span></code></pre></div><p>在上面的示例中首先通过 <code>NewIndexer</code> 函数实例化 Indexer 对象，第一个参数就是用于计算资源对象键的函数，这里我们使用的是 <code>MetaNamespaceKeyFunc</code> 这个默认的对象键函数；第二个参数是 Indexers，里面包含了我们自定义的两个 IndexFunc：<code>NamespaceIndexFunc</code> 与 <code>NodeNameIndexFunc</code>，一个根据资源对象的命名空间来进行索引，一个根据资源对象所在的节点进行索引。</p><p>然后定义了 3 个 Pod，前两个在 default 命名空间下面，另外一个在 kube-system 命名空间下面，然后通过 <code>index.Add</code> 函数添加这 3 个 Pod 资源对象。然后通过 <code>index.ByIndex</code> 函数查询在名为 namespace 的 Index 下面匹配 IndexedValue 为 default 的 Pod 列表。也就是查询 default 这个命名空间下面的所有 Pod，这里就是前两个定义的 Pod。</p><h5 id="indexfunc-index-indexers-和-indices" tabindex="-1">IndexFunc, Index, Indexers 和 Indices <a class="header-anchor" href="#indexfunc-index-indexers-和-indices" aria-label="Permalink to &quot;IndexFunc, Index, Indexers 和 Indices&quot;">​</a></h5><p>Indexer 中有几个非常重要的概念：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// IndexFunc knows how to compute the set of indexed values for an object.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> IndexFunc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Index maps the indexed value to a set of keys in the store that match on that value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]sets.String</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Indexers maps a name to an IndexFunc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Indexers</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]IndexFunc</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Indices maps a name to an Index</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Indices</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]Index</span></span></code></pre></div><ul><li>IndexFunc 用于计算一个资源对象的索引值列表，上面示例是指定创建 &quot;namespace&quot; 和 &quot;nodeName&quot; 2 个索引，当然我们也可以根据需求定义其他的，比如根据 Label 标签、Annotation 等属性来生成索引值列表。</li><li>Index 是实际的索引，key 是 <a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/index.go#L44" target="_blank" rel="noreferrer">indexedValue</a>（在 &quot;namespace&quot; 索引中有两个 indexedValue：default, kube-system），value 是 objKey（默认使用 MetaNamespaceKeyFunc 函数计算，例如 default/pod-1, kube-system/pod-3） ，对于上面的示例，我们要查找某个命名空间下面的 Pod，那就要让 Pod 按照其命名空间进行索引，对应的 Index 类型就是 map[namespace]sets.pod。</li><li>Indexers 用于查找 IndexFunc，key 为 <a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/index.go#L40" target="_blank" rel="noreferrer">indexName</a>（例如 &quot;namespace&quot;），value 为 indexName 对应的 IndexFunc，上面的示例就是 map[&quot;namespace&quot;]MetaNamespaceIndexFunc。</li><li>Indices：用于查找 Index，key 为 indexName, value 为 indexName 对应的 Index，对于上面的示例就是 map[&quot;namespace&quot;]map[namespace]sets.pod。</li></ul><p>按照上面的理解我们可以得到上面示例的索引数据如下所示：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Indexers 包含了所有的 IndexFunc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Indexers: {  </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;namespace&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FF938A;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">NamespaceIndexFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// IndexFunc</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;nodeName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#B31D28;--shiki-dark:#FF938A;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">NodeNameIndexFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// IndexFunc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Indices 包含了所有的 Index</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Indices: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;"> &quot;namespace&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Index</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">], </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Index 中的一条记录，key 是 IndexedValue，value 是 objKey</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;"> &quot;nodeName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Index</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;node1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">], </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#8DDB8C;">  &quot;node2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;pod-3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410121933684.png" alt=""></p><p>对于 Kubernetes 资源对象的新增操作来说，其建立索引并存储的过程如下：</p><ul><li>1.将新增的对象存储到 <a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/thread_safe_store.go#L240" target="_blank" rel="noreferrer">threadSafeMap 的 items</a> 中，key 是 对象的 objKey（默认使用 MetaNamespaceKeyFunc 函数计算），value 为对象本身。</li><li>2.<a href="https://github.com/kubernetes/client-go/blob/v0.28.3/tools/cache/thread_safe_store.go#L146" target="_blank" rel="noreferrer">遍历 Indexers 中的 indexFunc 列表</a>，为新增的对象应用所有的 indexFunc 函数计算出不同 Index 下的 indexedValue。例如，假设我们设置了 <code>NamespaceIndexFunc</code> 和 <code>NodeNameIndexFunc</code> 两个 indexFunc 函数，那么对于新增的 pod-4 对象，在 Index <code>namespace</code> 下的 indexedValue 为 <code>default</code>，在 Index <code>nodeName</code> 下的 indexedValue 为 <code>node-1</code>。</li><li>3.<a href="https://github.com/kubernetes/client-go/blob/v0.28.3/tools/cache/thread_safe_store.go#L165" target="_blank" rel="noreferrer">根据 IndexName 在 Indices 中找到对应的 Index</a>，将新增的对象 objKey 添加到 Index 中。</li></ul><h5 id="indexer-接口实现" tabindex="-1">Indexer 接口实现 <a class="header-anchor" href="#indexer-接口实现" aria-label="Permalink to &quot;Indexer 接口实现&quot;">​</a></h5><p><a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/index.go#L35" target="_blank" rel="noreferrer">Indexer</a> 定义了两方面的接口：</p><ul><li>第一类为存储类型的接口 <code>Store</code>，包含了 <code>Add</code>、<code>Update</code>、<code>Delete</code>、<code>List</code>、<code>ListKeys</code>、<code>Get</code>、<code>GetByKey</code>、<code>Replace</code>、<code>Resync</code> 等数据存储、读取的常规操作。</li><li>第二类为索引类型的接口，(方法名中包含 Index)。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Indexer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Store</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Index returns the stored objects whose set of indexed values</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// intersects the set of indexed values of the given object, for</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// the named index</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Index</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// IndexKeys returns the storage keys of the stored objects whose</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// set of indexed values for the named index includes the given</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// indexed value</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	IndexKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName, indexedValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// ListIndexFuncValues returns all the indexed values of the given index</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ListIndexFuncValues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// ByIndex returns the stored objects whose set of indexed values</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// for the named index includes the given indexed value</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName, indexedValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// GetIndexers return the indexers</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	GetIndexers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() Indexers</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// AddIndexers adds more indexers to this store.  If you call this after you already have data</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// in the store, the results are undefined.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	AddIndexers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(newIndexers Indexers) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><a href="https://github.com/kubernetes/client-go/blob/64f5574f09ee34521c63013855fb2eaac853012a/tools/cache/store.go#L158" target="_blank" rel="noreferrer">cache</a> 实现了 Indexer 接口，内部定义了 ThreadSafeStore 接口类型的 cacheStorage，用来实现基于索引的本地存储。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// `*cache` implements Indexer in terms of a ThreadSafeStore and an</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// associated KeyFunc.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> cache</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// ThreadSafeStore由 threadSafeMap 实现</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	cacheStorage ThreadSafeStore</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	//默认使用 MetaNamespaceKeyFunc 也即是 key 为namespace/name</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	keyFunc KeyFunc</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/thread_safe_store.go#L41" target="_blank" rel="noreferrer">ThreadSafeStore</a> 接口定义了常规的存储、读取、更新接口，以及对于索引的一些接口。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> ThreadSafeStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Update</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) (item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, exists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	List</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ListKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Replace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Index</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, obj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	IndexKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName, indexedValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ListIndexFuncValues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) []</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ByIndex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(indexName, indexedValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) ([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	GetIndexers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() Indexers</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// AddIndexers adds more indexers to this store. This supports adding indexes after the store already has items.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	AddIndexers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(newIndexers Indexers) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Resync is a no-op and is deprecated</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Resync</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/thread_safe_store.go#L224" target="_blank" rel="noreferrer">threadSafeMap</a> 实现了 ThreadSafeStore 接口，此处为真正实现 local store (Indexer) 的地方，通过 <code>items</code> 来存储数据、indexers 来存储索引方法、indices 来存储索引，实现基于索引的存储。并实现了实现了 ThreadSafeStore 的所有接口。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// threadSafeMap implements ThreadSafeStore</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> threadSafeMap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	lock  sync.RWMutex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// index implements the indexing functionality</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">storeIndex</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>参考资料：</p><ul><li><a href="https://cloud.tencent.com/developer/article/1692517" target="_blank" rel="noreferrer">client-go 之 Indexer 的理解</a></li><li><a href="https://www.bilibili.com/video/BV1AG411b72E/?spm_id_from=333.788&amp;vd_source=1c0f4059dae237b29416579c3a5d326e" target="_blank" rel="noreferrer">Client-Go 之 Indexer 原理分析及示例演示</a></li><li><a href="https://cloud.tencent.com/developer/article/2144571" target="_blank" rel="noreferrer">K8s源码分析(23)-indexer及index和indices组件</a></li><li><a href="https://github.com/k8s-club/k8s-club/blob/main/articles/Informer%E6%9C%BA%E5%88%B6%20-%20Indexer.md#%E9%87%8D%E7%82%B9%E6%A6%82%E5%BF%B5" target="_blank" rel="noreferrer">k8s-club/articles/Informer机制 - Indexer.md</a></li><li><a href="https://github.com/rfyiamcool/notes/blob/main/kubernetes_client_go_informer.md" target="_blank" rel="noreferrer">深入源码分析 kubernetes client-go list-watch 和 informer 机制的实现原理</a></li><li>深入理解 Kubernetes 源码 P227</li></ul><h4 id="processor-资源处理" tabindex="-1">Processor 资源处理 <a class="header-anchor" href="#processor-资源处理" aria-label="Permalink to &quot;Processor 资源处理&quot;">​</a></h4><p>从 DeltaFIFO 中推送的资源对象的操作记录，除了交由 Indexer 存储至本地缓存，还会一并推送给 processor，最终交由 Informer 机制的使用方处理。</p><h4 id="workqueue-工作队列" tabindex="-1">Workqueue 工作队列 <a class="header-anchor" href="#workqueue-工作队列" aria-label="Permalink to &quot;Workqueue 工作队列&quot;">​</a></h4><p>workqueue 支持 3 种队列，并且提供了 3 种接口，不同队列实现可应对不同的使用场景。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410131142640.png" alt=""></p><ul><li><a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/queue.go#L26-L34" target="_blank" rel="noreferrer">Interface</a>：FIFO 通用队列接口，先进先出队列，并且支持去重机制。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Interface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">int</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() (item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Done</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ShutDown</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ShutDownWithDrain</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	ShuttingDown</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><ul><li><a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/delaying_queue.go#L28-L34" target="_blank" rel="noreferrer">DelayingInterface</a>：延迟队列接口，基于 <a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/queue.go#L26-L34" target="_blank" rel="noreferrer">Interface</a> 接口封装，<code>AddAfter</code> 方法允许延迟一段时间后再将元素插入队列。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// DelayingInterface is an Interface that can Add an item at a later time. This makes it easier to</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// requeue items after failures without ending up in a hot-loop.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> DelayingInterface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Interface</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// AddAfter adds an item to the workqueue after the indicated duration has passed</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	AddAfter</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, duration time.Duration)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><ul><li><a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/rate_limiting_queue.go#L19-L33" target="_blank" rel="noreferrer">RateLimitingInterface</a>：限速队列接口，基于 <a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/delaying_queue.go#L28-L34" target="_blank" rel="noreferrer">DelayingInterface</a> 接口封装，支持在将元素插入队列时进行速率限制。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// RateLimitingInterface is an interface that rate limits items being added to the queue.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> RateLimitingInterface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	DelayingInterface</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// AddRateLimited adds an item to the workqueue after the rate limiter says it&#39;s ok</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	AddRateLimited</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Forget indicates that an item is finished being retried.  Doesn&#39;t matter whether it&#39;s for perm failing</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// or for success, we&#39;ll stop the rate limiter from tracking it.  This only clears the `rateLimiter`, you</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// still have to call `Done` on the queue.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Forget</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// NumRequeues returns back how many times the item was requeued</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	NumRequeues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h5 id="fifo-通用队列实现" tabindex="-1">FIFO 通用队列实现 <a class="header-anchor" href="#fifo-通用队列实现" aria-label="Permalink to &quot;FIFO 通用队列实现&quot;">​</a></h5><p>FIFO 通用队列数据结构中最主要的字段有 <code>queue</code>、<code>dirty</code>、<code>processing</code>，通过这个 <code>dirty</code> 和 <code>processing</code> 两个字段实现了去重的功能。</p><ul><li><code>queue</code> 用来实现顺序存储元素的, 其结构为 slice 切片类型, 元素类型为 interface{} 任意类型。<code>queue</code> 读写流程为读 slice 的头部, 写 slice 的尾部。 <code>queue</code> 是 FIFO 先进先出的设计。</li><li><code>dirty</code> 是用来实现去重的，主要是为了避免重复消费元素。当添加元素时（不管元素是待处理，还是正常被处理），如果 <code>dirty</code> 中已含有该元素则直接返回。</li><li><code>processing</code> 也是用来去重的，用于标记一个元素是否正在被处理，其主要是为了避免元素被并发处理。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// Type is a work queue (see the package comment).</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// queue defines the order in which we will work on items. Every</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// element of queue should be in the dirty set and not in the</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// processing set.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	queue []t</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// dirty defines all of the items that need to be processed.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	dirty set</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Things that are currently being processed are in the processing set.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// These things may be simultaneously in the dirty set. When we finish</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// processing something and remove it from this set, we&#39;ll check if</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// it&#39;s in the dirty set, and if so, add it to the queue.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	processing set</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	cond </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">sync.Cond</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	shuttingDown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	drain        </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	metrics queueMetrics</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	unfinishedWorkUpdatePeriod time.Duration</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	clock                      clock.WithTicker</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h6 id="fifo-通用队列存储过程" tabindex="-1">FIFO 通用队列存储过程 <a class="header-anchor" href="#fifo-通用队列存储过程" aria-label="Permalink to &quot;FIFO 通用队列存储过程&quot;">​</a></h6><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410131435502.png" alt=""></p><p>例如上图所示为 FIFO 的存储过程，通过 <code>Add</code> 方法向 FIFO 队列中分别插入 1，2，3 这 3 个元素，此时队列中的 <code>queue</code> 和 <code>dirty</code> 字段分别存有 1，2，3 元素，<code>processing</code> 字段为空。</p><p>然后通过 <code>Get</code> 方法获取最先进入的元素（元素1），此时队列中的 <code>queue</code> 和 <code>dirty</code> 字段分别存有 2，3；元素 1 被放入 <code>processing</code> 字段中，说明它正在被处理。最后处理完元素 1 时，通过 <code>Done</code> 方法将其标记为处理完成，此时队列中的 <code>processing</code> 字段中的 1 元素被删除。</p><h6 id="fifo-通用队列并发存储过程" tabindex="-1">FIFO 通用队列并发存储过程 <a class="header-anchor" href="#fifo-通用队列并发存储过程" aria-label="Permalink to &quot;FIFO 通用队列并发存储过程&quot;">​</a></h6><p>但是在并发存储下，如何保证处理一个元素之前哪怕被添加多次，也只是处理一次？下图为 FIFO 并发存储的过程。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410131438514.png" alt=""></p><p>在并发场景下，goroutine A 通过 <code>Get</code> 方法获取元素 1，元素 1 被添加到 <code>processing</code> 字段中，同一时间，goroutine B 通过 <code>Add</code> 方法插入另一个 1 元素，此时在 <code>processing</code> 字段中已经存在相同的元素，所以后面后面的元素 1 不会被直接插入到 <code>queue</code> 字段中，而是存入 <code>dirty</code> 字段中；在 goroutine A 通过 <code>Done</code> 方法标记处理完元素 1 后，如果 <code>dirty</code> 字段中存有元素 1，则将其追加到 <code>queue</code> 字段的尾部，<code>dirty</code> 和 <code>processing</code> 字段都是 HashMap 数据结构实现的，不考虑无序，只考虑去重。</p><h6 id="fifo-通用队列主要方法" tabindex="-1">FIFO 通用队列主要方法 <a class="header-anchor" href="#fifo-通用队列主要方法" aria-label="Permalink to &quot;FIFO 通用队列主要方法&quot;">​</a></h6><p><code>Add()</code> 是将元素插入到队列的方法。插入元素的流程原理如下：</p><ul><li>判断 <code>dirty</code> 是否存在该元素，如存在则直接跳出，其目的是为了实现待处理元素的去重效果。</li><li>然后在 <code>dirty</code> 里添加元素，再判断 <code>processing</code> 集合是否存在元素，如果存在则跳出。其目的是为了防止同一个元素被并发处理。</li><li>在 <code>processing</code> 集合里加入元素。</li><li>使用 cond signal 唤醒其他陷入阻塞的协程。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (q </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Type) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 加锁保证并发安全</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    defer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 已关闭直接退出</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.shuttingDown {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 如果 dirty 已存在，则直接退出，dirty 是为了实现待消费元素的去重。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.dirty.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 增加 add 的指标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.metrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 每次 add 的元素也要放到 dirty 集合里，为了去重效果。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.dirty.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 如果这个元素正在处理, 那么在把元素放到 dirty 后就完事了。后面由 Done 方法来处理 dirty -&gt; queue 的逻辑。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.processing.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 把元素放到队列里</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.queue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> append</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(q.queue, item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 通知等待的协程处理任务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.cond.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><code>Get()</code> 是获取元素的方法，从队列的头部获取最先入队的元素。然后在 <code>processing</code> 集合中添加元素，其目的就是为了防止同一个元素对象被并发处理。最后从 <code>dirty</code> 集合里删除对象，因为 <code>dirty</code> 是为了实现的待消费去重，既然从 <code>queue</code> 拿走元素，<code>dirty</code> 也需要删除。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (q </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Type) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() (item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}, shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 线程安全</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    defer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 如果队列为空则陷入 cond 等待</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    for</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(q.queue) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">q.shuttingDown {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        q.cond.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Wait</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 如果关闭了且队列为空，直接 return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(q.queue) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 从头部获取元素</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.queue[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.queue[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 重新引用切片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.queue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.queue[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 统计 metrics get 指标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.metrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 从 dirty set 里去除，加到 processing 集合里</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.processing.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.dirty.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> item, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><code>Done()</code> 用来标记某元素已经处理完，可以从 <code>processing</code> 集合中去除，然后判断 <code>dirty</code> 集合中是否有该对象，如果存在则把该对象推到 <code>queue</code> 里再次入队。</p><p>如果一个元素正在被处理，这时候如果再次添加同一个元素，由于该元素还在处理未完成，只能把对象放到 <code>dirty</code> 里。为什么不放到 <code>queue</code> 里？因为放 <code>queue</code> 里的话，在并发消费场景下，同一个元素会被多个协程并发处理。当执行完毕调用 <code>Done()</code> 时，会把 <code>dirty</code> 的任务重新入队，起到了排队的效果。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (q </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">Type) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 线程安全</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Lock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    defer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.cond.L.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 统计 metrics done 指标</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.metrics.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">done</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 从 processing 集合中剔除</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    q.processing.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 如果 dirty 还有，那么把该元素加到 queue 队列里</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.dirty.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">has</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        q.queue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> append</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(q.queue, item)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        q.cond.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> q.processing.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        q.cond.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Signal</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>FIFO 通用队列的使用示例可以在这里找到：<a href="https://github.com/cr7258/hands-on-lab/blob/main/client-go/workqueue/workqueue.go" target="_blank" rel="noreferrer">workqueue.go</a></p><h5 id="延迟队列" tabindex="-1">延迟队列 <a class="header-anchor" href="#延迟队列" aria-label="Permalink to &quot;延迟队列&quot;">​</a></h5><p>延迟队列是基于 FIFO 队列接口封装的，在原有功能上增加了 <code>AddAfter</code> 方法，其原理是延迟一段时间后再将元素插入 FIFO 队列。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// delayingType wraps an Interface and provides delayed re-enquing</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> delayingType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	Interface</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// clock tracks time for delayed firing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	clock clock.Clock</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// stopCh lets us signal a shutdown to the waiting loop</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	stopCh </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">chan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// stopOnce guarantees we only signal shutdown a single time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	stopOnce sync.Once</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// heartbeat ensures we wait no more than maxWait before firing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	heartbeat clock.Ticker</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// waitingForAddCh is a buffered channel that feeds waitingForAdd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	waitingForAddCh </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">chan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">waitFor</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// metrics counts the number of retries</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	metrics retryMetrics</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><code>delayingType</code> 结构中最主要的字段是 <code>waitingForAddCh</code>，其默认初始大小为 1000，在通过 <code>AddAfter</code> 方法插入元素时，是非阻塞状态的，只有当插入的元素大于或等于 1000 时，延迟队列才会处于阻塞状态。<code>waitingForAddCh</code> 字段中的数据通过 goroutine 运行的 <a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/delaying_queue.go#L189" target="_blank" rel="noreferrer">waitingLoop</a> 函数持久运行。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410132109043.png" alt=""></p><p>如上图所示，将元素 1 插入 <code>waitingForAddCh</code> 字段中，通过 <code>waitingLoop</code> 函数消费元素数据。当元素的处理时间 <code>readyAt</code> 大于当前时间，说明需要延迟将元素插入 FIFO 通用队列，此时将该元素放入优先队列（<code>waitForPriorityQueue</code>）中。当元素处理时间小于或等于当前时间时，说明该元素需要立即处理，此时将元素直接插入 FIFO 通用队列。此外，<code>waitingLoop</code> 函数还会不断遍历优先队列中的元素，将已经达到处理时间的元素插入 FIFO 通用队列。</p><p>延迟队列的使用示例可以在这里找到：<a href="https://github.com/cr7258/hands-on-lab/blob/main/client-go/workqueue/delayworkqueue.go" target="_blank" rel="noreferrer">delayworkqueue.go</a></p><h5 id="限速队列" tabindex="-1">限速队列 <a class="header-anchor" href="#限速队列" aria-label="Permalink to &quot;限速队列&quot;">​</a></h5><p>限速对列是基于延迟队列和 FIFO 队列接口封装，限速队列接口（<a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/rate_limiting_queue.go#L20" target="_blank" rel="noreferrer">RateLimitingInterface</a>）在原有功能上增加了 <code>AddRateLimited</code>、<code>Forget</code>、<code>NumRequeues</code> 方法。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// RateLimitingInterface is an interface that rate limits items being added to the queue.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> RateLimitingInterface</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	DelayingInterface</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// AddRateLimited adds an item to the workqueue after the rate limiter says it&#39;s ok</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	AddRateLimited</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Forget indicates that an item is finished being retried.  Doesn&#39;t matter whether it&#39;s for perm failing</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// or for success, we&#39;ll stop the rate limiter from tracking it.  This only clears the `rateLimiter`, you</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// still have to call `Done` on the queue.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Forget</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// NumRequeues returns back how many times the item was requeued</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	NumRequeues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>在创建限速队列时，可以传入不同的限速器 <a href="https://github.com/kubernetes/client-go/blob/release-1.25/util/workqueue/default_rate_limiters.go#L27" target="_blank" rel="noreferrer">RateLimiter</a> 实现，官方提供 4 种限速器，分别应对不同的场景，包括令牌桶算法（BucketRateLimiter）、排队指数算法（ItemExponentialFailureRateLimiter）、计数器算法（ItemFastSlowRateLimiter）和混合算法（MaxOfRateLimiter）。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> RateLimiter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// When gets an item and gets to decide how long that item should wait</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	When</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) time.Duration</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// Forget indicates that an item is finished being retried.  Doesn&#39;t matter whether it&#39;s for failing</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// or for success, we&#39;ll stop tracking it</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Forget</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// NumRequeues returns back how many failures the item has had</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	NumRequeues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>其中 <code>MaxOfRateLimiter</code> 实例化时可以传入多个 RateLimiter 限速器实例，使用 <code>When()</code> 求等待间隔时，然后选择最大的等待间隔。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 我们定义了一个复合的限速器，它结合了两种限速策略：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 1. 使用指数退避的限速器，用于限制每个任务的重试频率</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 2. 使用令牌桶算法限制总体速率，这里设置为每秒 5 个请求。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// MaxOfRateLimiter 会遍历所有的 RateLimiter 示例，使用 When() 计算等待间隔，然后选择最大的等待间隔。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">limiter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> workqueue.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewMaxOfRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    workqueue.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewItemExponentialFailureRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(time.Millisecond, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">time.Millisecond),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">workqueue.BucketRateLimiter{Limiter: rate.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(rate.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Limit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">), </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><p>限速队列的使用示例可以在这里找到：<a href="https://github.com/cr7258/hands-on-lab/blob/main/client-go/workqueue/ratelimitworkqueue.go" target="_blank" rel="noreferrer">ratelimitworkqueue.go</a></p><ul><li><a href="https://xiaorui.cc/archives/7363" target="_blank" rel="noreferrer">源码分析 kubernetes client-go workqueue 的实现原理</a></li><li>深入理解 Kubernetes 源码 P233 ~ P240</li></ul><h5 id="为什么-controller-不直接从-informer-中获取资源对象进行处理-而是从-workqueue-中获取对象的-objkey-进行处理" tabindex="-1">为什么 Controller 不直接从 Informer 中获取资源对象进行处理，而是从 Workqueue 中获取对象的 objKey 进行处理？ <a class="header-anchor" href="#为什么-controller-不直接从-informer-中获取资源对象进行处理-而是从-workqueue-中获取对象的-objkey-进行处理" aria-label="Permalink to &quot;为什么 Controller 不直接从 Informer 中获取资源对象进行处理，而是从 Workqueue 中获取对象的 objKey 进行处理？&quot;">​</a></h5><p>因为每个 obj 在 Kubernetes 各组件内经过 Reconcile，obj 随时都在进行变化。Informer 中对象是以 key-accumulator 方式存储，即一个 obj 随着时间的变化存在很多版本，通过取 key 间接取到最新的 obj，保证了取到的 obj 是实时最新的对象。</p><p>另外，为什么在 Controller 内使用 WorkQueue，还有以下两点考虑：</p><ul><li>避免 OOM。具体来说，是提升 Controller（Listener） 处理（接收）事件的速率，（直接放入WorkQueue，比完成复杂的 Reconcile 流程要快很多很多），这样就能避免 Informer 框架内的 processorListener 在向当前这个 Listener/Controller 派发事件时，向 pendingNotifications 中堆积过多事件，从而引发 OOM。</li><li>减少 Reconcile 次数，避免多次无意义的 Reconcile。通过 WorkQueue 内部的实现机制，能够保证在处理一个 obj 之前哪怕其被添加了多次（在短时间内大量到来等），也只会被处理一次，极大的减少了 Reconcile 的次数。同时每次 Reconcile 从 Indexer 中取最新的 obj，而不是直接使用被通知的 obj，能够避免无意义的 Reconcile。</li></ul><p>参考资料：<a href="https://github.com/k8s-club/k8s-club/blob/c742e2234a7898f6524046cd7c40ffc95e2b0f71/articles/QA%20to%20Understand%20K8s.md" target="_blank" rel="noreferrer">在掌握 K8s 路上，应该理解下面这些 QA</a></p><h4 id="resync-机制的作用是什么" tabindex="-1">Resync 机制的作用是什么？ <a class="header-anchor" href="#resync-机制的作用是什么" aria-label="Permalink to &quot;Resync 机制的作用是什么？&quot;">​</a></h4><p>resync 的目的是为了让 listener 能够定期 reconcile Indexer 内的所有事件，来保证对应事件关心的对象（可能是系统内，也可能是系统外）状态都是预期状态。如果此时 reconcile 过程中发现对象状态不是预期状态，就会驱动其向预期状态发展。</p><p>一个易理解的例子：我们实现了一个 listener，其会通过对象描述的磁盘规格（大小，类型等等）来向云服务商购买对应的磁盘。对于对象 A 而言，listener 在第一次 reconcile 对象 A 时，通过调用云服务商的接口，购买了其对应规格的磁盘，并在购买完成之后，在对象 A 的 status 中添加上了购买完成的信息，之后本轮 reconcile 就结束了。之后，用户通过云服务商控制台将磁盘误删除了，但是此时 listener 是感知不到这个操作的，并且对象 A 的 status 中一直维持着购买成功的信息，这可能会导致依赖这个 status 的程序出现意外的错误。在这种场景下，通过 resync 功能，在 listener 的同步时间到达之后，就会重新处理对象 A，此时 listener 发现控制台上并没有该磁盘，就会重新调用接口再创建一次，这样就将用户在控制台误删除的动作给修正了）</p><p>参考资料：</p><ul><li><a href="https://github.com/k8s-club/k8s-club/blob/main/articles/Informer%E6%9C%BA%E5%88%B6%20-%20Resync.md" target="_blank" rel="noreferrer">articles/Informer机制 - Resync.md</a></li></ul><h3 id="使用-informer-controller-runtime-和-kubebuilder-来编写-controller-的区别" tabindex="-1">使用 Informer，Controller runtime 和 Kubebuilder 来编写 Controller 的区别 <a class="header-anchor" href="#使用-informer-controller-runtime-和-kubebuilder-来编写-controller-的区别" aria-label="Permalink to &quot;使用 Informer，Controller runtime 和 Kubebuilder 来编写 Controller 的区别&quot;">​</a></h3><ul><li><p>直接使用 Informer：直接使用 Informer 编写 Controller 需要编写更多的代码，因为我们需要在代码处理更多的底层细节，例如如何在集群中监视资源，以及如何处理资源变化的通知。但是，使用 Informer 也可以更加自定义和灵活，因为我们可以更细粒度地控制 Controller 的行为。</p></li><li><p>Controller runtime：Controller runtime 是基于 Informer 实现的，在 Informer 之上为 Controller 编写提供了高级别的抽象和帮助类，包括 Leader Election、Event Handling 和 Reconcile Loop 等等。使用 Controller runtime，可以更容易地编写和测试 Controller，因为它已经处理了许多底层的细节。</p></li><li><p>Kubebuilder：和 Informer 及 Controller runtime 不同，Kubebuilder 并不是一个代码库，而是一个开发框架。Kubebuilder 底层使用了 controller-runtime。Kubebuilder 提供了 CRD 生成器和代码生成器等工具，可以帮助开发者自动生成一些重复性的代码和资源定义，提高开发效率。同时，Kubebuilder 还可以生成 Webhooks，以用于验证自定义资源。</p></li></ul><p>参考资料：<a href="https://www.zhaohuabing.com/post/2023-03-09-how-to-create-a-k8s-controller/" target="_blank" rel="noreferrer">Kubernetes Controller 机制详解（一）：Kubernetes API List/Watch 机制 与 Informer 客户端库</a></p><h2 id="controller-runtime" tabindex="-1">Controller-Runtime <a class="header-anchor" href="#controller-runtime" aria-label="Permalink to &quot;Controller-Runtime&quot;">​</a></h2><h3 id="controller-runtime-的使用方法" tabindex="-1">Controller-Runtime 的使用方法 <a class="header-anchor" href="#controller-runtime-的使用方法" aria-label="Permalink to &quot;Controller-Runtime 的使用方法&quot;">​</a></h3><p>controller-runtime 的使用主要分为以下几个步骤：</p><ul><li>1.使用 <code>NewManager</code> 方法创建 Manager，Manager 主要用来启动 Controller、管理 Controller 依赖、提供集群相关资源的获取方式等。</li><li>2.通过 <code>NewControllerManagedBy(mgr)</code> 方法实例化一个 Builder 对象，其中传入的 Manager 提供创建 Controller 所需的依赖。</li><li>3.使用 <code>For</code> 方法用来指定需要 Watch 的资源类型；有时候也会用到 <code>Owns</code> 方法，表示某资源是我关心资源的从属，其 event 也会进去 Controller 的队列中；<code>Complete</code> 方法传入用户实现 Reconciler 接口的一个对象，controller-runtime 会生成相应 Controller，将用户的 Reconciler 注册进 Controller，并生成 watch 资源的默认 eventHandler，同时执行 Controller 的 watch 函数；</li><li>4.用户的 Reconciler 需要实现 reconcile.Reconciler 接口。</li><li>5.使用 <code>Start</code> 方法启动 Manager，这一步中会同时启动 Cache，即启动 Informer，以及启动 Controller。</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">context</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">fmt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">	api</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">github.com/zhaohuabing/k8scontrollertutorial/pkg/custom/apis/foo/v1alpha1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">	_</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">k8s.io/client-go/plugin/pkg/client/auth/gcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">os</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">	ctrl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sigs.k8s.io/controller-runtime</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sigs.k8s.io/controller-runtime/pkg/client</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sigs.k8s.io/controller-runtime/pkg/log</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sigs.k8s.io/controller-runtime/pkg/log/zap</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	setupLog </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.Log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">WithName</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;setup&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> reconciler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	client.Client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 对 foo 进行调谐的方法</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">reconciler) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(ctx context.Context, req ctrl.Request) (ctrl.Result, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">FromContext</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(ctx).</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">WithValues</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, req.NamespacedName)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">V</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">).</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;reconciling foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> foo api.Foo</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> r.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(ctx, req.NamespacedName, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">foo); err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;unable to get foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.Result{}, err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Printf</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;Sync/Add/Update for foo </span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">%s\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, foo.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetName</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.Result{}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">SetLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(zap.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">())</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 创建 Manager，创建时设置 Leader Election 相关的参数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	mgr, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewManager</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetConfigOrDie</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(), ctrl.Options{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		LeaderElection:          </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		LeaderElectionID:        </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;sample-controller&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		LeaderElectionNamespace: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;kube-system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;unable to start manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		os.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// in a real controller, we&#39;d create a new scheme for this</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> api.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">AddToScheme</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(mgr.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetScheme</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;unable to add scheme&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		os.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 创建对 foo 进行调谐的 controller</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewControllerManagedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(mgr).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		For</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">api.Foo{}).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		Complete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">reconciler{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">			Client: mgr.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">GetClient</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;unable to create controller&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		os.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">    // 创建用于校验 foo 的 webhook</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewWebhookManagedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(mgr).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		For</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">api.Foo{}).</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">		Complete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;unable to create webhook&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		os.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">	// 启动 Manager，Manager 将启动其管理的所有 controller 以及 webhook server</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;starting manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> mgr.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Start</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(ctrl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">SetupSignalHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()); err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		setupLog.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(err, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;problem running manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">		os.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">Exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>参考资料：</p><ul><li><a href="https://www.zhaohuabing.com/post/2023-04-04-how-to-create-a-k8s-controller-2/" target="_blank" rel="noreferrer">Kubernetes Controller 机制详解（二）</a></li><li><a href="https://mp.weixin.qq.com/s/VIBC9FudR2sdy9U7p72A-Q" target="_blank" rel="noreferrer">k8s operator开发进阶之controller-runtime源码分析</a></li><li><a href="https://cloud.tencent.com/developer/article/2352384" target="_blank" rel="noreferrer">一文读懂 K8s controller-runtime</a></li><li><a href="https://yash-kukreja-98.medium.com/develop-on-kubernetes-series-demystifying-the-for-vs-owns-vs-watches-controller-builders-in-c11ab32a046e" target="_blank" rel="noreferrer">Develop on Kubernetes Series — Demystifying the For vs Owns vs Watches controller-builders in controller-runtime</a></li></ul><h3 id="controller-runtime-的整体架构" tabindex="-1">Controller-Runtime 的整体架构 <a class="header-anchor" href="#controller-runtime-的整体架构" aria-label="Permalink to &quot;Controller-Runtime 的整体架构&quot;">​</a></h3><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232112133.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232144263.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232144616.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232145539.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232145650.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232145573.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232146634.png" alt=""></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/202410232149688.png" alt=""></p><p>Builder 创建 Controller 时，会根据 <code>Build.For()</code>、<code>Build.Owns()</code>、<code>Build.Watches()</code> 方法中设置的资源对象类型在 <code>Builder.Build()</code> 中创建相应的 <code>Kind</code>，并调用 <code>Controller.Watch()</code> 方法将 <code>Kind</code> 传入 Controller。</p><p>Watch 从 Source 获取事件，并使用 Predicates 处理接收到的事件以进行过滤，并使用 EventHandler 将它们放入队列中。</p><p>参考资料：</p><ul><li><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html" target="_blank" rel="noreferrer">controller-runtime源码分析</a></li><li><a href="https://nakamasato.medium.com/kubernetes-operator-series-1-controller-runtime-aa50d1d93c5c" target="_blank" rel="noreferrer">Kubernetes Operator series 1 — controller-runtime example controller</a></li><li><a href="https://mp.weixin.qq.com/s/VIBC9FudR2sdy9U7p72A-Q" target="_blank" rel="noreferrer">k8s operator开发进阶之controller-runtime源码分析</a></li></ul></div></div></main><footer class="VPDocFooter" data-v-80df6e47 data-v-1706cf44><!--[--><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--]--><div class="edit-info" data-v-1706cf44><div class="edit-link" data-v-1706cf44><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/cr7258/cr7258.github.io/edit/main/docs/courses/interview/云原生/07-operator.md" target="_blank" rel="noreferrer" data-v-1706cf44><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-1706cf44><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 不妥之处，敬请雅正<!--]--></a></div><div class="last-updated" data-v-1706cf44><p class="VPLastUpdated" data-v-1706cf44 data-v-f2558ebd>最后更新: <time datetime="2024-10-24T02:13:23.000Z" data-v-f2558ebd></time></p></div></div><nav class="prev-next" data-v-1706cf44><div class="pager" data-v-1706cf44><a class="VPLink link pager-link prev" href="/courses/interview/%E4%BA%91%E5%8E%9F%E7%94%9F/06-rollout" data-v-1706cf44><!--[--><span class="desc" data-v-1706cf44>上一篇</span><span class="title" data-v-1706cf44><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">6</div>发布</span><!--]--></a></div><div class="pager" data-v-1706cf44><a class="VPLink link pager-link next" href="/courses/interview/%E5%A4%A7%E6%95%B0%E6%8D%AE/01-message-queue" data-v-1706cf44><!--[--><span class="desc" data-v-1706cf44>下一篇</span><span class="title" data-v-1706cf44><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>消息队列</span><!--]--></a></div></nav></footer><!--[--><!--[--><!--[--><div id="comment-container"></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"about_index.md\":\"ClTyGAWD\",\"about_me.md\":\"BmxhEx6m\",\"archives.md\":\"B90u-CmM\",\"blogs_original_2022_01-kubernetes-setup.md\":\"DGnvN2Cj\",\"blogs_original_2022_02-kubectl-debug.md\":\"CFQyDDJ1\",\"blogs_original_2022_03-finalizer.md\":\"CNJPLl7A\",\"blogs_original_2022_04-kubeasz.md\":\"ClomVKnm\",\"blogs_original_2022_05-docker-rootless.md\":\"BRiDYQFe\",\"blogs_original_2022_06-kafka-setup.md\":\"Db2BnE37\",\"blogs_original_2022_07-kafka-big-message.md\":\"CPaqUMuu\",\"blogs_original_2022_08-reset-kafka-consumer-offset.md\":\"B164RPKM\",\"blogs_original_2022_09-pulsar.md\":\"BYhBDMBq\",\"blogs_original_2022_10-harbor.md\":\"CWuqOk_6\",\"blogs_original_2022_11.nebula.md\":\"DWXG9nBo\",\"blogs_original_2022_12.lru.md\":\"mtC7nES1\",\"blogs_original_2022_13-envoy-quickstart.md\":\"DKmLL6N6\",\"blogs_original_2023_01-argocd-quickstart.md\":\"CGKXLOsc\",\"blogs_original_2023_02-wasm-in-cloud-native.md\":\"BZwGn2Zp\",\"blogs_original_2023_03-kubectl-patch.md\":\"r90t1DlM\",\"blogs_original_2023_04-kubernetes-keycloak-oidc.md\":\"DT18blPJ\",\"blogs_original_2023_05-kubernetes-multi-cluster-1.md\":\"8FG5At_c\",\"blogs_original_2023_06-kubernetes-multi-cluster-2.md\":\"Ca7J7J3N\",\"blogs_original_2023_07-vcluster.md\":\"BSm-4oDC\",\"blogs_original_2023_08-cilium-cluster-mesh.md\":\"By5fkCQR\",\"blogs_original_2023_09-clusterresourceset.md\":\"mbspsDH5\",\"blogs_original_2023_10-cilium-bgp.md\":\"CiLvNX9z\",\"blogs_original_2024_01-crossplane.md\":\"D8U3n6uf\",\"blogs_original_2024_02-sidecar-containers.md\":\"CV1C_pmm\",\"blogs_original_2024_03-higress-ai-plugins.md\":\"DiSeg59U\",\"blogs_original_2025_01-mcp.md\":\"Drb9UbUX\",\"blogs_original_2025_02-elasticsearch-mcp-server.md\":\"DqLNWIN9\",\"blogs_original_2025_03-mcp-client.md\":\"CTMoJ01v\",\"blogs_original_2025_04-mcp-sse.md\":\"D0xxO_eO\",\"blogs_original_2025_05-higress-vs-oneapi.md\":\"Dw6eRPBe\",\"blogs_original_2025_06-higress-ai-gateway.md\":\"DUlW53BR\",\"blogs_original_2025_07-deepseek-flashmla.md\":\"JvAg4apN\",\"blogs_original_2025_08-deepseek-deepep.md\":\"DeBX73Nr\",\"blogs_original_2025_09-deepseek-deepgemm.md\":\"Uue9ny-S\",\"blogs_original_2025_10-deepseek-parallelism.md\":\"Bc0cxSLj\",\"blogs_original_2025_11-deepseek-3fs.md\":\"mspgTQa2\",\"blogs_original_2025_12-manus-ai.md\":\"C1aFzgxo\",\"blogs_original_2025_13-gpu-kind-cluster.md\":\"C7fzgXv_\",\"blogs_original_2025_14-gateway-api-inference-extension.md\":\"DqbTwS9b\",\"blogs_original_2025_15-rag-higress-es-langchain.md\":\"BAcds50S\",\"blogs_original_2025_16-context7.md\":\"DxEGJGRQ\",\"blogs_original_2025_17-runai-model-streamer.md\":\"1bvtbuxc\",\"blogs_original_2025_18-higress-llmaz-vllm.md\":\"D5Y0G-4t\",\"blogs_original_2025_19-oceanbase-dify-mcp.md\":\"B3Ia33-o\",\"blogs_original_index.md\":\"DN9UqtDc\",\"blogs_translate_2023_01-life-of-a-packet-in-kubernetes-part-1.md\":\"0xUOSUHs\",\"blogs_translate_2023_02-life-of-a-packet-in-kubernetes-part-2.md\":\"DddehrVM\",\"blogs_translate_2023_03-life-of-a-packet-in-kubernetes-part-3.md\":\"CDFTnUCG\",\"blogs_translate_2023_04-life-of-a-packet-in-kubernetes-part-4.md\":\"pJ3LT-Vk\",\"blogs_translate_2023_05-git-cheat-sheet-1.md\":\"CfcuTCcq\",\"blogs_translate_2023_06-git-cheat-sheet-2.md\":\"Bbqgr9ll\",\"blogs_translate_2023_07-git-cheat-sheet-3.md\":\"DexGNnp2\",\"blogs_translate_index.md\":\"BRIzbW49\",\"categories_fragments_index.md\":\"CJzrOsUp\",\"categories_fragments_个人速查手册_01-git.md\":\"Bwee3awt\",\"categories_fragments_个人速查手册_02-find-docker-file.md\":\"C2-cvOlG\",\"categories_fragments_个人速查手册_03-idea-shortcut.md\":\"CXhJo2Fj\",\"categories_fragments_个人速查手册_04-ssh-proxy.md\":\"CuzGmrJZ\",\"categories_fragments_个人速查手册_05-docker-command.md\":\"OehTLbyU\",\"categories_fragments_个人速查手册_06-kubernetes-command.md\":\"YWBP312t\",\"categories_fragments_个人速查手册_07.uv.md\":\"DDOHobMc\",\"categories_issues_bug万象集_01-ebpf.md\":\"CZgDP3pT\",\"categories_issues_bug万象集_02-ide.md\":\"Cx9fNzlF\",\"categories_issues_index.md\":\"Cr6geNu3\",\"categories_learning_ai_01-ai.md\":\"5_078oRQ\",\"categories_learning_ai_02-gpu.md\":\"CH-170fa\",\"categories_learning_ai_03-pytorch.md\":\"CKyUdctk\",\"categories_learning_ai_04-mcp.md\":\"EzwK4uuG\",\"categories_learning_ai_05-transformer.md\":\"BU7MRZEg\",\"categories_learning_ebpf_01-ebpf.md\":\"BDitH2ab\",\"categories_learning_ebpf_02-bpftool.md\":\"BA1AtK9W\",\"categories_learning_index.md\":\"DVn2roQ2\",\"categories_learning_云原生_01-istio.md\":\"CeGeAq71\",\"categories_learning_云原生_02-observability.md\":\"Bg8z7QvW\",\"categories_learning_编程语言_01-rust.md\":\"BvnCzpfq\",\"categories_learning_编程语言_02-golang-concurrency.md\":\"DQsIgrIt\",\"categories_learning_编程语言_02-golang-gmp.md\":\"1nEhgtkq\",\"categories_learning_编程语言_03-design-pattern.md\":\"CrCIAyKx\",\"categories_open-source_index.md\":\"Cm43Y61l\",\"categories_open-source_开源项目_01-ai.md\":\"DK2qd-ka\",\"categories_open-source_开源项目_02-web.md\":\"TG4mAMUC\",\"categories_open-source_开源项目_03-mcp.md\":\"DiE4NNHD\",\"categories_open-source_开源项目_04-cloud-native.md\":\"In2N0kcq\",\"categories_tools_index.md\":\"BLtkSH0V\",\"categories_tools_云原生_01-k8s-resource.md\":\"BuwJ9HOA\",\"courses_ai-infra_ai infra 教程_01-vllm-quickstart.md\":\"D234vKKS\",\"courses_ai-infra_ai infra 教程_02-pagedattention.md\":\"CIYNRQGM\",\"courses_ai-infra_ai infra 教程_03-prefix-caching.md\":\"DSKFDszX\",\"courses_ai-infra_ai infra 教程_04-speculative-decoding.md\":\"be_IeiNq\",\"courses_ai-infra_index.md\":\"CrT7bxeu\",\"courses_algorithm_index.md\":\"DxWXY9a4\",\"courses_algorithm_算法_01-hot100.md\":\"D7An9J6j\",\"courses_algorithm_算法_02-template.md\":\"Bdwhp0YT\",\"courses_algorithm_算法_03-design-problem.md\":\"B8XkxTft\",\"courses_algorithm_算法_04-shell.md\":\"BWjnHwM3\",\"courses_elastic-stack_elastic stack 实战教程_01-quick-start.md\":\"B7eKl6jv\",\"courses_elastic-stack_elastic stack 实战教程_02-ilm.md\":\"BIcR8oK-\",\"courses_elastic-stack_elastic stack 实战教程_03-snapshot.md\":\"B50tMZtn\",\"courses_elastic-stack_elastic stack 实战教程_04-fleet.md\":\"uq1AgBeI\",\"courses_elastic-stack_elastic stack 实战教程_05-java-client.md\":\"DD1xDMiS\",\"courses_elastic-stack_index.md\":\"DJlJs71Q\",\"courses_interview_ai_01-ai.md\":\"DlXZQqdx\",\"courses_interview_elastic stack_01-elasticsearch.md\":\"CaWnNa_A\",\"courses_interview_index.md\":\"CkH95BIi\",\"courses_interview_云原生_01-kubernetes.md\":\"vB7IQtHp\",\"courses_interview_云原生_02-container.md\":\"YitjOKar\",\"courses_interview_云原生_03-storage.md\":\"DWYAqEcl\",\"courses_interview_云原生_04-network.md\":\"bUtIrZOb\",\"courses_interview_云原生_05-security.md\":\"CtNpyM6y\",\"courses_interview_云原生_06-rollout.md\":\"BuKoUbs_\",\"courses_interview_云原生_07-operator.md\":\"DhmcWqz3\",\"courses_interview_大数据_01-message-queue.md\":\"D5V5WZeg\",\"courses_interview_操作系统_01-cpu.md\":\"Do2O_AUc\",\"courses_interview_操作系统_02-memory.md\":\"Jd1TtDIX\",\"courses_interview_操作系统_03-storage.md\":\"BVvKZyAf\",\"courses_interview_操作系统_04-network.md\":\"DQ72_ZC3\",\"courses_interview_操作系统_05-cgroup.md\":\"NKcSVzxo\",\"courses_interview_编程语言_01-golang.md\":\"BqapVU-t\",\"courses_interview_编程语言_02-python.md\":\"Cu5F-eXt\",\"courses_interview_编程语言_03-algorithm.md\":\"q_xOy3J5\",\"courses_observability_opentelemetry_01-opentelemetry-elastic.md\":\"Cx6Rtl-l\",\"courses_observability_index.md\":\"C3Ru8TBp\",\"en_about_index.md\":\"CmCa7_BU\",\"en_about_me.md\":\"BKEqH-v9\",\"en_archives.md\":\"CKhF0VC9\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_01-quick-start.md\":\"5WDgvhl-\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_02-ilm.md\":\"ChJNma7W\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_03-snapshot.md\":\"CgSi6deN\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_04-fleet.md\":\"DVNVb1xI\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_05-java-client.md\":\"BIxxeplW\",\"en_courses_elastic-stack_index.md\":\"UltvLXFf\",\"en_index.md\":\"Crk_ARIP\",\"en_tags.md\":\"CNKWtYvp\",\"index.md\":\"C48x9QOL\",\"meetup_network_01-network_01-cni.md\":\"Vud6wYrY\",\"meetup_network_index.md\":\"BAywDmvY\",\"tags.md\":\"CnYNupHu\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Se7en的架构笔记\",\"description\":\"个人技术知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"博客\",\"items\":[{\"text\":\"原创\",\"link\":\"/blogs/original/index\",\"activeMatch\":\"/blogs/original/\"},{\"text\":\"翻译\",\"link\":\"/blogs/translate/index\",\"activeMatch\":\"/blogs/translate/\"}],\"activeMatch\":\"/blogs/\"},{\"text\":\"我的分类\",\"items\":[{\"text\":\"Bug万象集\",\"link\":\"/categories/issues/index\",\"activeMatch\":\"/categories/issues/\"},{\"text\":\"个人速查手册\",\"link\":\"/categories/fragments/index\",\"activeMatch\":\"/categories/fragments/\"},{\"text\":\"精选工具箱\",\"link\":\"/categories/tools/index\",\"activeMatch\":\"/categories/tools/\"},{\"text\":\"开源项目\",\"link\":\"/categories/open-source/index\",\"activeMatch\":\"/categories/open-source/\"},{\"text\":\"学习笔记\",\"link\":\"/categories/learning/index\",\"activeMatch\":\"/categories/learning/\"}],\"activeMatch\":\"/categories/\"},{\"text\":\"我的小册\",\"items\":[{\"text\":\"AI Infra 教程\",\"link\":\"/courses/ai-infra/index\",\"activeMatch\":\"/courses/ai-infra/\"},{\"text\":\"Elastic Stack 实战教程\",\"link\":\"/courses/elastic-stack/index\",\"activeMatch\":\"/courses/elastic-stack/\"},{\"text\":\"Observability 教程\",\"link\":\"/courses/observability/index\",\"activeMatch\":\"/courses/observability/\"},{\"text\":\"面试宝典\",\"link\":\"/courses/interview/index\",\"activeMatch\":\"/courses/interview/\"},{\"text\":\"数据结构与算法\",\"link\":\"/courses/algorithm/index\",\"activeMatch\":\"/courses/algorithm/\"}],\"activeMatch\":\"/courses/\"},{\"text\":\"我的标签\",\"link\":\"/tags\",\"activeMatch\":\"/tags\"},{\"text\":\"我的归档\",\"link\":\"/archives\",\"activeMatch\":\"/archives\"},{\"text\":\"关于\",\"items\":[{\"text\":\"关于知识库\",\"link\":\"/about/index\",\"activeMatch\":\"/about/index\"},{\"text\":\"关于我\",\"link\":\"/about/me\",\"activeMatch\":\"/about/me\"}],\"activeMatch\":\"/about/\"}],\"sidebar\":{\"/categories/issues/\":[{\"text\":\"Bug万象集 (2篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>eBPF\",\"link\":\"/categories/issues/Bug万象集/01-ebpf\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>IDE\",\"link\":\"/categories/issues/Bug万象集/02-ide\"}],\"collapsed\":false}],\"/categories/fragments/\":[{\"text\":\"个人速查手册 (7篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Git 速查手册\",\"link\":\"/categories/fragments/个人速查手册/01-git\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>5 种快速查找容器中文件的方法\",\"link\":\"/categories/fragments/个人速查手册/02-find-docker-file\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>IDEA 快捷键\",\"link\":\"/categories/fragments/个人速查手册/03-idea-shortcut\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>使用 ClashX 代理 SSH 连接\",\"link\":\"/categories/fragments/个人速查手册/04-ssh-proxy\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Docker 常用命令\",\"link\":\"/categories/fragments/个人速查手册/05-docker-command\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Kubernetes 常用命令\",\"link\":\"/categories/fragments/个人速查手册/06-kubernetes-command\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>uv 速查手册\",\"link\":\"/categories/fragments/个人速查手册/07.uv\"}],\"collapsed\":false}],\"/categories/tools/\":[{\"text\":\"云原生 (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>查询 Kubernetes 核心资源字段\",\"link\":\"/categories/tools/云原生/01-k8s-resource\"}],\"collapsed\":false}],\"/categories/learning/\":[{\"text\":\"AI (5篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>AI\",\"link\":\"/categories/learning/AI/01-ai\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>GPU\",\"link\":\"/categories/learning/AI/02-gpu\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>PyTorch\",\"link\":\"/categories/learning/AI/03-pytorch\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Model Context Protocol（MCP）\",\"link\":\"/categories/learning/AI/04-mcp\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Transformer\",\"link\":\"/categories/learning/AI/05-transformer\"}],\"collapsed\":false},{\"text\":\"eBPF (2篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>eBPF 基础\",\"link\":\"/categories/learning/eBPF/01-ebpf\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>bpftool\",\"link\":\"/categories/learning/eBPF/02-bpftool\"}],\"collapsed\":false},{\"text\":\"云原生 (2篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Istio\",\"link\":\"/categories/learning/云原生/01-istio\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Observability\",\"link\":\"/categories/learning/云原生/02-observability\"}],\"collapsed\":false},{\"text\":\"编程语言 (4篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Rust\",\"link\":\"/categories/learning/编程语言/01-rust\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Go 并发编程\",\"link\":\"/categories/learning/编程语言/02-golang-concurrency\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Go GMP\",\"link\":\"/categories/learning/编程语言/02-golang-gmp\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>设计模式\",\"link\":\"/categories/learning/编程语言/03-design-pattern\"}],\"collapsed\":false}],\"/categories/open-source/\":[{\"text\":\"开源项目 (4篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>AI\",\"link\":\"/categories/open-source/开源项目/01-ai\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Web\",\"link\":\"/categories/open-source/开源项目/02-web\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>MCP\",\"link\":\"/categories/open-source/开源项目/03-mcp\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>云原生\",\"link\":\"/categories/open-source/开源项目/04-cloud-native\"}],\"collapsed\":false}],\"/blogs/original/\":[{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/snake.svg\\\" title=\\\"蛇年\\\" alt=\\\"生肖\\\">\\n            2025年 (19篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Dify + OceanBase + MCP：三剑合璧，轻松构建 RAG 应用\",\"link\":\"/blogs/original//2025/19-oceanbase-dify-mcp\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>使用 Higress AI 网关代理 vLLM 推理服务\",\"link\":\"/blogs/original//2025/18-higress-llmaz-vllm\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>使用 Run:ai Model Streamer 实现模型的高效加载\",\"link\":\"/blogs/original//2025/17-runai-model-streamer\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>AI 乱写代码怎么破？使用 Context7 MCP Server 让 AI 写出靠谱代码!\",\"link\":\"/blogs/original//2025/16-context7\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>使用 LangChain + Higress + Elasticsearch 构建 RAG 应用\",\"link\":\"/blogs/original//2025/15-rag-higress-es-langchain\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>为 Kubernetes 提供智能的 LLM 推理路由：Gateway API Inference Extension 深度解析\",\"link\":\"/blogs/original//2025/14-gateway-api-inference-extension\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>一键部署 GPU Kind 集群，体验 vLLM 极速推理\",\"link\":\"/blogs/original//2025/13-gpu-kind-cluster\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>Manus 刷屏，全网求邀请码！这款 AI Agent 究竟有多强？\",\"link\":\"/blogs/original//2025/12-manus-ai\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>DeepSeek 开源周第五弹：3FS —— 专为 AI 训练和推理设计的分布式存储\",\"link\":\"/blogs/original//2025/11-deepseek-3fs\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>DeepSeek 开源周第四弹：DualPipe 和 EPLB —— 优化并行策略\",\"link\":\"/blogs/original//2025/10-deepseek-parallelism\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">11</div>DeepSeek 开源周第三弹：DeepGEMM —— 高效的 FP8 GEMM 库，核心代码仅 300 行！\",\"link\":\"/blogs/original//2025/09-deepseek-deepgemm\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">12</div>DeepSeek 开源周第二弹：DeepEP —— 首个 MoE 模型训练和推理的 EP 通信库\",\"link\":\"/blogs/original//2025/08-deepseek-deepep\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">13</div>DeepSeek 开源周第一弹：FlashMLA —— 大模型推理的“涡轮增压器”\",\"link\":\"/blogs/original//2025/07-deepseek-flashmla\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">14</div>提升 AI 服务的稳定性：Higress AI 网关的降级功能介绍\",\"link\":\"/blogs/original//2025/06-higress-ai-gateway\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">15</div>AI 网关对决：Higress 与 OneAPI 的功能对比\",\"link\":\"/blogs/original//2025/05-higress-vs-oneapi\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">16</div>构建基于 SSE 协议通信的 MCP Server 和 Client\",\"link\":\"/blogs/original//2025/04-mcp-sse\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">17</div>快速上手：实现你的第一个 MCP Client\",\"link\":\"/blogs/original//2025/03-mcp-client\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">18</div>MCP Server 开发实战：无缝对接 LLM 和 Elasticsearch\",\"link\":\"/blogs/original//2025/02-elasticsearch-mcp-server\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">19</div>一文带你入门 MCP（模型上下文协议）\",\"link\":\"/blogs/original//2025/01-mcp\"}],\"collapsed\":false},{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/dragon.svg\\\" title=\\\"龙年\\\" alt=\\\"生肖\\\">\\n            2024年 (3篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>使用 Higress AI 插件对接通义千问大语言模型\",\"link\":\"/blogs/original//2024/03-higress-ai-plugins\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>深入剖析 Kubernetes 原生 Sidecar 容器\",\"link\":\"/blogs/original//2024/02-sidecar-containers\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Crossplane 实战：构建统一的云原生控制平面\",\"link\":\"/blogs/original//2024/01-crossplane\"}],\"collapsed\":false},{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/rabbit.svg\\\" title=\\\"兔年\\\" alt=\\\"生肖\\\">\\n            2023年 (10篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>使用 Containerlab + Kind 快速部署 Cilium BGP 环境\",\"link\":\"/blogs/original//2023/10-cilium-bgp\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>使用 ClusterResourceSet 为 Cluster API 集群自动安装 CNI 插件\",\"link\":\"/blogs/original//2023/09-clusterresourceset\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Cilium 多集群 Cluster Mesh 介绍\",\"link\":\"/blogs/original//2023/08-cilium-cluster-mesh\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>vCluster -- 基于虚拟集群的多租户方案\",\"link\":\"/blogs/original//2023/07-vcluster\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Kubernetes 多集群网络方案系列 2 -- Submariner 监控\",\"link\":\"/blogs/original//2023/06-kubernetes-multi-cluster-2\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Kubernetes 多集群网络方案系列 1 -- Submariner 介绍\",\"link\":\"/blogs/original//2023/05-kubernetes-multi-cluster-1\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>在 Kubernetes 中使用 Keycloak OIDC Provider 对用户进行身份验证\",\"link\":\"/blogs/original//2023/04-kubernetes-keycloak-oidc\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>使用 Kubectl Patch 命令更新资源\",\"link\":\"/blogs/original//2023/03-kubectl-patch\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>WebAssembly 在云原生中的实践指南\",\"link\":\"/blogs/original//2023/02-wasm-in-cloud-native\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>ArgoCD 简明教程\",\"link\":\"/blogs/original//2023/01-argocd-quickstart\"}],\"collapsed\":false},{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/tiger.svg\\\" title=\\\"虎年\\\" alt=\\\"生肖\\\">\\n            2022年 (13篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>使用 Envoy 作为前端代理\",\"link\":\"/blogs/original//2022/13-envoy-quickstart\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>实现 LRU 缓存算法\",\"link\":\"/blogs/original//2022/12.lru\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Nebula 分布式图数据库介绍\",\"link\":\"/blogs/original//2022/11.nebula\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Habor 部署指南\",\"link\":\"/blogs/original//2022/10-harbor\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Pulsar 介绍与部署\",\"link\":\"/blogs/original//2022/09-pulsar\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>如何重置 Kafka 中的 Consumer Offset？\",\"link\":\"/blogs/original//2022/08-reset-kafka-consumer-offset\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>如何往 Kafka 发送大消息？\",\"link\":\"/blogs/original//2022/07-kafka-big-message\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>Kafka 生产环境部署指南\",\"link\":\"/blogs/original//2022/06-kafka-setup\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>Docker Rootless 在非特权模式下运行 Docker\",\"link\":\"/blogs/original//2022/05-docker-rootless\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>使用 ezctl 工具部署和管理 Kubernetes 集群\",\"link\":\"/blogs/original//2022/04-kubeasz\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">11</div>Kubernetes 中的对象是如何删除的：Finalizers 字段介绍\",\"link\":\"/blogs/original//2022/03-finalizer\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">12</div>Kubectl debug 调试容器\",\"link\":\"/blogs/original//2022/02-kubectl-debug\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">13</div>Kubenetes 高可用集群搭建\",\"link\":\"/blogs/original//2022/01-kubernetes-setup\"}],\"collapsed\":false}],\"/blogs/translate/\":[{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/rabbit.svg\\\" title=\\\"兔年\\\" alt=\\\"生肖\\\">\\n            2023年 (7篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Git 速查表：专家必备的 14 个 Git 命令\",\"link\":\"/blogs/translate//2023/07-git-cheat-sheet-3\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Git 速查表：中级用户必备的 12 个 Git 命令\",\"link\":\"/blogs/translate//2023/06-git-cheat-sheet-2\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Git 速查表：初学者必备的 12 个 Git 命令\",\"link\":\"/blogs/translate//2023/05-git-cheat-sheet-1\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Kubernetes 中数据包的生命周期 -- 第 4 部分\",\"link\":\"/blogs/translate//2023/04-life-of-a-packet-in-kubernetes-part-4\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Kubernetes 中数据包的生命周期 -- 第 3 部分\",\"link\":\"/blogs/translate//2023/03-life-of-a-packet-in-kubernetes-part-3\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Kubernetes 中数据包的生命周期 -- 第 2 部分\",\"link\":\"/blogs/translate//2023/02-life-of-a-packet-in-kubernetes-part-2\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>Kubernetes 中数据包的生命周期 -- 第 1 部分\",\"link\":\"/blogs/translate//2023/01-life-of-a-packet-in-kubernetes-part-1\"}],\"collapsed\":false}],\"/courses/elastic-stack/\":[{\"text\":\"Elastic Stack 实战教程 (5篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Elastic Stack 8 快速上手\",\"link\":\"/courses/elastic-stack/Elastic Stack 实战教程/01-quick-start\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>ILM 索引生命周期管理\",\"link\":\"/courses/elastic-stack/Elastic Stack 实战教程/02-ilm\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>快照备份与恢复\",\"link\":\"/courses/elastic-stack/Elastic Stack 实战教程/03-snapshot\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>使用 Fleet 管理 Elastic Agent 监控应用\",\"link\":\"/courses/elastic-stack/Elastic Stack 实战教程/04-fleet\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Elasticsearch Java API Client 开发\",\"link\":\"/courses/elastic-stack/Elastic Stack 实战教程/05-java-client\"}],\"collapsed\":false}],\"/courses/ai-infra/\":[{\"text\":\"AI Infra 教程 (4篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>vLLM 快速部署指南\",\"link\":\"/courses/ai-infra/AI Infra 教程/01-vllm-quickstart\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>vLLM 核心技术 PagedAttention 原理详解\",\"link\":\"/courses/ai-infra/AI Infra 教程/02-pagedattention\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Prefix Caching 详解：实现 KV Cache 的跨请求高效复用\",\"link\":\"/courses/ai-infra/AI Infra 教程/03-prefix-caching\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Speculative Decoding 推测解码方案详解\",\"link\":\"/courses/ai-infra/AI Infra 教程/04-speculative-decoding\"}],\"collapsed\":false}],\"/courses/observability/\":[{\"text\":\"OpenTelemetry (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>OpenTelemetry × Elastic Observability 系列（一）：整体架构介绍\",\"link\":\"/courses/observability/OpenTelemetry/01-opentelemetry-elastic\"}],\"collapsed\":false}],\"/courses/interview/\":[{\"text\":\"AI (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>AI\",\"link\":\"/courses/interview/AI/01-ai\"}],\"collapsed\":false},{\"text\":\"Elastic Stack (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Elasticsearch\",\"link\":\"/courses/interview/Elastic Stack/01-elasticsearch\"}],\"collapsed\":false},{\"text\":\"云原生 (7篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Kubernetes\",\"link\":\"/courses/interview/云原生/01-kubernetes\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>容器\",\"link\":\"/courses/interview/云原生/02-container\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>存储\",\"link\":\"/courses/interview/云原生/03-storage\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>网络\",\"link\":\"/courses/interview/云原生/04-network\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>安全\",\"link\":\"/courses/interview/云原生/05-security\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>发布\",\"link\":\"/courses/interview/云原生/06-rollout\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>Operator\",\"link\":\"/courses/interview/云原生/07-operator\"}],\"collapsed\":false},{\"text\":\"大数据 (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>消息队列\",\"link\":\"/courses/interview/大数据/01-message-queue\"}],\"collapsed\":false},{\"text\":\"操作系统 (5篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>CPU\",\"link\":\"/courses/interview/操作系统/01-cpu\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>内存\",\"link\":\"/courses/interview/操作系统/02-memory\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>存储\",\"link\":\"/courses/interview/操作系统/03-storage\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>网络\",\"link\":\"/courses/interview/操作系统/04-network\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>cgroup\",\"link\":\"/courses/interview/操作系统/05-cgroup\"}],\"collapsed\":false},{\"text\":\"编程语言 (3篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Golang\",\"link\":\"/courses/interview/编程语言/01-golang\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Python\",\"link\":\"/courses/interview/编程语言/02-python\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>数据结构与算法\",\"link\":\"/courses/interview/编程语言/03-algorithm\"}],\"collapsed\":false}],\"/courses/algorithm/\":[{\"text\":\"算法 (4篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Hot 100 算法题\",\"link\":\"/courses/algorithm/算法/01-hot100\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>算法解题套路框架\",\"link\":\"/courses/algorithm/算法/02-template\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>经典设计问题\",\"link\":\"/courses/algorithm/算法/03-design-problem\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Shell 命令\",\"link\":\"/courses/algorithm/算法/04-shell\"}],\"collapsed\":false}],\"/meetup/network/\":[{\"text\":\"network (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>CNI (Container Network Interface)\",\"link\":\"/meetup/network/01-network/01-cni\"}],\"collapsed\":false}]},\"sidebarCollapsible\":false,\"logo\":\"/logo.png\",\"outline\":{\"level\":\"deep\",\"label\":\"目录\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"editLink\":{\"pattern\":\"https://github.com/cr7258/cr7258.github.io/edit/main/docs/:path\",\"text\":\"不妥之处，敬请雅正\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/cr7258/cr7258.github.io\"}],\"articleMetadataConfig\":{\"author\":\"Se7en\",\"authorLink\":\"/about/me\",\"showViewCount\":false},\"copyrightConfig\":{\"license\":\"署名-相同方式共享 4.0 国际 (CC BY-SA 4.0)\",\"licenseLink\":\"http://creativecommons.org/licenses/by-sa/4.0/\"},\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":true},\"footerConfig\":{\"showFooter\":true,\"copyright\":\"Copyright  2023-2025 Se7en\"}},\"locales\":{\"root\":{\"label\":\"中文\",\"lang\":\"zh\"},\"en\":{\"label\":\"English\",\"lang\":\"en\"}},\"scrollOffset\":90,\"cleanUrls\":true}");</script>
    
  </body>
</html>