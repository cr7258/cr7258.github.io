<!DOCTYPE html>
<html lang="zh" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes 中数据包的生命周期 -- 第 3 部分 | Se7en的架构笔记</title>
    <meta name="description" content="个人技术知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta name="generator" content="VitePress v1.0.0-rc.31">
    <link rel="preload stylesheet" href="/assets/style.WfmocsYz.css" as="style">
    
    <script type="module" src="/assets/app.sy-TfAZ1.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.FHZ5yb6k.js">
    <link rel="modulepreload" href="/assets/chunks/theme.G0p6knoh.js">
    <link rel="modulepreload" href="/assets/chunks/md5.0oexlRJv.js">
    <link rel="modulepreload" href="/assets/chunks/use-popup-manager.3ZIgUJdU.js">
    <link rel="modulepreload" href="/assets/chunks/ArticleMetadata.d4_nZKBO.js">
    <link rel="modulepreload" href="/assets/blogs_translate_2023_03-life-of-a-packet-in-kubernetes-part-3.md.-G3E6Jdg.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="Se7en">
    <meta name="keywords" content="Se7en的架构笔记, 知识库, 博客, Se7en">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#3c8772">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="Se7en的架构笔记">
    <meta property="og:description" content="个人技术知识库，记录 &amp; 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta property="og:site" content="https://blog.charles7c.top">
    <meta property="og:site_name" content="Se7en的架构笔记">
    <meta property="og:image" content="https://blog.charles7c.top/logo.jpg">
    <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?53af4b1a12fbe40810ca7ad39f8db9c7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-03322d68><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c4918e4e></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c4918e4e> Skip to content </a><!--]--><!----><header class="VPNav" data-v-03322d68 data-v-629c70bd><div class="VPNavBar has-sidebar" data-v-629c70bd data-v-1d72176a><div class="container" data-v-1d72176a><div class="title" data-v-1d72176a><div class="VPNavBarTitle has-sidebar" data-v-1d72176a data-v-21327bbd><a class="title" href="/" data-v-21327bbd><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-d7b35c78><!--]--><!--[-->Se7en的架构笔记<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-1d72176a><div class="curtain" data-v-1d72176a></div><div class="content-body" data-v-1d72176a><!--[--><!--]--><div class="VPNavBarSearch search" data-v-1d72176a><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-1d72176a data-v-a12edbe3><span id="main-nav-aria-label" class="visually-hidden" data-v-a12edbe3>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-a12edbe3 data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-f18e2dbf><span class="text" data-v-f18e2dbf><!----><span data-v-f18e2dbf>博客</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-f18e2dbf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><div class="items" data-v-8a7fe2f1><!--[--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/blogs/original/index" data-v-cf652a9b><!--[-->原创<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link active" href="/blogs/translate/index" data-v-cf652a9b><!--[-->翻译<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a12edbe3 data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-f18e2dbf><span class="text" data-v-f18e2dbf><!----><span data-v-f18e2dbf>我的分类</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-f18e2dbf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><div class="items" data-v-8a7fe2f1><!--[--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/categories/issues/index" data-v-cf652a9b><!--[-->Bug万象集<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/categories/fragments/index" data-v-cf652a9b><!--[-->个人速查手册<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/categories/tools/index" data-v-cf652a9b><!--[-->精选工具箱<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/categories/open-source/index" data-v-cf652a9b><!--[-->开源项目<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a12edbe3 data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-f18e2dbf><span class="text" data-v-f18e2dbf><!----><span data-v-f18e2dbf>我的小册</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-f18e2dbf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><div class="items" data-v-8a7fe2f1><!--[--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/courses/elastic-stack/index" data-v-cf652a9b><!--[-->Elastic Stack 教程<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/tags" tabindex="0" data-v-a12edbe3 data-v-bc587c79><!--[--><span data-v-bc587c79>我的标签</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/archives" tabindex="0" data-v-a12edbe3 data-v-bc587c79><!--[--><span data-v-bc587c79>我的归档</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-a12edbe3 data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-f18e2dbf><span class="text" data-v-f18e2dbf><!----><span data-v-f18e2dbf>关于</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-f18e2dbf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><div class="items" data-v-8a7fe2f1><!--[--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/about/index" data-v-cf652a9b><!--[-->关于知识库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-8a7fe2f1 data-v-cf652a9b><a class="VPLink link" href="/about/me" data-v-cf652a9b><!--[-->关于我<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-1d72176a data-v-b9e77edf data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-f18e2dbf><span class="text" data-v-f18e2dbf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-f18e2dbf><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-f18e2dbf><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><!----><!--[--><!--[--><div class="items" data-v-b9e77edf><p class="title" data-v-b9e77edf>中文</p><!--[--><div class="VPMenuLink" data-v-b9e77edf data-v-cf652a9b><a class="VPLink link" href="/en/blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3" data-v-cf652a9b><!--[-->English<!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-1d72176a data-v-c2c90abb><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-c2c90abb data-v-1502017d data-v-54e1997a><span class="check" data-v-54e1997a><span class="icon" data-v-54e1997a><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1502017d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1502017d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-1d72176a data-v-804ae77e data-v-f57dd261><!--[--><a class="VPSocialLink no-icon" href="https://github.com/cr7258/cr7258.github.io" aria-label="github" target="_blank" rel="noopener" data-v-f57dd261 data-v-19217157><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-1d72176a data-v-3893c6ae data-v-f18e2dbf><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-f18e2dbf><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-f18e2dbf><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-f18e2dbf><div class="VPMenu" data-v-f18e2dbf data-v-8a7fe2f1><!----><!--[--><!--[--><div class="group translations" data-v-3893c6ae><p class="trans-title" data-v-3893c6ae>中文</p><!--[--><div class="VPMenuLink" data-v-3893c6ae data-v-cf652a9b><a class="VPLink link" href="/en/blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3" data-v-cf652a9b><!--[-->English<!--]--></a></div><!--]--></div><div class="group" data-v-3893c6ae><div class="item appearance" data-v-3893c6ae><p class="label" data-v-3893c6ae>切换日光/暗黑模式</p><div class="appearance-action" data-v-3893c6ae><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-3893c6ae data-v-1502017d data-v-54e1997a><span class="check" data-v-54e1997a><span class="icon" data-v-54e1997a><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-1502017d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-1502017d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-3893c6ae><div class="item social-links" data-v-3893c6ae><div class="VPSocialLinks social-links-list" data-v-3893c6ae data-v-f57dd261><!--[--><a class="VPSocialLink no-icon" href="https://github.com/cr7258/cr7258.github.io" aria-label="github" target="_blank" rel="noopener" data-v-f57dd261 data-v-19217157><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-1d72176a data-v-a6ca9ab6><span class="container" data-v-a6ca9ab6><span class="top" data-v-a6ca9ab6></span><span class="middle" data-v-a6ca9ab6></span><span class="bottom" data-v-a6ca9ab6></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-03322d68 data-v-b9e3214b><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-b9e3214b><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-b9e3214b><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-b9e3214b>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-b9e3214b data-v-06057024><button data-v-06057024>返回顶部</button><!----></div></div><aside class="VPSidebar" data-v-03322d68 data-v-802ad7d8><div class="curtain" data-v-802ad7d8></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-802ad7d8><span class="visually-hidden" id="sidebar-aria-label" data-v-802ad7d8> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-802ad7d8><section class="VPSidebarItem level-0 collapsible" data-v-802ad7d8 data-v-95d837d1><div class="item" role="button" tabindex="0" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><h2 class="text" data-v-95d837d1><img class="chinese-zodiac" style="position: static; vertical-align: middle; padding-bottom: 3px;" src="/img/svg/chinese-zodiac/rabbit.svg" title="兔年" alt="生肖">
            2023年 (7篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-95d837d1><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-95d837d1><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-95d837d1><!--[--><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/07-git-cheat-sheet-3" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>Git 速查表：专家必备的 14 个 Git 命令</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/06-git-cheat-sheet-2" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-orange mr-[6px]" style="font-weight: 550; display: inline-block;">2</div>Git 速查表：中级用户必备的 12 个 Git 命令</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/05-git-cheat-sheet-1" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-yellow mr-[6px]" style="font-weight: 550; display: inline-block;">3</div>Git 速查表：初学者必备的 12 个 Git 命令</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/04-life-of-a-packet-in-kubernetes-part-4" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">4</div>Kubernetes 中数据包的生命周期 -- 第 4 部分</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">5</div>Kubernetes 中数据包的生命周期 -- 第 3 部分</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/02-life-of-a-packet-in-kubernetes-part-2" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">6</div>Kubernetes 中数据包的生命周期 -- 第 2 部分</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-95d837d1 data-v-95d837d1><div class="item" data-v-95d837d1><div class="indicator" data-v-95d837d1></div><a class="VPLink link link" href="/blogs/translate/2023/01-life-of-a-packet-in-kubernetes-part-1" data-v-95d837d1><!--[--><p class="text" data-v-95d837d1><div class="text-color-gray mr-[6px]" style="font-weight: 550; display: inline-block;">7</div>Kubernetes 中数据包的生命周期 -- 第 1 部分</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-03322d68 data-v-2c336b25><div class="VPDoc has-sidebar has-aside" data-v-2c336b25 data-v-53ed897c><!--[--><!--]--><div class="container" data-v-53ed897c><div class="aside" data-v-53ed897c><div class="aside-curtain" data-v-53ed897c></div><div class="aside-container" data-v-53ed897c><div class="aside-content" data-v-53ed897c><div class="VPDocAside" data-v-53ed897c data-v-3d450548><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3d450548 data-v-70b38f01><div class="content" data-v-70b38f01><div class="outline-marker" data-v-70b38f01></div><div class="outline-title" role="heading" aria-level="2" data-v-70b38f01>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-70b38f01><span class="visually-hidden" id="doc-outline-aria-label" data-v-70b38f01> Table of Contents for current page </span><ul class="root" data-v-70b38f01 data-v-e10534d6><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3d450548></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-53ed897c><div class="content-container" data-v-53ed897c><!--[--><!--]--><!----><main class="main" data-v-53ed897c><div style="position:relative;" class="vp-doc _blogs_translate_2023_03-life-of-a-packet-in-kubernetes-part-3" data-v-53ed897c><div><h1 id="kubernetes-中数据包的生命周期-第-3-部分" tabindex="-1">Kubernetes 中数据包的生命周期 -- 第 3 部分 <a class="header-anchor" href="#kubernetes-中数据包的生命周期-第-3-部分" aria-label="Permalink to &quot;Kubernetes 中数据包的生命周期 -- 第 3 部分&quot;">​</a></h1><!----><blockquote><p>本文翻译自：<a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f" target="_blank" rel="noreferrer">Life of a Packet in Kubernetes — Part 3 [1]</a><br> 作者：Dinesh Kumar Ramasamy<br> 本文在原文的基础上做了适当的修改，如有疑问请查阅原文。</p></blockquote><p>本文是 Kubernetes 中数据包的生命周期系列文章的第 3 部分。我们将讨论 Kubernetes 的 <code>kube-proxy</code> 组件如何使用 <code>iptables</code> 来控制流量。 了解 <code>kube-proxy</code> 在 Kubernetes 环境中的作用以及它如何使用 <code>iptables</code> 来控制流量非常重要。</p><p>本文包含以下章节：</p><ul><li>1.Pod-to-Pod</li><li>2.Pod-to-External</li><li>3.Pod-to-Service</li><li>4.NodePort（External-to-Pod）</li><li>5.External Traffic Policy</li><li>6.Kube-Proxy</li><li>7.iptables 规则处理流程</li><li>8.Headless Service</li><li>9.Network Policy</li></ul><h2 id="_1-pod-to-pod" tabindex="-1">1 Pod-to-Pod <a class="header-anchor" href="#_1-pod-to-pod" aria-label="Permalink to &quot;1 Pod-to-Pod&quot;">​</a></h2><p><code>kube-proxy</code> 不会参与 Pod 之间的通信，因为 CNI 会为 Node 和 Pod 配置所需的路由。所有容器都可以在没有 NAT 的情况下与其他容器进行通信。所有节点都可以在没有 NAT 的情况下与容器通信（反之亦然）。</p><p>注意：Pod 的 IP 地址不是静态的（静态 IP 有多种配置方式，但默认配置不保证静态 IP 地址）。当 Pod 重启时，CNI 会为 Pod 分配一个新的 IP 地址，因为 CNI 不会维护 Pod 和 IP 地址之间的映射关系。另外，通过 Deployment 方式部署的 Pod 的名字也不是静态的。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220427202448.png" alt=""></p><p>实际上，通过 Deployment 部署的 Pod 应该使用负载均衡类型的实体来发布服务，因为应用程序是无状态的，并且通常会有多个 Pod 托管应用程序。负载均衡器类型的实体在 Kubernetes中称为 <strong>Service</strong>。</p><h2 id="_2-pod-to-external" tabindex="-1">2 Pod-to-external <a class="header-anchor" href="#_2-pod-to-external" aria-label="Permalink to &quot;2 Pod-to-external&quot;">​</a></h2><p>对于从 Pod 到外部地址的流量，Kubernetes 使用 SNAT（源地址转换）。它所做的是将 <strong>Pod IP:Port</strong> 替换为<strong>主机 IP:Port</strong>。当返回的数据包到主机时，主机会修改数据包中的目标 IP 和端口为 <strong>Pod IP:Port</strong>，并将数据包发回原始的 Pod。整个过程对原始 Pod 是透明的，Pod 并不知道发生了地址转换。</p><h2 id="_3-pod-to-service" tabindex="-1">3 Pod-to-Service <a class="header-anchor" href="#_3-pod-to-service" aria-label="Permalink to &quot;3 Pod-to-Service&quot;">​</a></h2><p>Kubernetes 中有一个叫做 <strong>Service</strong> 的概念，它是 Pod 前面的 L4 负载均衡器。在 Kubernetes 中有几种不同类型的 Service，最基本的类型称为 ClusterIP。这种类型的 Service 有一个唯一的 VIP 地址，只能在集群内部路由。</p><p>仅仅通过 Pod IP 将流量发送到特定的应用程序并不容易。Kubernetes 集群的动态特性意味着 Pod 可以被移动，重启，升级或者扩缩容。此外，一些服务会有很多副本，因此我们需要一些方法来平衡它们之间的负载。</p><p>Kubernetes 通过 Service 解决了这个问题。Service 是一个 API 对象，它将单个虚拟 IP（VIP）映射到一组 Pod IP。此外，Kubernetes 还为每个 Service 的 VIP 提供了 DNS 的解析条目，以便可以轻松通过域名来访问 Service。</p><p>集群内 VIP 到 Pod IP 的映射由每个节点上的 <code>kube-proxy</code> 进程协调。kube-proxy 通过设置 iptables 或者 IPVS 规则将目的地址是 Service VIP 的请求转换为 Pod IP。请求建立的连接会被追踪，因此数据包从 Pod 返回时可以正确地转换为 Service 的 VIP 再响应客户端。IPVS 和 iptables 可以将单个 Service 的 VIP 负载均衡到多个 Pod IP，IPVS 和 iptables 相比有着更好的性能和更灵活的负载均衡算法。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430155411.png" alt=""> 接下来创建 FrontEnd 和 Backend 两个 Deployment，并通过 ClusterIP 类型的 Service 作为负载均衡。</p><p><strong>FrontEnd Deployment:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span></code></pre></div><p><strong>Backend Deployment:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span></code></pre></div><p><strong>Service:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ClusterIP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">auth</span></span></code></pre></div><p>现在 FrontEnd Pod 可以通过 ClusterIP 或者 Kubernetes 添加的 <strong>DNS</strong> 条目访问 Backend。一个集群感知的 DNS 服务器，例如 CoreDNS，监视 Kubernetes API 获取新创建的服务，并为每个服务创建一组 DNS 记录。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430160235.png" alt=""></p><blockquote><p>“普通“服务（除了无头服务）会以 <code>your-svc.your-namespace.svc.cluster.local</code> 这种名字的形式分配一个 DNS 记录。 该名称会解析成对应 Service 的 ClusterIP。</p></blockquote><h2 id="_4-nodeport-external-to-pod" tabindex="-1">4 NodePort（External-to-Pod） <a class="header-anchor" href="#_4-nodeport-external-to-pod" aria-label="Permalink to &quot;4 NodePort（External-to-Pod）&quot;">​</a></h2><p>现在我们可以在集群内部通过 VIP 或者域名访问 Service。<strong>然而，由于 VIP 是虚拟和私有的，此时外部请求还无法到达集群内的 Service</strong>。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430161334.png" alt=""></p><p>让我们创建一个 NodePort 类型的服务将 FrontEnd 服务暴露到集群外部。如果将 Service 的 <code>type</code> 字段设置为 <code>NodePort</code> 时，Kubernetes 会为该服务分配一个随机端口。端口的默认范围是 30000-32767，可以通过 API Server 的 <code>--service-node-port-range</code> 参数进行设置。每个节点会将访问 nodePort 端口（每个端口号相同）的请求代理到你的 Service。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NodePort</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 将 Service 设置为 NodePort 类型</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the `targetPort` is set to the same value as the `port` field.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # Optional field</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      nodePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">31380</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 指定端口</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430162259.png" alt=""></p><p>现在我们可以在集群外部通过 &lt;任何一个节点 IP&gt;:&lt;nodePort 端口&gt; 访问 FrontEnd Service 了。如果你需要指定特定的端口号，那么可以在 <code>nodePort</code> 字段中进行设置。这意味着你需要自己处理可能的端口冲突，同时你还必须使用一个有效的端口号，当设置的 nodePort 冲突或超过范围时，API Server 会返回错误信息。</p><h2 id="_5-external-traffic-policy" tabindex="-1">5 External Traffic Policy <a class="header-anchor" href="#_5-external-traffic-policy" aria-label="Permalink to &quot;5 External Traffic Policy&quot;">​</a></h2><p>ExternalTrafficPolicy 表示该 Service 是否希望将外部流量路由到节点本地或集群范围的端点。<strong>Local</strong> 表示保留客户端的源 IP，并且 NodePort 或者 LoadBalancer 类型的 Service 将不会把流量分发到其他节点上的 Pod，这样可以避免产生额外的网络跳数，与此同时可能会存在流量传播不平衡的风险。<strong>Cluster</strong> 隐藏了客户端的源 IP，并且可能会将流量分发到其他节点上的 Pod， 此时会产生额外的网络跳数，但这样会具有良好的整体负载均衡。</p><h3 id="_5-1-cluster-traffic-policy" tabindex="-1">5.1 Cluster Traffic Policy <a class="header-anchor" href="#_5-1-cluster-traffic-policy" aria-label="Permalink to &quot;5.1 Cluster Traffic Policy&quot;">​</a></h3><p>Cluster Traffic Policy 是 Kubernetes Service <strong>默认</strong>的 ExternalTrafficPolicy 策略。这里假设的是，你总是希望将流量平衡地路由到 Service 下的所有 Pod。</p><p>使用此策略的一个注意事项是，当外部流量访问 NodePort Service 时，你可能会在节点之间看到不必要的网络跃点。例如，当通过 NodePort 接收外部流量，NodePort Service 可能会（随机）将流量路由到另一台主机上的 Pod，而它本来可以将流量路由到同一主机上的 Pod，从而避免额外的网络跳数。</p><p><strong>Cluster</strong> Traffic Policy 中数据包的流量如下：</p><ul><li>客户端发送数据包到 <code>Node2:3138</code>。</li><li><code>Node2</code> 将数据包的目标 IP 通过 <strong>DNAT</strong>（目标地址）转换为 Pod IP。</li><li><code>Node2</code> 将数据包的源 IP 通过 <strong>SNAT</strong>（源地址转换）转换为 <code>Node2</code> 自身的 IP。</li><li>数据包路由到 Node1 或者 Node3，然后交给节点上的 Pod。</li><li>Pod 的响应回到 <code>Node2</code>，源 IP 是 Pod IP，目标 IP 是 <code>Node2</code> 的 IP。</li><li><code>Node2</code> 将 Pod 返回数据包的源 IP 修改为 <code>Node2</code> 的 IP，目标 IP 修改为客户端的 IP，然后响应客户端。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220430164546.png" alt=""></p><h3 id="_5-2-local-traffic-policy" tabindex="-1">5.2 Local Traffic Policy <a class="header-anchor" href="#_5-2-local-traffic-policy" aria-label="Permalink to &quot;5.2 Local Traffic Policy&quot;">​</a></h3><p>当使用 Local Traffic Policy 策略时，kube-proxy 将仅为同一节点（本地）上的 Pod 添加代理规则，而不是为 Service 的每个 Pod 添加代理规则。此时 kube-proxy 只会将请求代理到本地端点，而不会将流量转发到其他节点。<strong>这样可以保留原始的源 IP 地址。</strong> 如果没有本地端点，则丢弃发送到节点的数据包。</p><p>如果你尝试在 Serivce 上设置 <code>externalTrafficPolicy: Local</code>，Kubernetes API 将要求你使用 LoadBalancer 或 NodePort 类型的 Service。这是因为 Local 模式的 ExternalTrafficPolicy 策略仅与外部流量相关，因此只适用于这两种类型的 Service。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">frontend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NodePort</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  externalTrafficPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Local</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # 仅转发到本地 Pod，保留客户端源 IP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">webapp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the `targetPort` is set to the same value as the `port` field.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # Optional field</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      # By default and for convenience, the Kubernetes control plane will allocate a port from a range (default: 30000-32767)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      nodePort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">31380</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p><strong>Local</strong> Traffic Policy 中数据包的流量如下：</p><ul><li>客户端发送数据包到 <code>Node1:31380</code>，该节点上有 FrontEnd 的 Pod。</li><li>Node1 将数据包路由到本地的 Pod，保留正确的源 IP。</li><li>由于设置了 Local 的转发策略，因此 Node1 不会将数据包路由到 Node3。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501193843.png" alt=""></p><ul><li>客户端发送数据包到 <code>Node2:31380</code>，该节点上没有 FrontEnd 的 Pod。</li><li>数据包将会被 Node2 丢弃。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501194355.png" alt=""></p><h3 id="_5-3-local-traffic-policy-in-loadbalancer-service-type" tabindex="-1">5.3 Local traffic policy in LoadBalancer Service type <a class="header-anchor" href="#_5-3-local-traffic-policy-in-loadbalancer-service-type" aria-label="Permalink to &quot;5.3 Local traffic policy in LoadBalancer Service type&quot;">​</a></h3><p>当你将公有云的 Kubernetes 服务（例如 Google Kubernetes Engine，GCE）中的 Service 设置为 <code>externalTrafficPolicy: Local</code> 时，如果节点中没有 Service 对应的 Pod，将不会通过负载均衡器（LB）的健康检查而被移出转发列表，在这种情况下不会发生数据包的丢弃。这种模式非常适合有大量的入访流量，同时希望避免网络上不必要的跃点以减少延迟的应用程序。同时我们还可以保留真正的客户端 IP，因为我们不再需要来自代理节点的 SNAT 流量！然而，正如 Kubernetes 文档中提到的，使用 Local traffic policy 策略的最大缺点是应用程序的流量可能不平衡。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220501194522.png" alt=""></p><h2 id="_6-kube-proxy-iptable-mode" tabindex="-1">6 Kube-Proxy (iptable mode) <a class="header-anchor" href="#_6-kube-proxy-iptable-mode" aria-label="Permalink to &quot;6 Kube-Proxy (iptable mode)&quot;">​</a></h2><p>Kubernetes 中实现 Service 的组件称为 <strong>kube-proxy</strong>。它位于每个节点上，编写复杂的 iptables 规则以在 Pod 和 Service 之间进行各种过滤和 NAT。如果你到 Kubernetes 节点上执行 <code>iptables-save</code> 命令，你将能够看到 Kubernetes 或者其他程序插入的 iptables 规则。其中最重要的链是  <code>KUBE-SERVICES</code>, <code>KUBE-SVC-*</code> 和 <code>KUBE-SEP-*</code>。</p><ul><li><code>KUBE-SERVICES</code> 链是访问 Service 的入口，它的作用是匹配目标 IP:Port 并将数据包分发到相应的 <code>KUBE-SVC-*</code> 链。</li><li><code>KUBE-SVC-*</code> 链充当负载均衡器（Service），将数据包平均分配到 <code>KUBE-SEP-*</code> 链。每个 <code>KUBE-SVC-*</code> 链中含有与其后面端点数量相同的 <code>KUBE-SEP-*</code> 链。</li><li><code>KUBE-SEP-*</code> 链代表一个服务端点（Pod），它只做 DNAT，将 Service 的 IP:Port 替换为 Pod 的 IP:Port。</li></ul><p>对于 DNAT，conntrack 会跟踪连接状态，因为它需要记住修改的目标地址，以便数据包返回时将其更改回来。iptables 还可以依靠 conntrack 状态 (ctstate) 来决定数据包的命运。这 4 个 conntrack 状态尤其重要：</p><ul><li><strong>NEW</strong>：一个连接的初始状态（例如：TCP 连接中，一个 SYN 包的到来）。</li><li><strong>ESTABLISHED</strong>：连接已经建立完成。</li><li><strong>RELATED</strong>：这是一个关联连接，是一个主链接的子连接，例如 FTP 的数据通道的连接。</li><li><strong>INVALID</strong>：这是一个特殊的状态，用于记录那些没有按照预期行为进行的连接。</li></ul><p>以下是 Pod 和 Service 之间连接的工作方式，事件的顺序如下：</p><ul><li>左侧的客户端 Pod 向 Service 2.2.2.10:80 发送数据包。</li><li>数据包在客户端节点经过 iptables 规则，目的 IP 被更改为服务端 Pod IP（1.1.1.20:80）。</li><li>数据包返回客户端节点，conntrack 识别到数据包并将源地址重写回 2.2.2.2:80。</li><li>客户端 Pod 收到响应数据包。</li></ul><p><strong>GIF 动图演示：</strong></p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/1_1u1d1WU1SqTiiJFyHO-X_A.gif" alt=""></p><h2 id="_7-iptables-规则处理流程" tabindex="-1">7 Iptables 规则处理流程 <a class="header-anchor" href="#_7-iptables-规则处理流程" aria-label="Permalink to &quot;7 Iptables 规则处理流程&quot;">​</a></h2><p><code>netfilter</code> 是 Linux 内核中一个对数据包进行控制、修改和过滤的框架。<code>iptables</code> 是配置 <code>netfilter</code> 过滤功能的用户空间工具。</p><h3 id="_7-1-chains-链" tabindex="-1">7.1 Chains 链 <a class="header-anchor" href="#_7-1-chains-链" aria-label="Permalink to &quot;7.1 Chains 链&quot;">​</a></h3><p>iptables 中有 5 条链，每条链负责一个特定的任务：</p><ul><li><strong>PREROUTING</strong>：在数据包做路由选择前应用此链路中的规则，所有的数据包进来时都先由这条链处理。</li><li><strong>INPUT</strong>：经过路由表判断后，目的为本机的数据包应用这条链上的策略。</li><li><strong>FORWARD</strong>：经过路由表判断后，目标地址不为本机，转发数据包时应用这条链上的策略。</li><li><strong>OUTPUT</strong>：由本机产生的往外发送的数据包应用这条链中的策略。</li><li><strong>POSTROUTING</strong>：数据包发送到网卡之前应用这条链中的策略，所有的数据包出来的时候都由这条链处理。</li></ul><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220503203749.png" alt=""></p><ul><li>进入的数据包目的是本机：<code>PREROUTING -&gt; INPUT</code>。</li><li>进入的数据包目的是其他主机：<code>PREROUTING -&gt; FORWARD -&gt; POSTROUTING</code>。</li><li>本机产生的数据包：<code>OUTPUT -&gt; POSTROUTING</code>。</li></ul><p><strong>FORWARD</strong> 链仅当 Linux 服务器中启用 <code>ip_forward</code> 时才有效，这就是以下命令在设置和调试 Kubernetes 集群时很重要的原因。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">node-1#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sysctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -w</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> net.ipv4.ip_forward=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">net.ipv4.ip_forward</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">node-1#</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /proc/sys/net/ipv4/ip_forward</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1</span></span></code></pre></div><p>上述命令的修改不是永久的，要在 Linux 系统上永久启用 IP 转发，请编辑 <em>/etc/sysctl.conf</em> 并添加以下内容：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">net.ipv4.ip_forward</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span></code></pre></div><h3 id="_7-2-tables-表" tabindex="-1">7.2 Tables 表 <a class="header-anchor" href="#_7-2-tables-表" aria-label="Permalink to &quot;7.2 Tables 表&quot;">​</a></h3><p>iptables 中有 5 种表：</p><ul><li><strong>Filter</strong>：这是默认的表，用于过滤数据包。</li><li><strong>NAT</strong>：网络地址转换（端口映射、地址映射等）。</li><li><strong>Mangle</strong>：主要功能是根据规则修改数据包的一些标志位，以便其他规则或程序可以利用这些标志对数据包进行过滤或策略路由。</li><li><strong>Raw</strong>：设置 RAW 表时一般是为了不再让 iptables 做数据包的链接跟踪处理，以提高性能。</li><li><strong>Security</strong>：用于在数据包上设置内部 SELinux 安全上下文标记。</li></ul><h3 id="_7-3-kubernetes-中的-iptables-配置" tabindex="-1">7.3 Kubernetes 中的 iptables 配置 <a class="header-anchor" href="#_7-3-kubernetes-中的-iptables-配置" aria-label="Permalink to &quot;7.3 Kubernetes 中的 iptables 配置&quot;">​</a></h3><p>让我们在 Kubernetes 中部署一个副本数为 2 的 Nginx 应用程序并查看 iptables 规则。Service 类型：<strong>NodePort</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:31380/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d13h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get ep webapp </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ENDPOINTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.102:80,10.244.120.103:80</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d13h</span></span></code></pre></div><p>ClusterIP 在主机的接口上并不存在，它的虚拟 IP 存在于 iptables 规则中，在 CoreDNS 中添加了下面这个 DNS 条目。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -i -t dnsutils -- nslookup webapp.default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Server:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  10.96</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.10</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.96</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.10#53</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> webapp.default.svc.cluster.local</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Address:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span></span></code></pre></div><p>Kubernetes 在 iptables 中创建了 KUBE-SERVICES 链以便对数据包进行过滤和 NAT。它将会把所有 PREROUTING 和 OUTPUT 链的流量重定向到 KUBE-SERVICES 链上。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PREROUTING</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            PREROUTING</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (policy  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">ACCEPT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                      </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cali-PREROUTING</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        cali:6gwbT8clXdHdC1b1</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                 </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SERVICES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   portals</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DOCKER</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">         --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                  dst-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  LOCAL</span></span></code></pre></div><p>在将 KUBE-SERVICES 链用于包过滤和 NAT 后，Kubernetes 可以检查到 Service 的流量并相应地应用 SNAT/DNAT。在 KUBE-SERVICES 链的末端，它将插入另一个自定义链 KUBE-NODEPORTS 来处理 Service 类型是 NodePort 的流量。</p><p>如果流量是针对 ClusterIP 的，<strong>KUBE-SVC-2IRACUALRELARSND</strong> 链会处理流量；否则，下一条链将处理流量，即 <strong>KUBE-NODEPORTS</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SERVICES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-SERVICES</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (2   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   !10.244.0.0/16</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                   cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   dpt:www</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                          </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        10.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.46.104</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                   cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   dpt:www</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                                                                                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-NODEPORTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">            --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  kubernetes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  nodeports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;  </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NOTE:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  this</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  must</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        be</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  the</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  last</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  rule</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  this</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dst-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  LOCAL</span></span></code></pre></div><p>让我们查看一下 <strong>KUBE-NODEPORTS</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)     </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                               </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">             tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dpt:31380</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  dpt:31380</span></span></code></pre></div><p>可以看到 <strong>KUBE-NODEPORTS</strong> 链最终也会将流量送到 <strong>KUBE-SVC-2IRACUALRELARSND</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># statistic  mode  random -&gt; Random load-balancing between endpoints.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Service 的流量随机分发给两个 Pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                      KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (2   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                                                             </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                     prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Pod1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  statistic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  mode</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  random</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  probability</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  0.50000000000</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Pod2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 流量分发到 Pod1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           KUBE-SEP-AO6KYGU752IZFEZ4</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.102</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DNAT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  to:10.244.120.102:80</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 流量分发到 Pod2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           KUBE-SEP-PJFBSHHDX4VZAOXM</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (1   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">                               </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.103</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">       </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">DNAT</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">                        --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  to:10.244.120.103:80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 源地址转换</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-MARK-MASQ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> column</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   KUBE-MARK-MASQ</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  (24  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)                         </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">            opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">MARK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    all</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">             --</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     MARK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  or</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  0x4000</span></span></code></pre></div><p>总结一下： <strong>ClusterIP</strong>: KUBE-SERVICES → KUBE-SVC-XXX → KUBE-SEP-XXX。 <strong>NodePort</strong>: KUBE-SERVICES → KUBE-NODEPORTS → KUBE-SVC-XXX → KUBE-SEP-XXX。</p><p>注意：NodePort 类型的 Service 将分配一个 ClusterIP 来处理内部和外部流量。</p><p>上述规则的示意图如下：</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220503213518.png" alt=""><strong>ExtrenalTrafficPolicy: Local</strong> 如前所述，使用 externalTrafficPolicy: Local 将保留源 IP 并丢弃没有本地端点的数据包。让我们来看看没有本地端点的节点中的 iptables 规则。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get nodes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">           STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">minikube</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    master</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   6</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">d1h</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   v1.19.2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">minikube-m02</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   Ready</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   85</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    v1.19.2</span></span></code></pre></div><p>这次只部署 1 个 Nginx Pod，Service 设置为 externalTrafficPolicy: Local。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get pods nginx-deployment-7759cc5c66-p45tz -o wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                                READY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       NOMINATED</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   READINESS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> GATES</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">nginx-deployment-7759cc5c66-p45tz</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">          29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.111</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   minikube</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">           &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span></span></code></pre></div><p>检查 externalTrafficPolicy。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp -o wide -o jsonpath={.spec.externalTrafficPolicy}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Local</span></span></code></pre></div><p>获取 Service。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp -o wide</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">     TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">      EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)        </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   SELECTOR</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   NodePort</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.111</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.243.62</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">   &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">:30080/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   29</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   app=webserver</span></span></code></pre></div><p>让我们检查 minikube-m02 节点中的 iptables 规则，<strong>应该有一个 DROP 规则来丢弃数据包，因为该节点上没有 Nginx Pod</strong>。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span></code></pre></div><p>检查 <strong>KUBE-XLB-2IRACUALRELARSND</strong> 链。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Redirect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pods</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> trying</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reach</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> external</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loadbalancer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> masquerade</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 丢弃没有本地端点的数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-DROP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> has</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> no</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> endpoints</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span></code></pre></div><p>查看 minikube 节点的 iptables，该节点上有 Nginx Pod，因此不会丢弃数据包。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># NodePort 规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-NODEPORTS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 127.0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> tcp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> dpt:30080</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 不会丢弃数据包，最后没有 DROP 规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-XLB-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (1 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.0/16</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Redirect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> pods</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> trying</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> reach</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> external</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> loadbalancer</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> VIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> clusterIP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-MARK-MASQ</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> masquerade</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> route</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> traffic</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LB</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> service</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> chain</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ADDRTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> match</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src-type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> LOCAL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-5T4S2ILYSXWY3R2J</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Balancing</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> rule</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Service 规则，将流量分发到 Pod</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> nat</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Chain</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> KUBE-SVC-2IRACUALRELARSND</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (3 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">references</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">target</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> prot</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> opt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> source</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> destination</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">KUBE-SEP-5T4S2ILYSXWY3R2J</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> all</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> —</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> anywhere</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> default/webapp</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/</span></span></code></pre></div><h2 id="_8-headless-service" tabindex="-1">8 Headless Service <a class="header-anchor" href="#_8-headless-service" aria-label="Permalink to &quot;8 Headless Service&quot;">​</a></h2><p>有的应用并不需要负载均衡和服务 IP。在这种情况下就可以使用 Headless Service，只要设置 <code>.spec.clusterIP</code> 为 <code>None</code> 即可。</p><p>可以借助这种服务类型和其他服务发现机制协作，无需和 Kubernetes 绑定。Headless Service 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 另外，DNS 的配置要根据 selector 来确定。</p><p><strong>带选择器（selector）的服务</strong></p><p>定义了 selector 的 Headless Service，Endpoint 控制器会创建 Endpoints 记录， 并修改 DNS 记录，通过域名可以直接访问 <code>Service</code> 的后端 Pod 。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get svc webapp-hs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        TYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        CLUSTER-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   EXTERNAL-IP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">S</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)   </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp-hs</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ClusterIP</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   None</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">         &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">        80</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/TCP</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    24</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl get ep webapp-hs</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        ENDPOINTS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                             AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">webapp-hs</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.244</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.120.109:80,10.244.120.110:80</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   31</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">s</span></span></code></pre></div><p><strong>无选择器的服务</strong></p><p>没有定义 selector 的 Headless Service，也就没有 Endpoint 记录。然而 DNS 系统会尝试配置：</p><ul><li><code>ExternalName</code> 类型的服务，会产生 <code>CNAME</code> 记录。</li><li>所有其他类型的服务，查找与 Service 名称相同的 <code>Endpoints</code> 的记录。</li></ul><h2 id="_9-network-policy" tabindex="-1">9 Network Policy <a class="header-anchor" href="#_9-network-policy" aria-label="Permalink to &quot;9 Network Policy&quot;">​</a></h2><p>到目前为止，你可能已经了解了 Kubernetes 中的网络策略是如何实现的。是的，又是 <strong>iptables</strong>；CNI 负责实施网络策略，而不是 <strong>kube-proxy</strong>。</p><p>让我们创建 3 个服务：FrontEnd, Backend 和 DB。默认情况下，Pod 是非隔离的；他们接受来自任何来源的流量。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220504172414.png" alt=""></p><p>但是，应该有一个网络策略将 DB pod 与 FrontEnd pod 隔离，以避免它们之间的任何流量。</p><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220504173902.png" alt=""></p><p>我们可以通过设置 NetworkPolicy 来实现网络策略，如果入访的 Pod 带有 <code>networking/allow-db-access: &quot;true&quot;</code> 标签，则允许访问 DB。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 网络策略</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 匹配应用策略的 Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;db&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 匹配入访 Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          networking/allow-db-access</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Backend 服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        networking/allow-db-access</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;true&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">  # 网络策略会允许有该标签的 Pod 访问 DB 服务</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        emptyDir</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">containerPort</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/usr/share/nginx/html</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      initContainers</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">install</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">busybox</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        imagePullPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        command</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;sh&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;-c&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;echo $HOSTNAME &gt; /work-dir/index.html&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">workdir</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">          mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;/work-dir&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>应用上面的 NetworkPolicy，可以看到 FrontEnd 可以正常访问 Backend，但是已经无法访问 DB 了。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -it frontend-8b474f47-zdqdv -- /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl backend</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">backend-867fd6dff-mjf92</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl db</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">curl:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (7) Failed to connect to db port 80: Connection timed out</span></span></code></pre></div><p>但是 Backend 依然可以访问 DB。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # kubectl exec -it backend-867fd6dff-mjf92 -- /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># curl db</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">db-8d66ff5f7-bp6kf</span></span></code></pre></div><p>如果使用的 CNI 是 Calico，Calico 会将 Kubernetes 的网络策略转换为 Calico 的格式。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # calicoctl get networkPolicy --output yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/v3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">items</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/v3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    creationTimestamp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;2020-11-05T05:26:27Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">knp.default.allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    resourceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/53872</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    uid</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">1b3eb093-b1a8-4429-a77d-a9a054a6ae90</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  spec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">action</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Allow</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      destination</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      source</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">        selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/orchestrator == &#39;k8s&#39; &amp;&amp; networking/allow-db-access</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          == &#39;true&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    order</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1000</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    selector</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">projectcalico.org/orchestrator == &#39;k8s&#39; &amp;&amp; app == &#39;db&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">    types</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">NetworkPolicyList</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  resourceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">56821/56821</span></span></code></pre></div><p>使用 calicoctl 获取工作负载端点的详细信息。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">master</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> # calicoctl get workloadEndpoint</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">WORKLOAD</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                         NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">       NETWORKS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        INTERFACE</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">         </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">backend-867fd6dff-mjf92</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.27/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali2b1490aa46a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">db-8d66ff5f7-bp6kf</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.26/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali95aa86cbb2a</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">   </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">frontend-8b474f47-zdqdv</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          minikube</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">   10.88</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">.0.24/32</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   cali505cfbeac50</span></span></code></pre></div><p><strong>cali95aa86cbb2a</strong> 是 DB pod 正在使用的 veth 对的主机端。我们来获取这个接口相关的 iptables 规则。从 iptables 规则中，可以看到只有数据包来着 Backend Pod 时才允许进入 DB Pod。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Calico iptables 规则链命名</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># cali-: 前缀，calico 的规则链 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># tw: 简写，to wordkoad endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># wl: 简写，workload endpoint</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># fw: 简写，from workload endpoint </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># from-XXX: XXX发出的报文 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># to-XXX: 发送到XXX的报文 </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pi: 简写，policy inbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># po: 简写，policy outbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pri: 简写，profile inbound</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># pro: 简写，profile outbound </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables-save</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali95aa86cbb2a</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 先检查 fw: from workload 的规则，再检查 tw: to workload 的规则，下面以 tw 的规则进行说明</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第一步：如果 conntrack 表中能够检索到该连接的状态，可以直接根据状态放行或者丢弃</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:eCrqwxNk3cKw9Eq6&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> conntrack</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --ctstate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RELATED,ESTABLISHED</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ACCEPT</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:_krp5nzavhAu5avJ&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> conntrack</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --ctstate</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> INVALID</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DROP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第二步：先对数据包进行标记，--set-xmark value[/mask]，value 表示要匹配的 mark 的值，mask 代表掩码，如果要完全匹配可以省略掉掩码</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 如果经过 Network Policy 后 mark 值没有修改，第七步会丢弃该数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:leBL64hpAXM9y4nk&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Start of policies&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MARK</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --set-xmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第三步（重点）：进入 cali-pi-_tTE-E7yY40ogArNVgKt 链进行 Network Policy 判断</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:pm-LK-c1ra31tRwz&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第六步：如果 Network Policy 检查通过（检查是否匹配 mark 0x10000/0x10000）, 匹配说明通过，直接 RETURN，不再检查其他的规则</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:q_zG8dAujKUIBe0Q&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Return if policy accepted&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RETURN</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第七步：如果 mark 没有修改，与原先一致，视为没有任何一个 Network Policy允许该包通过，丢弃数据包</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-tw-cali95aa86cbb2a</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:FUDVBYh1Yr6tVRgq&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Drop if no policies passed packet&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x20000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> DROP</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># Network Policy 规则判断</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> iptables-save</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> filter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第四步（重点）：如果源 IP 匹配 ipsetali40s:LrVD8vMIGQDyv8Y7sPFB1Ge，将数据包添加 mark 0x10000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:M4Und37HGrw6jUk8&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --match-set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> src</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> MARK</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --set-xmark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 第五步：检查是否匹配 mark，如果匹配就 RETURN 放行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">-A</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali-pi-_tTE-E7yY40ogArNVgKt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> comment</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --comment</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;cali:sEnlfZagUFRSPRoe&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --mark</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x10000</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/0x10000</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -j</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> RETURN</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">...</span></span></code></pre></div><p>Calico 使用 ipset 进行流量管理，ipset 是 iptables 的扩展，有以下几个优点：</p><ul><li>允许在一条规则中根据多个 IP 地址和端口号进行匹配。</li><li>允许针对 IP 地址或者端口号动态更新 iptables 规则。</li><li>ipset 使用 set 集合作为存储结构，set 在查询时十分高效。</li></ul><p>通过检查 ipset，很明显看到只允许从 Backend Pod 的 IP 10.88.0.27 访问 DB Pod。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[root@minikube /]# ipset list</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hash:net</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Revision:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 6</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Header:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> family</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> inet</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hashsize</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1024</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> maxelem</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1048576</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Size</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> memory:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 408</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">References:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Number</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> entries:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Members:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">10.88.0.27</span></span></code></pre></div><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><ul><li>[1] 原文: <a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f" target="_blank" rel="noreferrer">https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f</a></li><li>[2] iptables四表五链及规则组成: <a href="https://blog.csdn.net/wfs1994/article/details/89047230" target="_blank" rel="noreferrer">https://blog.csdn.net/wfs1994/article/details/89047230</a>)</li><li>[3] 使用 iptables、ipset 的全局智能代理: <a href="https://blog.chih.me/global-proxy-within-ipset-and-iptables.html" target="_blank" rel="noreferrer">https://blog.chih.me/global-proxy-within-ipset-and-iptables.html</a></li><li>[4] networkpolicy的实践--felix: <a href="https://segmentfault.com/a/1190000039030174" target="_blank" rel="noreferrer">https://segmentfault.com/a/1190000039030174</a></li><li>[5] calico iptables详解: <a href="https://blog.csdn.net/ptmozhu/article/details/73301971" target="_blank" rel="noreferrer">https://blog.csdn.net/ptmozhu/article/details/73301971</a></li><li>[6] iptables mark: <a href="https://www.kancloud.cn/pshizhsysu/linux/2084993" target="_blank" rel="noreferrer">https://www.kancloud.cn/pshizhsysu/linux/2084993</a></li></ul><h2 id="欢迎关注" tabindex="-1">欢迎关注 <a class="header-anchor" href="#欢迎关注" aria-label="Permalink to &quot;欢迎关注&quot;">​</a></h2><p><img src="https://chengzw258.oss-cn-beijing.aliyuncs.com/Article/20220104221116.png" alt=""></p></div></div></main><footer class="VPDocFooter" data-v-53ed897c data-v-f3af8004><!--[--><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--]--><div class="edit-info" data-v-f3af8004><div class="edit-link" data-v-f3af8004><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/cr7258/cr7258.github.io/edit/main/docs/blogs/translate/2023/03-life-of-a-packet-in-kubernetes-part-3.md" target="_blank" rel="noreferrer" data-v-f3af8004><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" aria-label="edit icon" data-v-f3af8004><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 不妥之处，敬请雅正<!--]--></a></div><div class="last-updated" data-v-f3af8004><p class="VPLastUpdated" data-v-f3af8004 data-v-a25eb6f3>最后更新: <time datetime="2024-02-06T13:56:38.000Z" data-v-a25eb6f3></time></p></div></div><nav class="prev-next" data-v-f3af8004><div class="pager" data-v-f3af8004><!----></div><div class="pager" data-v-f3af8004><a class="VPLink link pager-link next" href="/blogs/translate/2023/07-git-cheat-sheet-3" data-v-f3af8004><!--[--><span class="desc" data-v-f3af8004>下一篇</span><span class="title" data-v-f3af8004><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>Git 速查表：专家必备的 14 个 Git 命令</span><!--]--></a></div></nav></footer><!--[--><!--[--><!--[--><div id="comment-container"></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blogs_original_2022_08-reset-kafka-consumer-offset.md\":\"6Wb4wanx\",\"archives.md\":\"sznVMTjf\",\"blogs_original_2022_03-finalizer.md\":\"Hk0bFe5B\",\"courses_elastic-stack_01-elastic-stack-hands-on-lab_03-snapshot.md\":\"p1t2zAxM\",\"blogs_original_2023_08-cilium-cluster-mesh.md\":\"RBG-AdlN\",\"blogs_translate_2023_05-git-cheat-sheet-1.md\":\"a-Lf76jn\",\"blogs_translate_2023_04-life-of-a-packet-in-kubernetes-part-4.md\":\"Qvn3-_hM\",\"blogs_translate_2023_02-life-of-a-packet-in-kubernetes-part-2.md\":\"rYz5PV2m\",\"blogs_original_2022_06-kafka-setup.md\":\"nzSczB9o\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_04-fleet.md\":\"yMM7K3oO\",\"courses_elastic-stack_index.md\":\"FPyEnyhp\",\"en_about_index.md\":\"CpGKz0DC\",\"blogs_original_2022_01-kubernetes-setup.md\":\"RCgJ6rUL\",\"about_me.md\":\"NRnPyPRg\",\"blogs_original_index.md\":\"vfM463hu\",\"categories_fragments_index.md\":\"XvpRxPYr\",\"blogs_original_2022_12.lru.md\":\"mFa-V7xc\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_05-java-client.md\":\"SbYkZCzc\",\"blogs_translate_2023_07-git-cheat-sheet-3.md\":\"GToSaKGw\",\"categories_fragments_2023_01-find-docker-file.md\":\"i9_7kfib\",\"blogs_original_2023_09-clusterresourceset.md\":\"UC_w3-4L\",\"blogs_original_2022_10-harbor.md\":\"8QjM9szC\",\"blogs_original_2022_02-kubectl-debug.md\":\"3BAcT7o2\",\"courses_elastic-stack_01-elastic-stack-hands-on-lab_04-fleet.md\":\"VE3pgFfq\",\"en_about_me.md\":\"yvwryHCw\",\"blogs_translate_index.md\":\"IMpWbRHA\",\"courses_elastic-stack_01-elastic-stack-hands-on-lab_01-quick-start.md\":\"aam6_WID\",\"blogs_translate_2023_01-life-of-a-packet-in-kubernetes-part-1.md\":\"Vlgaz2U5\",\"index.md\":\"M2mpGzWe\",\"blogs_original_2022_11.nebula.md\":\"CO10r5AX\",\"blogs_original_2022_05-docker-rootless.md\":\"mHSHDkfX\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_02-ilm.md\":\"FQLMsJMP\",\"en_archives.md\":\"cGDMhZlH\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_01-quick-start.md\":\"ZuZ-QCaF\",\"courses_elastic-stack_01-elastic-stack-hands-on-lab_05-java-client.md\":\"NS4ZvaHe\",\"en_courses_elastic-stack_01-elastic-stack-hands-on-lab_03-snapshot.md\":\"GCKwtgVU\",\"blogs_original_2023_10-cilium-bgp.md\":\"TU2i5J0W\",\"blogs_original_2023_05-kubernetes-multi-cluster-1.md\":\"Pk6gveRm\",\"about_index.md\":\"mofEMKrn\",\"blogs_translate_2023_06-git-cheat-sheet-2.md\":\"hnlxPfH1\",\"blogs_original_2023_03-kubectl-patch.md\":\"jdaezYu0\",\"blogs_original_2023_01-argocd-quickstart.md\":\"Plyajdo5\",\"categories_issues_index.md\":\"t3YGlZ5B\",\"blogs_original_2022_13-envoy-quickstart.md\":\"gnbAs_d3\",\"blogs_original_2022_07-kafka-big-message.md\":\"YlhvnuvS\",\"en_courses_elastic-stack_index.md\":\"klxhsHGa\",\"categories_tools_index.md\":\"6Nyd7_mG\",\"en_index.md\":\"G77ErWAX\",\"en_tags.md\":\"UPOBTY6E\",\"blogs_original_2022_04-kubeasz.md\":\"DIDwpxGe\",\"tags.md\":\"qho233a9\",\"blogs_original_2023_06-kubernetes-multi-cluster-2.md\":\"BRVfBDyq\",\"categories_open-source_index.md\":\"iJJiH33M\",\"blogs_original_2023_07-vcluster.md\":\"QBabGvPy\",\"blogs_original_2022_09-pulsar.md\":\"RVUQ83Fq\",\"courses_elastic-stack_01-elastic-stack-hands-on-lab_02-ilm.md\":\"sflxgxT4\",\"blogs_translate_2023_03-life-of-a-packet-in-kubernetes-part-3.md\":\"-G3E6Jdg\",\"blogs_original_2023_02-wasm-in-cloud-native.md\":\"ayubGeRu\",\"blogs_original_2023_04-kubernetes-keycloak-oidc.md\":\"9A4TjxfQ\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"Se7en的架构笔记\",\"description\":\"个人技术知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"博客\",\"items\":[{\"text\":\"原创\",\"link\":\"/blogs/original/index\",\"activeMatch\":\"/blogs/original/\"},{\"text\":\"翻译\",\"link\":\"/blogs/translate/index\",\"activeMatch\":\"/blogs/translate/\"}],\"activeMatch\":\"/blogs/\"},{\"text\":\"我的分类\",\"items\":[{\"text\":\"Bug万象集\",\"link\":\"/categories/issues/index\",\"activeMatch\":\"/categories/issues/\"},{\"text\":\"个人速查手册\",\"link\":\"/categories/fragments/index\",\"activeMatch\":\"/categories/fragments/\"},{\"text\":\"精选工具箱\",\"link\":\"/categories/tools/index\",\"activeMatch\":\"/categories/tools/\"},{\"text\":\"开源项目\",\"link\":\"/categories/open-source/index\",\"activeMatch\":\"/categories/open-source/\"}],\"activeMatch\":\"/categories/\"},{\"text\":\"我的小册\",\"items\":[{\"text\":\"Elastic Stack 教程\",\"link\":\"/courses/elastic-stack/index\",\"activeMatch\":\"/courses/elastic-stack/\"}],\"activeMatch\":\"/courses/\"},{\"text\":\"我的标签\",\"link\":\"/tags\",\"activeMatch\":\"/tags\"},{\"text\":\"我的归档\",\"link\":\"/archives\",\"activeMatch\":\"/archives\"},{\"text\":\"关于\",\"items\":[{\"text\":\"关于知识库\",\"link\":\"/about/index\",\"activeMatch\":\"/about/index\"},{\"text\":\"关于我\",\"link\":\"/about/me\",\"activeMatch\":\"/about/me\"}],\"activeMatch\":\"/about/\"}],\"sidebar\":{\"/categories/issues/\":[],\"/categories/fragments/\":[{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/rabbit.svg\\\" title=\\\"兔年\\\" alt=\\\"生肖\\\">\\n            2023年 (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>5 种快速查找容器文件系统中文件的方法\",\"link\":\"/categories/fragments/2023/01-find-docker-file\"}],\"collapsed\":false}],\"/categories/tools/\":[],\"/blogs/original/\":[{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/rabbit.svg\\\" title=\\\"兔年\\\" alt=\\\"生肖\\\">\\n            2023年 (10篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>使用 Containerlab + Kind 快速部署 Cilium BGP 环境\",\"link\":\"/blogs/original//2023/10-cilium-bgp\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>使用 ClusterResourceSet 为 Cluster API 集群自动安装 CNI 插件\",\"link\":\"/blogs/original//2023/09-clusterresourceset\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Cilium 多集群 Cluster Mesh 介绍\",\"link\":\"/blogs/original//2023/08-cilium-cluster-mesh\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>vCluster -- 基于虚拟集群的多租户方案\",\"link\":\"/blogs/original//2023/07-vcluster\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Kubernetes 多集群网络方案系列 2 -- Submariner 监控\",\"link\":\"/blogs/original//2023/06-kubernetes-multi-cluster-2\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Kubernetes 多集群网络方案系列 1 -- Submariner 介绍\",\"link\":\"/blogs/original//2023/05-kubernetes-multi-cluster-1\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>在 Kubernetes 中使用 Keycloak OIDC Provider 对用户进行身份验证\",\"link\":\"/blogs/original//2023/04-kubernetes-keycloak-oidc\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>使用 Kubectl Patch 命令更新资源\",\"link\":\"/blogs/original//2023/03-kubectl-patch\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>WebAssembly 在云原生中的实践指南\",\"link\":\"/blogs/original//2023/02-wasm-in-cloud-native\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>ArgoCD 简明教程\",\"link\":\"/blogs/original//2023/01-argocd-quickstart\"}],\"collapsed\":false},{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/tiger.svg\\\" title=\\\"虎年\\\" alt=\\\"生肖\\\">\\n            2022年 (13篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>使用 Envoy 作为前端代理\",\"link\":\"/blogs/original//2022/13-envoy-quickstart\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>实现 LRU 缓存算法\",\"link\":\"/blogs/original//2022/12.lru\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Nebula 分布式图数据库介绍\",\"link\":\"/blogs/original//2022/11.nebula\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Habor 部署指南\",\"link\":\"/blogs/original//2022/10-harbor\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Pulsar 介绍与部署\",\"link\":\"/blogs/original//2022/09-pulsar\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>如何重置 Kafka 中的 Consumer Offset？\",\"link\":\"/blogs/original//2022/08-reset-kafka-consumer-offset\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>如何往 Kafka 发送大消息？\",\"link\":\"/blogs/original//2022/07-kafka-big-message\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>Kafka 生产环境部署指南\",\"link\":\"/blogs/original//2022/06-kafka-setup\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>Docker Rootless 在非特权模式下运行 Docker\",\"link\":\"/blogs/original//2022/05-docker-rootless\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>使用 ezctl 工具部署和管理 Kubernetes 集群\",\"link\":\"/blogs/original//2022/04-kubeasz\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">11</div>Kubernetes 中的对象是如何删除的：Finalizers 字段介绍\",\"link\":\"/blogs/original//2022/03-finalizer\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">12</div>Kubectl debug 调试容器\",\"link\":\"/blogs/original//2022/02-kubectl-debug\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">13</div>Kubenetes 高可用集群搭建\",\"link\":\"/blogs/original//2022/01-kubernetes-setup\"}],\"collapsed\":false}],\"/blogs/translate/\":[{\"text\":\"<img class=\\\"chinese-zodiac\\\" style=\\\"position: static; vertical-align: middle; padding-bottom: 3px;\\\" src=\\\"/img/svg/chinese-zodiac/rabbit.svg\\\" title=\\\"兔年\\\" alt=\\\"生肖\\\">\\n            2023年 (7篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Git 速查表：专家必备的 14 个 Git 命令\",\"link\":\"/blogs/translate//2023/07-git-cheat-sheet-3\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>Git 速查表：中级用户必备的 12 个 Git 命令\",\"link\":\"/blogs/translate//2023/06-git-cheat-sheet-2\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Git 速查表：初学者必备的 12 个 Git 命令\",\"link\":\"/blogs/translate//2023/05-git-cheat-sheet-1\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>Kubernetes 中数据包的生命周期 -- 第 4 部分\",\"link\":\"/blogs/translate//2023/04-life-of-a-packet-in-kubernetes-part-4\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Kubernetes 中数据包的生命周期 -- 第 3 部分\",\"link\":\"/blogs/translate//2023/03-life-of-a-packet-in-kubernetes-part-3\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Kubernetes 中数据包的生命周期 -- 第 2 部分\",\"link\":\"/blogs/translate//2023/02-life-of-a-packet-in-kubernetes-part-2\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>Kubernetes 中数据包的生命周期 -- 第 1 部分\",\"link\":\"/blogs/translate//2023/01-life-of-a-packet-in-kubernetes-part-1\"}],\"collapsed\":false}],\"/courses/elastic-stack/\":[{\"text\":\"elastic-stack-hands-on-lab (5篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>Elastic Stack 8 快速上手\",\"link\":\"/courses/elastic-stack/01-elastic-stack-hands-on-lab/01-quick-start\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>ILM 索引生命周期管理\",\"link\":\"/courses/elastic-stack/01-elastic-stack-hands-on-lab/02-ilm\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>快照备份与恢复\",\"link\":\"/courses/elastic-stack/01-elastic-stack-hands-on-lab/03-snapshot\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>使用 Fleet 管理 Elastic Agent 监控应用\",\"link\":\"/courses/elastic-stack/01-elastic-stack-hands-on-lab/04-fleet\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Elasticsearch Java API Client 开发\",\"link\":\"/courses/elastic-stack/01-elastic-stack-hands-on-lab/05-java-client\"}],\"collapsed\":false}]},\"logo\":\"/logo.png\",\"outline\":{\"level\":\"deep\",\"label\":\"目录\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"editLink\":{\"pattern\":\"https://github.com/cr7258/cr7258.github.io/edit/main/docs/:path\",\"text\":\"不妥之处，敬请雅正\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"root\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/cr7258/cr7258.github.io\"}],\"articleMetadataConfig\":{\"author\":\"Se7en\",\"authorLink\":\"/about/me\",\"showViewCount\":false},\"copyrightConfig\":{\"license\":\"署名-相同方式共享 4.0 国际 (CC BY-SA 4.0)\",\"licenseLink\":\"http://creativecommons.org/licenses/by-sa/4.0/\"},\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":true},\"footerConfig\":{\"showFooter\":true,\"copyright\":\"Copyright © 2023-2024 Se7en\"}},\"locales\":{\"root\":{\"label\":\"中文\",\"lang\":\"zh\"},\"en\":{\"label\":\"English\",\"lang\":\"en\"}},\"scrollOffset\":90,\"cleanUrls\":true}");</script>
    
  </body>
</html>